<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1" />
  <title>TVC Auto AI Pro</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    /* ========== THEME ========== */
    :root{
      --bg-primary:#0a0a0a; --bg-secondary:#141418; --bg-tertiary:#1e1e24; --bg-quaternary:#28282f; --bg-hover:#32323a;
      --accent-primary:#8b6914; --accent-secondary:#6b5210; --accent-tertiary:#a57c1e; --accent-bright:#b8901f; --accent-glow:rgba(139,105,20,.3);
      --text-primary:#f5f5f7; --text-secondary:#a1a1aa; --text-muted:#71717a;
      --border:#2a2a2e; --glass:#ffffff14;
      --success:#10b981; --warning:#f59e0b; --error:#ef4444; --info:#3b82f6;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#0a0a0a,#141418);
      color:var(--text-primary); font-size:13px; line-height:1.5; overflow-x:hidden;
    }
    body::before{content:'';position:fixed;inset:0;pointer-events:none;
      background-image:
      radial-gradient(600px 600px at 8% 35%,rgba(139,105,20,.25),transparent),
      radial-gradient(600px 600px at 90% 80%,rgba(16,185,129,.12),transparent);
    }

    /* ===== LAYOUT ===== */
    .terminal{display:grid;grid-template-columns:260px 1fr;grid-template-rows:60px 1fr;height:100vh;gap:1px;background:var(--border)}
    .topbar{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:#141418cc;border-bottom:1px solid var(--glass);backdrop-filter:blur(18px)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary));font-weight:800;box-shadow:0 0 18px var(--accent-glow)}
    .brand-title{font-weight:800;font-size:16px;background:linear-gradient(135deg,#fff,var(--accent-bright));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .menu-btn{display:none;border:1px solid var(--glass);background:transparent;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .top-actions{display:flex;gap:8px;align-items:center}
    .pill{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--glass);font-size:11px;background:#0f1115}
    .pill .dot{width:6px;height:6px;border-radius:50%;background:var(--success);box-shadow:0 0 10px var(--success)}

    .sidebar{background:var(--bg-secondary);padding:16px 10px;border-right:1px solid var(--border);overflow:auto}
    .nav-section{margin-bottom:18px}
    .nav-title{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;margin:4px 10px 8px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin:4px 6px;border-radius:10px;color:var(--text-secondary);cursor:pointer;transition:.2s}
    .nav-item:hover{background:var(--bg-tertiary);color:#fff;transform:translateX(2px)}
    .nav-item.active{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:#fff}
    .badge{margin-left:auto;background:var(--error);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:12px;min-width:18px;text-align:center}

    .content{background:var(--bg-primary);display:flex;flex-direction:column;overflow:hidden}
    .content-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:#101214a6;backdrop-filter:blur(8px)}
    .content-title{font-weight:800}
    .btn{padding:9px 14px;border:none;border-radius:8px;background:var(--bg-quaternary);color:var(--text-secondary);border:1px solid var(--glass);cursor:pointer;transition:.2s;font-weight:600}
    .btn:hover{background:var(--bg-hover);color:#fff}
    .btn-primary{background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary));color:#fff;border:none}
    .btn-sm{padding:6px 10px;font-size:11px}

    .content-body{flex:1;overflow:auto;padding:14px}
    .page{display:none;animation:fade .25s ease}
    .page.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    .card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;margin-bottom:14px}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--bg-tertiary);border-bottom:1px solid var(--border)}
    .table{width:100%;border-collapse:collapse}
    .table th{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;background:var(--bg-quaternary);padding:10px;border-bottom:1px solid var(--border)}
    .table td{padding:12px;border-bottom:1px solid var(--border)}
    .status{padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase;display:inline-block}
    .status-new,.status-follow{background:rgba(245,158,11,.15);color:var(--warning);border:1px solid rgba(245,158,11,.4)}
    .status-hot{background:rgba(239,68,68,.15);color:var(--error);border:1px solid rgba(239,68,68,.4)}
    .status-qualified{background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.4)}

    .lead{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;display:inline-block}
    .score-high{background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.4)}
    .score-medium{background:rgba(245,158,11,.15);color:var(--warning);border:1px solid rgba(245,158,11,.4)}
    .score-low{background:rgba(239,68,68,.15);color:var(--error);border:1px solid rgba(239,68,68,.4)}

    .form{padding:14px}
    .group{margin-bottom:12px}
    .label{display:block;font-size:11px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;font-weight:700}
    .input,.select,.textarea{width:100%;padding:10px 12px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;color:#fff}

    /* ===== MOBILE ===== */
    @media (max-width: 900px){
      .terminal{grid-template-columns:1fr}
      .sidebar{position:fixed;z-index:40;top:60px;bottom:0;left:0;right:0;max-width:320px;transform:translateX(-100%);transition:.25s}
      .sidebar.open{transform:translateX(0)}
      .menu-btn{display:inline-flex}
    }
  </style>
</head>

<body>
  <div class="terminal">
    <!-- ===== TOP BAR ===== -->
    <div class="topbar">
      <div class="brand">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
        <div class="logo">‚ö°</div>
        <div class="brand-title">TVC Auto AI Pro</div>
      </div>
      <div class="top-actions">
        <div class="pill"><span class="dot"></span> LIVE DATA</div>
        <button class="btn" id="voiceBtn" onclick="toggleVoice()">üé§ Voice</button>
        <button class="btn btn-primary" onclick="showPage('chat', findNav('chat'))">ü§ñ AI Terminal</button>
      </div>
    </div>

    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar" id="sidebar">
      <div class="nav-section">
        <div class="nav-title">Overview</div>
        <div class="nav-item active" onclick="showPage('dashboard', this)"><span>üìä</span>Dashboard</div>
        <div class="nav-item" onclick="showPage('analytics', this)"><span>üìà</span>Analytics</div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Operations</div>
        <div class="nav-item" onclick="showPage('customers', this)"><span>üë•</span>Customers <span class="badge" id="customerBadge">0</span></div>
        <div class="nav-item" onclick="showPage('inventory', this)"><span>üöó</span>Inventory <span class="badge" id="inventoryBadge" style="background:var(--success)">0</span></div>
        <div class="nav-item" onclick="showPage('service', this)"><span>üîß</span>Service Center <span class="badge" id="serviceBadge" style="background:var(--warning)">0</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Comms</div>
        <div class="nav-item" onclick="showPage('calls', this)"><span>üìû</span>Call Center <span class="badge" id="callBadge" style="background:var(--accent-primary)">0</span></div>
        <div class="nav-item" onclick="showPage('emails', this)"><span>üìß</span>Email Center <span class="badge" id="emailBadge" style="background:var(--success)">0</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Intelligence</div>
        <div class="nav-item" onclick="showPage('vin', this)"><span>üîç</span>VIN Scanner</div>
        <div class="nav-item" onclick="showPage('chat', this)"><span>ü§ñ</span>AI Terminal</div>
      </div>
    </div>

    <!-- ===== CONTENT ===== -->
    <div class="content">
      <div class="content-header">
        <div class="content-title" id="title">Executive Dashboard</div>
        <div>
          <button class="btn" onclick="exportData()">üìä Export</button>
          <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
        </div>
      </div>

      <div class="content-body">

        <!-- DASHBOARD -->
        <div id="dashboard" class="page active">
          <div class="card">
            <div class="card-head"><div>Live Activity</div></div>
            <div id="activity" style="max-height:340px;overflow:auto;padding:8px 6px">
              <div style="padding:12px;color:var(--text-muted)">System ready.</div>
            </div>
          </div>
        </div>

        <!-- CUSTOMERS -->
        <div id="customers" class="page">
          <div class="card">
            <div class="card-head">
              <div>Customer Pipeline</div>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="customerSearch" class="input" placeholder="Search name, email, or phone‚Ä¶" style="width:260px" oninput="filterCustomers()"/>
                <button class="btn btn-sm" onclick="customerSearch.value='';filterCustomers()">Clear</button>
                <button class="btn btn-primary" onclick="openCustomerForm()">+ Add Customer</button>
              </div>
            </div>
            <table class="table">
              <thead><tr>
                <th>Customer</th><th>Contact</th><th>Status</th><th>Lead</th><th>Potential</th><th>Interest</th><th>Last Contact</th><th>Actions</th>
              </tr></thead>
              <tbody id="customerRows"><tr><td colspan="8" style="padding:16px;color:var(--text-muted)">Loading‚Ä¶</td></tr></tbody>
            </table>
          </div>

          <div id="customerForm" class="card" style="display:none">
            <div class="card-head"><div>Add New Customer</div></div>
            <div class="form">
              <div class="group"><label class="label">Name</label><input id="c_name" class="input" placeholder="John Smith"></div>
              <div class="group"><label class="label">Address</label><input id="c_address" class="input" placeholder="123 Main St"></div>
              <div class="group"><label class="label">Email</label><input id="c_email" class="input" placeholder="john@example.com"></div>
              <div class="group"><label class="label">Phone</label><input id="c_phone" class="input" placeholder="555-123-4567"></div>
              <div class="group"><label class="label">Vehicle of Interest</label><input id="c_interest" class="input" placeholder="2024 BMW X5"></div>
              <div class="group"><label class="label">Current Vehicle</label><input id="c_current" class="input" placeholder="2018 Honda Accord"></div>
              <div class="group"><label class="label">Budget</label><input id="c_budget" class="input" placeholder="$50,000‚Äì$70,000"></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
                <button class="btn" onclick="closeCustomerForm()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- INVENTORY -->
        <div id="inventory" class="page">
          <div class="card">
            <div class="card-head">
              <div>Vehicle Inventory</div>
              <div style="display:flex;gap:8px">
                <input id="invFilter" class="input" placeholder="Filter‚Ä¶" style="width:220px" oninput="filterInventory()">
                <button class="btn btn-primary" onclick="openVehicleForm()">+ Add Vehicle</button>
              </div>
            </div>
            <table class="table">
              <thead><tr><th>Vehicle</th><th>VIN</th><th>Status</th><th>Price</th><th>Days</th><th>Service</th><th>Actions</th></tr></thead>
              <tbody id="invRows"></tbody>
            </table>
          </div>

          <div id="vehicleForm" class="card" style="display:none">
            <div class="card-head"><div>Add New Vehicle</div></div>
            <div class="form">
              <div class="group"><label class="label">VIN</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="v_vin" class="input" placeholder="17-char VIN" maxlength="17" style="flex:1">
                  <button class="btn btn-primary" onclick="decodeVIN()">Decode</button>
                </div>
              </div>
              <div class="group"><label class="label">Make</label><input id="v_make" class="input" placeholder="Toyota"></div>
              <div class="group"><label class="label">Model</label><input id="v_model" class="input" placeholder="Camry"></div>
              <div class="group"><label class="label">Year</label><input id="v_year" type="number" class="input" placeholder="2024"></div>
              <div class="group"><label class="label">Price</label><input id="v_price" type="number" class="input" placeholder="32000"></div>
              <div class="group"><label class="label">Status</label>
                <select id="v_status" class="select"><option value="available">Available</option><option value="reserved">Reserved</option><option value="sold">Sold</option><option value="incoming">Incoming</option></select>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="addVehicle()">Add Vehicle</button>
                <button class="btn" onclick="closeVehicleForm()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- SERVICE -->
        <div id="service" class="page">
          <div class="card">
            <div class="card-head">
              <div>Service Orders</div>
              <button class="btn btn-primary" onclick="openServiceForm()">+ New Service Order</button>
            </div>
            <table class="table">
              <thead><tr><th>Order #</th><th>Vehicle</th><th>Customer</th><th>Service</th><th>Tech</th><th>Status</th><th>Est. Cost</th><th>Actions</th></tr></thead>
              <tbody id="svcRows"></tbody>
            </table>
          </div>

          <div id="serviceForm" class="card" style="display:none">
            <div class="card-head"><div>Create Service Order</div></div>
            <div class="form">
              <div class="group"><label class="label">Vehicle</label>
                <select id="svc_vehicle" class="select"><option value="">Select‚Ä¶</option></select>
              </div>
              <div class="group"><label class="label">Service Type</label>
                <select id="svc_type" class="select">
                  <option value="reconditioning">Reconditioning</option><option value="oil-change">Oil Change</option><option value="inspection">Inspection</option>
                  <option value="brake-service">Brake Service</option><option value="tire-rotation">Tire Rotation</option><option value="major-repair">Major Repair</option>
                </select>
              </div>
              <div class="group"><label class="label">Priority</label>
                <select id="svc_priority" class="select"><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select>
              </div>
              <div class="group"><label class="label">Notes</label><textarea id="svc_notes" class="textarea" rows="4" placeholder="Service notes‚Ä¶"></textarea></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="submitServiceOrder()">Create</button>
                <button class="btn" onclick="closeServiceForm()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- CALLS (demo) -->
        <div id="calls" class="page">
          <div class="card">
            <div class="card-head">
              <div>Call History</div>
              <button class="btn btn-primary" onclick="simulateNewCall()">üìû Simulate Call</button>
            </div>
            <table class="table"><thead><tr><th>Date</th><th>Phone</th><th>Customer</th><th>Duration</th><th>Lead</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="callRows"></tbody></table>
          </div>
        </div>

        <!-- EMAILS (demo) -->
        <div id="emails" class="page">
          <div class="card">
            <div class="card-head"><div>Email Campaigns</div><button class="btn btn-primary" onclick="createEmailCampaign()">‚úâÔ∏è New</button></div>
            <table class="table"><thead><tr><th>Date</th><th>Recipient</th><th>Subject</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="emailRows"></tbody></table>
          </div>
        </div>

        <!-- VIN -->
        <div id="vin" class="page">
          <div class="card">
            <div class="card-head"><div>VIN Intelligence Scanner</div></div>
            <div class="form">
              <div class="group"><label class="label">VIN</label><input id="vinInput" class="input" placeholder="Enter 17-character VIN" maxlength="17"></div>
              <button class="btn btn-primary" onclick="scanVIN()" style="width:100%">üîç Decode</button>
              <div id="vinResult" style="display:none;margin-top:14px"><div id="vinData" class="form"></div></div>
            </div>
          </div>
        </div>

        <!-- AI TERMINAL -->
        <div id="chat" class="page">
          <div class="card" style="margin-bottom:10px">
            <div class="card-head"><div>AI Configuration</div></div>
            <div class="form" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div><label class="label">AI API Key</label><input id="aiApiKey" type="password" class="input" placeholder="sk-‚Ä¶ (OpenAI key)" onchange="updateAIStatus()"></div>
              <div><label class="label">OpenPhone API Key</label><input id="openphoneApiKey" type="password" class="input" placeholder="(optional)" onchange="updateOpenPhoneStatus()"></div>
            </div>
            <div class="form" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button class="btn btn-primary" onclick="testAIConnection()">üîó Test AI</button>
              <button class="btn" onclick="saveAIConfig()">üíæ Save</button>
              <div class="pill"><span id="aiDot" class="dot" style="background:var(--error)"></span><span id="aiText">AI Status: API Key Required</span></div>
            </div>
          </div>

          <div class="card">
            <div class="card-head"><div>AI Terminal Interface</div><div style="font-size:11px;color:var(--text-muted)">Try: ‚Äúshow customers‚Äù, ‚Äúsearch customers for dennis‚Äù, ‚Äúopen inventory‚Äù.</div></div>
            <div id="chatBox" style="height:420px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,rgba(255,255,255,.03),transparent)">
              <div class="assistant" style="align-self:flex-start;background:var(--bg-quaternary);border:1px solid var(--border);padding:12px;border-radius:12px">ü§ñ <b>TVC AI</b> is online.</div>
            </div>
            <div class="form" style="display:flex;gap:8px;background:var(--bg-tertiary);border-top:1px solid var(--border)">
              <input id="chatInput" class="input" placeholder="Ask for insights‚Ä¶" onkeypress="if(event.key==='Enter') sendMessage()">
              <button class="btn btn-primary" onclick="sendMessage()">Execute</button>
            </div>
          </div>
        </div>

        <!-- ANALYTICS (demo) -->
        <div id="analytics" class="page">
          <div class="card"><div class="card-head"><div>Analytics</div></div>
            <div class="form">Coming soon.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ========== APP SCRIPT ========== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ---------- STATE ---------- */
    const SUPABASE_URL = "https://zpgdsgutiheilshgrnwl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2RzZ3V0aWhlaWxzaGdybndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjA3NDMsImV4cCI6MjA3MDU5Njc0M30.LC-ro-E2k_Xb7UK337QP8V2HddpftjV5g1ZsI6D0c8k";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.db = db;

    let isListening=false, recognition=null, aiApiKey=null, openphoneApiKey=null;
    let customers=[], inventory=[], serviceOrders=[];
    let callHistory=[{id:1,dateTime:new Date(),phoneNumber:'555-0123',customer:'John Smith',duration:'12:45',leadScore:9,status:'transcribed'}];
    let emailHistory=[{id:1,date:new Date(),recipient:'john@email.com',subject:'Your BMW X5 Inquiry',type:'follow-up',status:'delivered'}];
    const $ = (id)=>document.getElementById(id);

    /* ---------- NAV ---------- */
    function findNav(id){ return document.querySelector(`.nav-item[onclick*="${id}"]`); }
    function showPage(id, el){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      if(el) el.classList.add('active');
      $('title').textContent = ({
        dashboard:'Executive Dashboard', customers:'Customer Pipeline', inventory:'Inventory', service:'Service Center',
        calls:'Call Center', emails:'Email Center', vin:'VIN Intelligence', chat:'AI Terminal', analytics:'Analytics'
      })[id] || 'Dashboard';
      if(window.innerWidth<=900) toggleSidebar(false);
      if(id==='service') populateVehicleDropdowns();
    }
    function toggleSidebar(force){ const s=$('sidebar'); s.classList[force===false?'remove':'toggle']('open'); }

    /* ---------- UTIL ---------- */
    function addActivity(icon,text,time='Just now'){ const box=$('activity'); const div=document.createElement('div'); div.style.padding='10px 12px'; div.innerHTML=`${icon} ${text} <span style="float:right;color:#999">${time}</span>`; box.prepend(div); while(box.children.length>18) box.removeChild(box.lastChild); }
    function currency(n){ return '$'+Number(n||0).toLocaleString(); }
    function leadClass(n){ if(n>=8) return 'score-high'; if(n>=6) return 'score-medium'; return 'score-low'; }

    /* ---------- CUSTOMERS UI ---------- */
    function renderCustomers(){
      const tbody=$('customerRows'); tbody.innerHTML='';
      if(customers.length===0){ tbody.innerHTML='<tr><td colspan="8" style="padding:16px;color:#999">No customers yet.</td></tr>'; return; }
      customers.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${c.firstName||''} ${c.lastName||''}</td>
          <td>${c.email||''}<br><span style="font-size:11px">${c.phone||''}</span></td>
          <td><span class="status status-${c.status||'new'}">${c.status||'new'}</span></td>
          <td><span class="lead ${leadClass(c.leadScore||7)}">${c.leadScore||7}</span></td>
          <td>${currency(c.value||0)}</td>
          <td>${c.vehicleInterest||''}<br><span style="font-size:11px">${c.budget||''}</span></td>
          <td>${c.lastContact||'‚Äî'}</td>
          <td><button class="btn btn-sm" onclick="viewCustomer('${c.id}')">View</button> <button class="btn btn-sm" onclick="removeCustomer('${c.id}')">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
      $('customerBadge').textContent=String(customers.length);
    }
    function filterCustomers(){
      const q=($('customerSearch').value||'').toLowerCase().trim();
      document.querySelectorAll('#customerRows tr').forEach(r=>{
        r.style.display = q ? (r.textContent.toLowerCase().includes(q)?'':'none') : '';
      });
    }
    function openCustomerForm(){ $('customerForm').style.display='block'; }
    function closeCustomerForm(){ $('customerForm').style.display='none'; }
    function viewCustomer(id){
      const c=customers.find(x=>String(x.id)===String(id)); if(!c){ alert('Customer not found'); return; }
      alert(`Customer\n\n${c.firstName||''} ${c.lastName||''}\nEmail: ${c.email||''}\nPhone: ${c.phone||''}\nInterest: ${c.vehicleInterest||''}\nBudget: ${c.budget||''}`);
    }

    /* ---------- INVENTORY UI ---------- */
    function renderInventory(){
      const tbody=$('invRows'); tbody.innerHTML='';
      inventory.forEach(v=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${v.vehicle}</td><td style="font-family:monospace;font-size:11px">${v.vin||'PENDING'}</td>
          <td><span class="status status-${v.status}">${v.status}</span></td>
          <td>${currency(v.price)}</td><td>${v.daysInStock||0}</td>
          <td><span class="status status-${v.serviceStatus==='ready'?'qualified':v.serviceStatus}">${v.serviceStatus}</span></td>
          <td><button class="btn btn-sm" onclick="viewVehicle(${JSON.stringify(v.id)})">View</button> <button class="btn btn-sm" onclick="deleteVehicle(${JSON.stringify(v.id)})">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      $('inventoryBadge').textContent=String(inventory.filter(v=>v.status==='available').length);
    }
    function filterInventory(){
      const q=($('invFilter').value||'').toLowerCase();
      document.querySelectorAll('#invRows tr').forEach(r=>{ r.style.display = r.textContent.toLowerCase().includes(q)?'':''; });
    }
    function openVehicleForm(){ $('vehicleForm').style.display='block'; }
    function closeVehicleForm(){ $('vehicleForm').style.display='none'; }
    function viewVehicle(id){ const v=inventory.find(x=>String(x.id)===String(id)); if(v) alert(`${v.vehicle}\nVIN: ${v.vin}\nPrice: ${currency(v.price)}\nStatus: ${v.status}\nService: ${v.serviceStatus}`); }

    /* ---------- SERVICE UI ---------- */
    function renderService(){
      const tbody=$('svcRows'); tbody.innerHTML='';
      serviceOrders.forEach(o=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${o.id}</td><td>${o.vehicle}</td><td>${o.customer}</td><td>${o.serviceType}</td>
          <td>${o.technician}</td><td><span class="status status-${o.status}">${o.status}</span></td>
          <td>${currency(o.cost)}</td>
          <td><button class="btn btn-sm" onclick="viewService('${o.id}')">View</button></td>`;
        tbody.appendChild(tr);
      });
      $('serviceBadge').textContent=String(serviceOrders.length);
    }
    function openServiceForm(){ $('serviceForm').style.display='block'; populateVehicleDropdowns(); }
    function closeServiceForm(){ $('serviceForm').style.display='none'; }
    function populateVehicleDropdowns(){
      const sel=$('svc_vehicle'); if(!sel) return;
      sel.innerHTML = '<option value="">Select‚Ä¶</option>' + inventory.map(v=>`<option value="${v.id}">${v.vehicle}</option>`).join('');
    }
    function viewService(id){ const o=serviceOrders.find(x=>String(x.id)===String(id)); if(o) alert(`Service ${o.id}\n\n${o.vehicle}\n${o.serviceType}\nStatus: ${o.status}\nCost: ${currency(o.cost)}`); }

    /* ---------- CALLS/EMAILS (demo render) ---------- */
    function renderCalls(){
      const tbody=$('callRows'); tbody.innerHTML='';
      callHistory.forEach(c=>{
        const tr=document.createElement('tr'); tr.innerHTML=`
          <td>${c.dateTime.toLocaleDateString()} ${c.dateTime.toLocaleTimeString()}</td>
          <td>${c.phoneNumber}</td><td>${c.customer}</td><td>${c.duration}</td>
          <td><span class="lead ${leadClass(c.leadScore)}">${c.leadScore}</span></td>
          <td><span class="status status-${c.status}">${c.status}</span></td>
          <td><button class="btn btn-sm" onclick="alert('Transcript‚Ä¶')">Transcript</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function simulateNewCall(){ callHistory.unshift({id:Date.now(),dateTime:new Date(),phoneNumber:'555-'+Math.floor(Math.random()*9000+1000),customer:'New Customer',duration:'5:'+String(Math.floor(Math.random()*60)).padStart(2,'0'),leadScore:8,status:'transcribed'}); renderCalls(); addActivity('üìû','New call received'); }
    function renderEmails(){ const tbody=$('emailRows'); tbody.innerHTML=''; emailHistory.forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.date.toLocaleString()}</td><td>${e.recipient}</td><td>${e.subject}</td><td><span class="status status-${e.type}">${e.type}</span></td><td><span class="status status-${e.status}">${e.status}</span></td><td><button class="btn btn-sm" onclick="alert('Email view‚Ä¶')">View</button></td>`; tbody.appendChild(tr); }); }
    function createEmailCampaign(){ const subject=prompt('Subject?'); if(subject){ emailHistory.unshift({id:Date.now(),date:new Date(),recipient:'all@customers.com',subject,type:'campaign',status:'sent'}); renderEmails(); addActivity('üìß','Email campaign sent'); } }

    /* ---------- VIN ---------- */
    async function decodeVIN(){
      const vin=$('v_vin').value.trim(); if(vin.length!==17){ alert('Enter a 17‚Äëchar VIN'); return; }
      try{ const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const get=v=>d.Results.find(x=>x.Variable===v)?.Value||''; $('v_make').value=get('Make'); $('v_model').value=get('Model'); $('v_year').value=get('Model Year'); alert('VIN decoded!'); }catch{ alert('VIN decode error'); }
    }
    async function scanVIN(){
      const vin=$('vinInput').value.trim(); if(vin.length!==17){ alert('Enter 17‚Äëchar VIN'); return; }
      const wrap=$('vinResult'), box=$('vinData'); wrap.style.display='block'; box.innerHTML='Decoding‚Ä¶';
      try{ const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const g=v=>d.Results.find(x=>x.Variable===v)?.Value||'‚Äî'; box.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px"><div><div class="label">Make</div>${g('Make')}</div><div><div class="label">Model</div>${g('Model')}</div><div><div class="label">Year</div>${g('Model Year')}</div><div><div class="label">Body</div>${g('Body Class')}</div><div><div class="label">Engine</div>${g('Engine Model')}</div></div>`; addActivity('üîç','VIN decoded'); }catch{ box.innerHTML='<span style="color:#f66">VIN decode failed</span>'; }
    }

    /* ---------- EXPORT/REFRESH ---------- */
    function exportData(){ alert(`Export\n\nCustomers: ${customers.length}\nVehicles: ${inventory.length}\nService Orders: ${serviceOrders.length}`); }
    async function refreshData(){
      await Promise.all([ loadCustomersFromDB(), loadInventoryFromDB(), loadServiceFromDB() ]);
      renderCustomers(); renderInventory(); renderService(); renderCalls(); renderEmails();
      addActivity('üîÑ','Data refreshed'); alert('Refreshed!');
    }

    /* ---------- SUPABASE: MAP HELPERS ---------- */
    function mapRowToCustomer(row){
      const name=(row["Name"]??row.name??"").toString().trim();
      const [first,...rest]=name.split(/\s+/); const last=rest.join(' ');
      const b=String(row["Budget"]??row.budget??''); const val=parseInt(b.replace(/[^0-9]/g,''))||0;
      return {
        id: row.id ?? row.ID ?? row.uuid ?? row["ID"] ?? Date.now(),
        firstName:first||'', lastName:last||'',
        email:row["Email"]??row.email??'', phone:row["Phone"]??row.phone??'',
        vehicleInterest:row["Vehicle of interest"]??row.vehicle_interest??'',
        budget:row["Budget"]??row.budget??'', address:row["Address"]??row.address??'',
        currentVehicle:row["Current Vehicle/Trade in"]??row.current_vehicle??'',
        status:'new', leadScore:8, value:val, lastContact:'‚Äî'
      };
    }
    function mapRowToVehicle(row){
      return {
        id: row.id, vin: row.vin||'PENDING', make:row.make||'', model:row.model||'', year:row.year,
        vehicle: `${row.year||''} ${row.make||''} ${row.model||''}`.trim(),
        status: row.status||'available', price:Number(row.price)||0, daysInStock:row.days_in_stock??0,
        serviceStatus: row.service_status||'pending'
      };
    }
    function mapRowToService(row){
      return {
        id: row.order_no || row.id, vehicle: row.vehicle||'Unknown', customer: row.customer||'Walk-in',
        serviceType: row.service_type||'inspection', technician: row.technician||'Unassigned',
        status: row.status||'pending', cost:Number(row.cost)||0, date: row.created_at?new Date(row.created_at):new Date()
      };
    }

    /* ---------- SUPABASE: LOAD ---------- */
    async function loadCustomersFromDB(){
      try{
        let { data, error } = await db.from('customers').select('*').order('created_at',{ascending:false});
        if(error){ ({data,error} = await db.from('customers').select('*')); }
        if(error) throw error;
        customers.length=0; (data||[]).forEach(r=>customers.push(mapRowToCustomer(r)));
      }catch(e){ console.warn('customers load:', e.message||e); }
    }
    async function loadInventoryFromDB(){
      try{
        const { data, error } = await db.from('vehicles').select('*').order('created_at',{ascending:false});
        if(error) throw error;
        inventory.length=0; (data||[]).forEach(r=>inventory.push(mapRowToVehicle(r)));
      }catch(e){ console.warn('vehicles load:', e.message||e); }
    }
    async function loadServiceFromDB(){
      try{
        const { data, error } = await db.from('service_orders').select('*').order('created_at',{ascending:false});
        if(error) throw error;
        serviceOrders.length=0; (data||[]).forEach(r=>serviceOrders.push(mapRowToService(r)));
      }catch(e){ console.warn('service load:', e.message||e); }
    }

    /* ---------- SUPABASE: CREATE/DELETE ---------- */
    async function addCustomer(){
      const name=$('c_name').value.trim(); if(!name){ alert('Enter a name'); return; }
      const row={
        ["Name"]:name, ["Address"]:$('c_address').value.trim(), ["Email"]:$('c_email').value.trim(),
        ["Phone"]:$('c_phone').value.trim(), ["Vehicle of interest"]:$('c_interest').value.trim(),
        ["Current Vehicle/Trade in"]:$('c_current').value.trim(), ["Budget"]:$('c_budget').value.trim()
      };
      try{
        const { error } = await db.from('customers').insert([row]);
        if(error) throw error;
        await loadCustomersFromDB(); renderCustomers();
        ['c_name','c_address','c_email','c_phone','c_interest','c_current','c_budget'].forEach(id=>$(id).value='');
        closeCustomerForm(); addActivity('üë§',`New customer: ${name}`);
      }catch(e){
        alert('Could not save customer: '+(e.message||e));
      }
    }
    async function removeCustomer(id){
      if(!confirm('Delete this customer?')) return;
      try{
        let { error } = await db.from('customers').delete().eq('id', id);
        if(error && /column "id"/i.test(error.message)) ({ error } = await db.from('customers').delete().eq('ID', id));
      }catch(_){}
      customers = customers.filter(c=>String(c.id)!==String(id)); renderCustomers();
    }

    async function addVehicle(){
      const vin=$('v_vin').value.trim(), make=$('v_make').value.trim(), model=$('v_model').value.trim(),
            year=Number($('v_year').value), price=Number($('v_price').value), status=$('v_status').value;
      if(!(make&&model&&year&&price)){ alert('Fill make, model, year, price'); return; }
      try{
        const { error } = await db.from('vehicles').insert([{ vin, make, model, year, price, status, service_status:'pending', days_in_stock:0 }]);
        if(error) throw error;
        await loadInventoryFromDB(); renderInventory(); populateVehicleDropdowns(); closeVehicleForm();
        addActivity('üöó',`New vehicle: ${year} ${make} ${model}`);
        ['v_vin','v_make','v_model','v_year','v_price'].forEach(id=>$(id).value='');
      }catch(e){ alert('Could not save vehicle: '+(e.message||e)); }
    }
    async function deleteVehicle(id){
      if(!confirm('Delete this vehicle?')) return;
      try{ await db.from('vehicles').delete().eq('id', id); }catch(_){}
      inventory = inventory.filter(v=>String(v.id)!==String(id)); renderInventory(); populateVehicleDropdowns();
    }

    async function submitServiceOrder(){
      const vehicleId=$('svc_vehicle').value, type=$('svc_type').value, priority=$('svc_priority').value, notes=$('svc_notes').value.trim();
      if(!vehicleId){ alert('Pick a vehicle'); return; }
      const v=inventory.find(x=>String(x.id)===String(vehicleId));
      const status = priority==='urgent' ? 'in-progress' : 'pending';
      const payload = { order_no:`SO-${Date.now()}`, vehicle:v?.vehicle||'Unknown', vehicle_id:v?.id||null, customer:'Walk-in', service_type:type, technician:'Unassigned', status, cost:Math.floor(Math.random()*500)+100, notes, priority };
      try{
        const { error } = await db.from('service_orders').insert([payload]);
        if(error) throw error;
        await loadServiceFromDB(); renderService(); closeServiceForm();
        addActivity('üîß',`Service order ${payload.order_no} created`);
      }catch(e){ alert('Could not save service order: '+(e.message||e)); }
    }

    /* ---------- AI ---------- */
    function addChatMessage(role, html){
      const box=$('chatBox'); const div=document.createElement('div');
      div.className=(role==='user'?'user':'assistant');
      div.style.alignSelf = role==='user'?'flex-end':'flex-start';
      div.style.background = role==='user'?'linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary))':'var(--bg-quaternary)';
      div.style.color = role==='user'?'#fff':'#fff'; div.style.border='1px solid var(--border)';
      div.style.padding='12px'; div.style.borderRadius='12px'; div.innerHTML=html;
      box.appendChild(div); box.scrollTop=box.scrollHeight;
    }
    function updateAIStatus(){
      const k=$('aiApiKey').value.trim(); aiApiKey = k||null;
      $('aiDot').style.background = aiApiKey?'var(--success)':'var(--error)';
      $('aiText').textContent = aiApiKey?'AI Status: Connected':'AI Status: API Key Required';
    }
    function updateOpenPhoneStatus(){ openphoneApiKey=$('openphoneApiKey').value.trim(); }
    function saveAIConfig(){ updateAIStatus(); updateOpenPhoneStatus(); alert('Saved'); }

    async function callOpenAI(prompt){
      if(!aiApiKey) throw new Error('No AI API key set');
      const payload={
        model:'gpt-4o-mini',
        temperature:0.2,
        messages:[
          {role:'system',content:'You are TVC Auto AI. Be concise.'},
          {role:'user',content:`DATA\nCustomers: ${JSON.stringify(customers.slice(0,30))}\nInventory: ${JSON.stringify(inventory.slice(0,30))}\nService: ${JSON.stringify(serviceOrders.slice(0,30))}\n\nQUESTION: ${prompt}`}
        ]
      };
      const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+aiApiKey},body:JSON.stringify(payload)});
      if(!r.ok){ throw new Error('OpenAI error '+r.status+': '+(await r.text())); }
      const j=await r.json(); return j.choices?.[0]?.message?.content?.trim()||'(no response)';
    }

    async function processAI(text){
      const t=(text||'').toLowerCase().trim(); const go=(id)=>showPage(id,findNav(id));
      const ensure=async()=>{ if(customers.length===0) await loadCustomersFromDB(); };

      if (/(show|open|go to)\s+(customers?|inventory|service|dashboard|chat|terminal|ai)/.test(t)){
        const map={customer:'customers',customers:'customers',inventory:'inventory',service:'service',dashboard:'dashboard',chat:'chat',terminal:'chat',ai:'chat'};
        const key=t.match(/(customers?|inventory|service|dashboard|chat|terminal|ai)/)[1];
        go(map[key]); if(map[key]==='customers'){ await ensure(); addChatMessage('assistant',`Opened Customers. Total <b>${customers.length}</b>.`);} else addChatMessage('assistant',`Opened <b>${map[key]}</b>.`); return true;
      }
      let m=t.match(/^(search|find)\s+(customers?|customer)\s+(for\s+)?(.+)/);
      if(m&&m[4]){ const q=m[4].trim(); await ensure(); go('customers'); $('customerSearch').value=q; filterCustomers(); const n=[...document.querySelectorAll('#customerRows tr')].filter(r=>r.style.display!=='none').length; addChatMessage('assistant',`Customer search "<b>${q}</b>": <b>${n}</b>.`); return true; }
      m=t.match(/^(view|open|show)\s+customer\s+(.+)/);
      if(m&&m[2]){ const q=m[2].trim(); await ensure(); go('customers'); const c=customers.find(x=>(`${x.firstName} ${x.lastName}`).toLowerCase().includes(q.toLowerCase())); if(c){ viewCustomer(c.id); addChatMessage('assistant',`Opening <b>${c.firstName} ${c.lastName}</b>.`);} else addChatMessage('assistant',`No customer for "<b>${q}</b>".`); return true; }
      m=t.match(/^(search|find)\s+inventory\s+(for\s+)?(.+)/);
      if(m&&m[3]){ const q=m[3].trim(); go('inventory'); $('invFilter').value=q; filterInventory(); const n=[...document.querySelectorAll('#invRows tr')].filter(r=>r.style.display!=='none').length; addChatMessage('assistant',`Inventory search "<b>${q}</b>": <b>${n}</b>.`); return true; }

      return false;
    }

    async function sendMessage(){
      const i=$('chatInput'); const msg=i.value.trim(); if(!msg) return; addChatMessage('user',msg); i.value='';
      const handled=await processAI(msg);
      if(!handled){
        if(!aiApiKey){ addChatMessage('assistant','‚ÑπÔ∏è No AI key set. Local commands still work.'); return; }
        try{ const out=await callOpenAI(msg); addChatMessage('assistant',out); }catch(e){ addChatMessage('assistant','‚ùå '+(e.message||e)); }
      }
    }
    async function testAIConnection(){
      try{ if(!$('aiApiKey').value.trim()){ alert('Paste your OpenAI key first'); return; } aiApiKey=$('aiApiKey').value.trim(); const ok=await callOpenAI('Reply with OK.'); addChatMessage('assistant','‚úÖ AI connected: '+ok); updateAIStatus(); }
      catch(e){ alert('AI test failed: '+(e.message||e)); }
    }

    /* ---------- VOICE ---------- */
    function initVoice(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ console.warn('No Web Speech API'); return; }
      recognition=new SR(); recognition.lang='en-US'; recognition.interimResults=true; recognition.continuous=true;
      recognition.onresult=(e)=>{ let final=''; for(let i=e.resultIndex;i<e.results.length;i++){ const tr=e.results[i][0].transcript; if(e.results[i].isFinal) final+=tr; } if(final.trim()){ addChatMessage('user','üéôÔ∏è '+final.trim()); processAI(final.trim()); } };
      recognition.onerror=(e)=>{ console.warn('voice error',e.error); if(e.error==='not-allowed') alert('Allow microphone'); };
      recognition.onend=()=>{ if(isListening) try{ recognition.start(); }catch{}; updateVoiceBtn(); };
    }
    function updateVoiceBtn(){ const b=$('voiceBtn'); b.textContent=isListening?'üéôÔ∏è Listening‚Ä¶ (tap to stop)':'üé§ Voice'; }
    function startVoice(){ if(!recognition){ alert('Use Chrome/Edge for voice'); return; } try{ recognition.start(); isListening=true; updateVoiceBtn(); addActivity('üéôÔ∏è','Voice on'); }catch{} }
    function stopVoice(){ if(recognition) try{ recognition.stop(); }catch{} isListening=false; updateVoiceBtn(); addActivity('üéôÔ∏è','Voice off'); }
    function toggleVoice(){ isListening?stopVoice():startVoice(); }

    /* ---------- STARTUP ---------- */
    document.addEventListener('DOMContentLoaded', async ()=>{
      initVoice();
      await Promise.all([ loadCustomersFromDB(), loadInventoryFromDB(), loadServiceFromDB() ]);
      renderCustomers(); renderInventory(); renderService(); renderCalls(); renderEmails();
      addActivity('‚úÖ','Loaded data');
    });
  </script>
</body>
</html>
