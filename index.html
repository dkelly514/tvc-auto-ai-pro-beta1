<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVC Auto AI Pro - Advanced Dealership Intelligence Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Restored & Enhanced Black, Gray, Dark Gold, and White Color Scheme */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1f1f1f;
            --bg-quaternary: #2a2a2a;
            --bg-glass: rgba(20, 20, 20, 0.7);

            /* Sophisticated darker gold/amber tones */
            --accent-primary: #8b6914; /* Dark Gold */
            --accent-secondary: #6b5010;
            --accent-tertiary: #4b380a;
            --accent-glow: rgba(139, 105, 20, 0.4);
            --accent-bright: #a57c1e;

            --text-primary: #f0f0f0;
            --text-secondary: #b8b8b8;
            --text-muted: #707070;
            
            --border-color: #2a2a2a;
            --border-accent: #3a3a3a;
            --border-glow: rgba(139, 105, 20, 0.3);

            --success: #00d68f;
            --success-dark: #00a870;
            --warning: #ff9500;
            --error: #ff3d71;
            --info: #0095ff;

            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 20px var(--accent-glow);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        *, *::before, *::after { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-primary) 0%, #0f0f0f 100%); color: var(--text-primary); line-height: 1.5; overflow-x: hidden; font-size: 13px; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle at 20% 50%, var(--accent-glow) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(0, 214, 143, 0.1) 0%, transparent 50%), radial-gradient(circle at 40% 20%, rgba(0, 149, 255, 0.1) 0%, transparent 50%); pointer-events: none; animation: gradientShift 20s ease infinite; z-index: 0; }
        @keyframes gradientShift { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }

        /* --- Layout --- */
        .terminal-container { display: grid; grid-template-columns: 260px 1fr; grid-template-rows: 70px 1fr; height: 100vh; gap: 1px; background: var(--border-color); position: relative; z-index: 1; }
        .top-bar { grid-column: 1 / -1; background: var(--bg-glass); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: var(--shadow-md); }
        .sidebar { background: var(--bg-glass); backdrop-filter: blur(10px); border-right: 1px solid var(--border-color); padding: 20px 12px; overflow-y: auto; overflow-x: hidden; }
        .main-content { background: var(--bg-primary); overflow: hidden; display: flex; flex-direction: column; }
        .content-header { background: var(--bg-glass); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); }
        .content-body { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .page-content { display: none; animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .page-content.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Scrollbar --- */
        .sidebar::-webkit-scrollbar, .content-body::-webkit-scrollbar, .chat-messages::-webkit-scrollbar, .transcript-container::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track, .content-body::-webkit-scrollbar-track, .chat-messages::-webkit-scrollbar-track, .transcript-container::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 4px; }
        .sidebar::-webkit-scrollbar-thumb, .content-body::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb, .transcript-container::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 4px; }
        
        /* --- Top Bar & Logo --- */
        .logo-section { display: flex; align-items: center; gap: 14px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-bright)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; box-shadow: var(--shadow-glow); animation: logoGlow 3s ease infinite; }
        @keyframes logoGlow { 0%, 100% { box-shadow: 0 0 10px var(--accent-glow); } 50% { box-shadow: 0 0 25px var(--accent-glow); } }
        .logo-text { font-size: 18px; font-weight: 800; background: linear-gradient(135deg, var(--text-primary), var(--accent-bright)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* --- Market Data --- */
        .market-data { display: flex; align-items: center; gap: 32px; font-size: 12px; }
        .market-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-accent); }
        .market-item:hover { background: var(--bg-quaternary); border-color: var(--accent-primary); box-shadow: var(--shadow-sm); }
        .market-value { font-weight: 700; color: var(--text-primary); font-size: 13px; }
        .market-change { font-weight: 600; font-size: 11px; padding: 2px 6px; border-radius: 4px; }
        .positive { color: var(--success); background: rgba(0, 214, 143, 0.1); }
        .negative { color: var(--error); background: rgba(255, 61, 113, 0.1); }

        /* --- Top Actions & Buttons --- */
        .top-actions { display: flex; align-items: center; gap: 12px; }
        .status-indicator { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: var(--success); padding: 6px 12px; background: rgba(0, 214, 143, 0.1); border: 1px solid rgba(0, 214, 143, 0.3); border-radius: 20px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; box-shadow: 0 0 10px var(--success); }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.2); transform: translate(-50%, -50%); transition: width 0.4s, height 0.4s; }
        .btn:hover::before { width: 300px; height: 300px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-bright)); color: white; box-shadow: 0 4px 12px var(--accent-glow); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--accent-glow); }
        .btn-secondary { background: var(--bg-glass); backdrop-filter: blur(10px); color: var(--text-secondary); border: 1px solid var(--border-accent); }
        .btn-secondary:hover { background: var(--bg-quaternary); color: var(--text-primary); border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .btn-sm { padding: 6px 12px; font-size: 11px; }

        /* --- Sidebar Navigation --- */
        .nav-section { margin-bottom: 24px; }
        .nav-title { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; padding: 0 10px; opacity: 0.7; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: var(--text-secondary); position: relative; overflow: hidden; }
        .nav-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--accent-primary); transform: scaleY(0); }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: linear-gradient(90deg, var(--accent-tertiary), transparent); color: white; }
        .nav-item.active::before { transform: scaleY(1); }
        .nav-icon { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .nav-badge { margin-left: auto; background: var(--error); color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 12px; min-width: 20px; text-align: center; box-shadow: 0 2px 8px rgba(255, 61, 113, 0.3); }
        
        /* --- General Content Styles --- */
        .content-title { font-size: 20px; font-weight: 800; background: linear-gradient(135deg, var(--text-primary), var(--text-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .metric-card { background: var(--bg-glass); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; position: relative; overflow: hidden; }
        .metric-card:hover { transform: translateY(-4px); border-color: var(--accent-primary); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); }
        .metric-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .metric-value { font-size: 28px; font-weight: 900; color: var(--text-primary); margin: 6px 0; line-height: 1; background: linear-gradient(135deg, var(--text-primary), var(--accent-bright)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .metric-subtitle { font-size: 12px; color: var(--text-muted); opacity: 0.8; }
        .widget-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .data-table-container { background: var(--bg-glass); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: var(--shadow-md); }
        .table-header { background: var(--bg-tertiary); padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .table-title { font-size: 15px; font-weight: 700; color: var(--text-primary); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: var(--bg-quaternary); padding: 12px 18px; text-align: left; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--border-accent); }
        .data-table td { padding: 14px 18px; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        .data-table tr:hover { background: rgba(139, 105, 20, 0.05); }
        .data-table tr:last-child td { border-bottom: none; }
        .activity-feed { background: var(--bg-glass); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; height: 340px; overflow-y: auto; box-shadow: var(--shadow-md); }
        .activity-item { padding: 14px 18px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 14px; }
        .activity-item:last-child { border-bottom: none; }
        .activity-indicator { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 10px currentColor; }
        .activity-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .activity-subtitle { font-size: 11px; color: var(--text-muted); }
        .activity-time { font-size: 11px; color: var(--text-muted); flex-shrink: 0; margin-left: auto;}
        .chart-widget { background: var(--bg-glass); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .chart-placeholder { height: 250px; position: relative; } /* MODIFIED FOR SVG CHART */

        /* --- AI Terminal & Chat --- */
        .ai-config-panel { background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-quaternary)); border: 2px solid var(--accent-primary); border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 0 30px var(--accent-glow); position: relative; overflow: hidden; }
        .ai-config-panel::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%); animation: aiGlow 4s ease infinite; }
        @keyframes aiGlow { 0%, 100% { transform: rotate(0deg); opacity: 0.3; } 50% { transform: rotate(180deg); opacity: 0.6; } }
        .ai-status { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding: 12px; background: var(--bg-glass); backdrop-filter: blur(10px); border-radius: 8px; position: relative; z-index: 1; }
        .ai-status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--error); }
        .ai-status-dot.connected { background: var(--success); animation: pulse 2s infinite; box-shadow: 0 0 15px var(--success); }
        .ai-provider-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; position: relative; z-index: 1; }
        .ai-provider-card { background: var(--bg-glass); backdrop-filter: blur(10px); border: 2px solid var(--border-accent); border-radius: 10px; padding: 16px; cursor: pointer; text-align: center; }
        .ai-provider-card:hover { border-color: var(--accent-primary); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); }
        .ai-provider-card.selected { border-color: var(--accent-bright); background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), transparent); }
        .chat-container { background: var(--bg-glass); backdrop-filter: blur(10px); border: 2px solid var(--border-accent); border-radius: 12px; height: 550px; display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; box-shadow: var(--shadow-lg); overflow: hidden; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .chat-message { max-width: 75%; padding: 14px 18px; border-radius: 12px; font-size: 13px; line-height: 1.6; animation: messageSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-message.user { align-self: flex-end; background: linear-gradient(135deg, var(--accent-primary), var(--accent-bright)); color: white; box-shadow: 0 4px 12px var(--accent-glow); }
        .chat-message.assistant { align-self: flex-start; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-accent); box-shadow: var(--shadow-sm); }
        .chat-message.system { align-self: center; background: linear-gradient(135deg, var(--bg-quaternary), var(--bg-tertiary)); color: var(--text-muted); font-style: italic; max-width: 90%; text-align: center; border: 1px solid var(--border-accent); }
        .chat-input-container { padding: 20px; border-top: 1px solid var(--border-accent); display: flex; gap: 12px; background: var(--bg-tertiary); }
        .chat-input { flex: 1; padding: 12px 16px; background: var(--bg-quaternary); border: 1px solid var(--border-accent); border-radius: 8px; color: var(--text-primary); font-size: 13px; }
        .chat-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-glow); }

        /* --- Forms --- */
        .form-container { background: var(--bg-glass); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; max-width: 650px; margin: 0 auto; box-shadow: var(--shadow-lg); }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 14px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 13px; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); background: var(--bg-quaternary); box-shadow: 0 0 0 3px var(--accent-glow); }
        
        /* --- Badges --- */
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
        .status-hot { background: linear-gradient(135deg, rgba(255, 61, 113, 0.2), rgba(255, 61, 113, 0.1)); color: var(--error); border: 1px solid rgba(255, 61, 113, 0.4); }
        .status-qualified, .status-available, .status-delivered { background: linear-gradient(135deg, rgba(0, 214, 143, 0.2), rgba(0, 214, 143, 0.1)); color: var(--success); border: 1px solid rgba(0, 214, 143, 0.4); }
        .status-follow, .status-reserved { background: linear-gradient(135deg, rgba(255, 149, 0, 0.2), rgba(255, 149, 0, 0.1)); color: var(--warning); border: 1px solid rgba(255, 149, 0, 0.4); }
        .lead-score { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-align: center; min-width: 35px; display: inline-block; }
        .score-high { background: linear-gradient(135deg, rgba(0, 214, 143, 0.2), rgba(0, 214, 143, 0.1)); color: var(--success); border: 1px solid rgba(0, 214, 143, 0.4); box-shadow: 0 2px 8px rgba(0, 214, 143, 0.2); }
        .score-medium { background: linear-gradient(135deg, rgba(255, 149, 0, 0.2), rgba(255, 149, 0, 0.1)); color: var(--warning); border: 1px solid rgba(255, 149, 0, 0.4); box-shadow: 0 2px 8px rgba(255, 149, 0, 0.2); }
        .score-low { background: linear-gradient(135deg, rgba(255, 61, 113, 0.2), rgba(255, 61, 113, 0.1)); color: var(--error); border: 1px solid rgba(255, 61, 113, 0.4); box-shadow: 0 2px 8px rgba(255, 61, 113, 0.2); }
        
        /* --- Specific Page Components --- */
        .camera-container { background: var(--bg-glass); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
        .video-preview { width: 100%; max-width: 320px; height: 240px; background: var(--bg-tertiary); border-radius: 12px; }
        .vehicle-photos { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-top: 20px; }
        .photo-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 4/3; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .vin-result { background: var(--bg-tertiary); border: 2px solid var(--accent-primary); border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 0 20px var(--accent-glow); }
        .vin-result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; }
        .vin-field-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .vin-field-value { font-size: 15px; font-weight: 600; color: var(--text-primary); }

        /* --- Notification --- */
        .notification-toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 20px; background: var(--bg-glass); backdrop-filter: blur(10px); border: 1px solid var(--border-accent); border-radius: 10px; box-shadow: var(--shadow-lg); color: var(--text-primary); font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 12px; transform: translateX(400px); z-index: 1000; }
        .notification-toast.show { transform: translateX(0); }
        
        /* --- Responsive --- */
        @media (max-width: 1400px) { .dashboard-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .terminal-container { grid-template-columns: 1fr; } .sidebar, .market-data { display: none; } .dashboard-grid, .widget-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="terminal-container">
        <div class="top-bar">
            <div class="logo-section">
                <div class="logo-icon">‚ö°</div>
                <div class="logo-text">TVC Auto AI Pro</div>
            </div>
            <div class="market-data">
                <div class="market-item"><span style="color: var(--text-muted);">Revenue</span><span class="market-value" id="topBarRevenue"></span><span class="market-change positive" id="topBarRevenueChange"></span></div>
                <div class="market-item"><span style="color: var(--text-muted);">Hot Leads</span><span class="market-value" id="topBarLeads"></span><span class="market-change positive" id="topBarLeadsChange"></span></div>
            </div>
            <div class="top-actions">
                <div class="status-indicator"><div class="status-dot"></div><span>LIVE DATA</span></div>
                <button class="btn btn-secondary" id="voiceBtn" onclick="toggleVoice()">üéôÔ∏è Voice AI</button>
                <button class="btn btn-primary" onclick="showPage('chat', document.querySelector('.nav-item[onclick*=\'chat\']'))">ü§ñ AI Terminal</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="nav-section">
                <div class="nav-title">Analytics</div>
                <div class="nav-item active" onclick="showPage('dashboard', this)"><div class="nav-icon">üìä</div>Dashboard</div>
                <div class="nav-item" onclick="showPage('analytics', this)"><div class="nav-icon">üìà</div>Performance</div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Operations</div>
                <div class="nav-item" onclick="showPage('customers', this)"><div class="nav-icon">üë•</div>Customers<div class="nav-badge" id="customerBadge">0</div></div>
                <div class="nav-item" onclick="showPage('inventory', this)"><div class="nav-icon">üöó</div>Inventory</div>
                <div class="nav-item" onclick="showPage('photos', this)"><div class="nav-icon">üì∏</div>Photo Manager<div class="nav-badge" id="photoBadge">0</div></div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Communication</div>
                <div class="nav-item" onclick="showPage('calls', this)"><div class="nav-icon">üìû</div>Call Center<div class="nav-badge" id="callBadge">0</div></div>
                <div class="nav-item" onclick="showPage('emails', this)"><div class="nav-icon">‚úâÔ∏è</div>Email Hub</div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Intelligence</div>
                <div class="nav-item" onclick="showPage('vin', this)"><div class="nav-icon">üîç</div>VIN Scanner</div>
                <div class="nav-item" onclick="showPage('chat', this)"><div class="nav-icon">ü§ñ</div>AI Terminal</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="content-header">
                <div class="content-title" id="contentTitle">Executive Dashboard</div>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                    <button class="btn btn-primary" onclick="simulateNewCall()">üéØ Simulate AI Call</button>
                </div>
            </div>

            <div class="content-body">
                <div id="dashboard" class="page-content active">
                     <div class="dashboard-grid">
                        <div class="metric-card" onclick="showMetricDetails('revenue')">
                            <div class="metric-header"><div class="metric-label">Total Revenue</div><div class="metric-trend" id="dashboardRevenueTrend"></div></div>
                            <div class="metric-value" id="dashboardRevenue"></div><div class="metric-subtitle" id="dashboardRevenueSubtitle"></div>
                        </div>
                        <div class="metric-card" onclick="showMetricDetails('leads')">
                            <div class="metric-header"><div class="metric-label">Hot Leads</div><div class="metric-trend" id="dashboardLeadsTrend"></div></div>
                            <div class="metric-value" id="dashboardLeads"></div><div class="metric-subtitle" id="dashboardLeadsSubtitle"></div>
                        </div>
                        <div class="metric-card" onclick="showMetricDetails('calls')">
                            <div class="metric-header"><div class="metric-label">Calls Today</div><div class="metric-trend" id="dashboardCallsTrend"></div></div>
                            <div class="metric-value" id="dashboardCalls"></div><div class="metric-subtitle" id="dashboardCallsSubtitle"></div>
                        </div>
                        <div class="metric-card" onclick="showMetricDetails('saleTime')">
                            <div class="metric-header"><div class="metric-label">Avg Sale Time</div><div class="metric-trend" id="dashboardSaleTimeTrend"></div></div>
                            <div class="metric-value" id="dashboardSaleTime"></div><div class="metric-subtitle" id="dashboardSaleTimeSubtitle"></div>
                        </div>
                    </div>
                    <div class="widget-grid">
                        <div class="chart-widget">
                            <div class="widget-header"><div class="widget-title">AI-Powered Sales Forecast</div></div>
                            <div class="chart-placeholder" id="salesForecastChart"></div>
                        </div>
                        <div class="activity-feed"><div class="widget-header"><div class="widget-title">Live Activity Stream</div></div><div id="activityFeedContent"></div></div>
                    </div>
                </div>

                <div id="analytics" class="page-content">
                    <div class="dashboard-grid">
                        <div class="metric-card"><div class="metric-header"><div class="metric-label">Lead Conversion Rate</div></div><div class="metric-value" id="analyticsConversionRate">0%</div><div class="metric-subtitle">From initial contact to sale</div></div>
                        <div class="metric-card"><div class="metric-header"><div class="metric-label">Avg. Lead Score</div></div><div class="metric-value" id="analyticsAvgScore">0/10</div><div class="metric-subtitle">Across all active customers</div></div>
                        <div class="metric-card"><div class="metric-header"><div class="metric-label">Customer Satisfaction</div></div><div class="metric-value">96%</div><div class="metric-subtitle">Based on post-sale surveys</div></div>
                        <div class="metric-card"><div class="metric-header"><div class="metric-label">Avg. Profit Per Unit</div></div><div class="metric-value">$4,210</div><div class="metric-subtitle">After all associated costs</div></div>
                    </div>
                    <div class="data-table-container">
                        <div class="table-header"><div class="table-title">Detailed Performance Metrics</div></div>
                        <table class="data-table"><thead><tr><th>Metric</th><th>Current Value</th><th>Previous Period</th><th>Change</th></tr></thead><tbody id="analyticsTableBody"></tbody></table>
                    </div>
                </div>

                <div id="customers" class="page-content">
                    <div class="data-table-container">
                        <div class="table-header"><div class="table-title">Customer Pipeline</div><button class="btn btn-primary" onclick="openCustomerForm()">+ Add Customer</button></div>
                        <table class="data-table">
                            <thead><tr><th>Customer</th><th>Contact Info</th><th>Status</th><th>AI Score</th><th>Value</th><th>Last Contact</th></tr></thead>
                            <tbody id="customerTableBody"></tbody>
                        </table>
                    </div>
                    <div id="addCustomerForm" class="form-container" style="display: none; margin-top: 24px;"></div>
                </div>

                <div id="inventory" class="page-content">
                     <div class="data-table-container">
                        <div class="table-header"><div class="table-title">Vehicle Inventory</div><button class="btn btn-primary">+ Add Vehicle</button></div>
                        <table class="data-table">
                            <thead><tr><th>Vehicle</th><th>VIN</th><th>Status</th><th>Price</th><th>Days in Stock</th><th>Photos</th></tr></thead>
                            <tbody id="inventoryTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="photos" class="page-content">
                    <div class="camera-container">
                        <div class="widget-header" style="margin: 0 0 16px 0;"><div class="widget-title">Vehicle Photo Management</div></div>
                        <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                            <div>
                                <video id="cameraFeed" class="video-preview" autoplay playsinline style="display: none;"></video>
                                <canvas id="photoCanvas" style="display: none;"></canvas>
                                <div id="cameraPlaceholder" class="video-preview" style="display: flex; align-items: center; justify-content: center; color: var(--text-muted);">Camera feed offline</div>
                            </div>
                            <div style="flex: 1;">
                                <div class="form-group"><label class="form-label">Select Vehicle</label><select id="vehicleSelect" class="form-select"></select></div>
                                <div class="form-group"><label class="form-label">Photo Type</label><select id="photoType" class="form-select"><option>Exterior</option><option>Interior</option><option>Engine</option><option>Damage</option></select></div>
                                <div class="camera-controls"><button class="btn btn-secondary" onclick="startCamera()">üì∑ Start Camera</button><button class="btn btn-primary" onclick="capturePhoto()" id="captureBtn" disabled>üì∏ Capture</button><button class="btn btn-secondary" onclick="stopCamera()">‚èπÔ∏è Stop</button></div>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container"><div class="table-header"><div class="table-title">Photo Gallery</div></div><div id="photoGallery" class="vehicle-photos" style="padding: 20px;"></div></div>
                </div>

                <div id="calls" class="page-content">
                    <div class="data-table-container">
                        <div class="table-header"><div class="table-title">Call Center</div><button class="btn btn-primary" onclick="simulateNewCall()">üìû Simulate Incoming Call</button></div>
                        <table class="data-table">
                            <thead><tr><th>Customer</th><th>AI Summary</th><th>AI Score</th><th>Duration</th><th>Timestamp</th><th>Status</th></tr></thead>
                            <tbody id="callTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="emails" class="page-content">
                    <div class="widget-grid">
                        <div class="data-table-container">
                             <div class="table-header"><div class="table-title">Email History</div><button class="btn btn-primary">‚úâÔ∏è New Campaign</button></div>
                             <table class="data-table"><thead><tr><th>Recipient</th><th>Subject</th><th>Status</th><th>Timestamp</th></tr></thead><tbody id="emailTableBody"></tbody></table>
                        </div>
                         <div class="email-template-editor">
                            <div class="widget-header"><div class="widget-title">AI Email Templates</div></div>
                            <div class="form-group"><label class="form-label">Template Type</label><select id="templateType" class="form-select" onchange="loadEmailTemplate()"><option value="initial">Initial Follow-up</option><option value="followup">Weekly Check-in</option></select></div>
                            <div class="form-group"><label class="form-label">Subject</label><input type="text" id="emailSubject" class="form-input"></div>
                            <div class="form-group"><label class="form-label">Body</label><textarea id="emailBody" class="form-textarea" rows="8"></textarea></div>
                            <button class="btn btn-primary" onclick="saveEmailTemplate()">üíæ Save Template</button>
                        </div>
                    </div>
                </div>
                
                <div id="vin" class="page-content">
                    <div class="form-container">
                        <div class="widget-header" style="margin-bottom: 20px;"><div class="widget-title">VIN Intelligence Scanner</div></div>
                        <div class="form-group"><label class="form-label">Vehicle Identification Number (17 Characters)</label><div style="display: flex; gap: 10px;"><input type="text" id="vinInput" class="form-input" placeholder="Enter VIN..." maxlength="17"><button class="btn btn-primary" onclick="scanVIN()">Scan</button></div></div>
                        <div id="vinResult" class="vin-result" style="display: none;"></div>
                    </div>
                </div>

                <div id="chat" class="page-content">
                     <div class="ai-config-panel">
                        <div class="widget-header" style="margin: 0 0 20px 0; position: relative; z-index: 1;"><div class="widget-title">AI Intelligence Configuration</div></div>
                        <div class="ai-status"><div class="ai-status-dot" id="aiStatusDot"></div><span id="aiStatusText">AI Status: Select a provider to begin</span></div>
                        <div class="ai-provider-grid">
                            <div class="ai-provider-card" onclick="selectAIProvider('openai', this)"><div class="ai-provider-name">OpenAI</div><div class="ai-provider-model">GPT-4 Turbo</div></div>
                            <div class="ai-provider-card" onclick="selectAIProvider('anthropic', this)"><div class="ai-provider-name">Anthropic</div><div class="ai-provider-model">Claude 3</div></div>
                            <div class="ai-provider-card" onclick="selectAIProvider('gemini', this)"><div class="ai-provider-name">Google</div><div class="ai-provider-model">Gemini Pro</div></div>
                            <div class="ai-provider-card" onclick="selectAIProvider('local', this)"><div class="ai-provider-name">Local AI</div><div class="ai-provider-model">Llama 3</div></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; position: relative; z-index: 1;">
                            <div class="form-group"><label class="form-label">AI API Key</label><input type="password" id="aiApiKey" class="form-input" placeholder="Enter your AI API key..." onchange="updateAIStatus()"></div>
                            <div class="form-group"><label class="form-label">OpenPhone API Key</label><input type="password" class="form-input" placeholder="Enter OpenPhone API key..."></div>
                        </div>
                        <div style="display: flex; gap: 10px; position: relative; z-index: 1;"><button class="btn btn-primary" onclick="testAIConnection()">üîó Test AI</button><button class="btn btn-primary">üìû Test Phone</button><button class="btn btn-secondary" onclick="saveAIConfig()">üíæ Save Config</button></div>
                    </div>
                    <div class="chat-container">
                        <div class="table-header"><div class="table-title">AI Terminal Interface</div></div>
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input-container"><input type="text" id="chatInput" class="chat-input form-input" placeholder="Ask a question or give a command..." onkeypress="if(event.key==='Enter') sendMessage()"><button class="btn btn-primary" onclick="sendMessage()">Send</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationToast" class="notification-toast">
        <div id="notificationMessage"></div>
    </div>
    
<script>
// --- [START] FULLY FUNCTIONAL JAVASCRIPT ENGINE ---

// --- 1. STATE MANAGEMENT ---
const state = {
    user: { name: 'Operator' },
    config: { aiProvider: null, aiApiKey: null },
    metrics: {
        revenue: { current: 487000, previous: 435000 },
        saleTime: { current: 14, previous: 21 },
        industrySaleTime: 21,
    },
    customers: [
        { id: 101, firstName: 'John', lastName: 'Smith', email: 'john.s@example.com', phone: '555-0101', status: 'hot', value: 65000, vehicleInterest: '2024 BMW X5', lastContact: new Date(Date.now() - 2 * 3600 * 1000), leadScore: 9, address: '123 Main St', currentVehicle: '2018 Toyota Corolla', timeline: '2 weeks', budget: '$60k-$70k' },
        { id: 102, firstName: 'Sarah', lastName: 'Johnson', email: 's.johnson@example.com', phone: '555-0102', status: 'qualified', value: 58000, vehicleInterest: 'Tesla Model Y', lastContact: new Date(Date.now() - 5 * 3600 * 1000), leadScore: 8, address: '456 Oak Ave', currentVehicle: '2019 Tesla Model 3', timeline: '1 month', budget: '$55k-$65k' },
        { id: 103, firstName: 'Mike', lastName: 'Wilson', email: 'mike.w@example.com', phone: '555-0103', status: 'follow', value: 52000, vehicleInterest: 'Ford F-150 Lightning', lastContact: new Date(Date.now() - 24 * 3600 * 1000), leadScore: 6, address: '789 Pine Ln', currentVehicle: '2020 Ford Escape', timeline: '3 months', budget: '$50k-$60k' },
    ],
    inventory: [
        { id: 201, vehicle: '2024 Toyota Camry', vin: '1HGBH41JXMN109186', status: 'available', price: 32000, daysInStock: 13, photoCount: 0 },
        { id: 202, vehicle: '2024 Honda Accord', vin: '2HGBH41JXMN109187', status: 'sold', price: 35000, daysInStock: 8, photoCount: 5 },
        { id: 203, vehicle: '2024 Ford F-150', vin: '3HGBH41JXMN109188', status: 'reserved', price: 45000, daysInStock: 42, photoCount: 3 },
    ],
    communications: [
        { id: 301, customerId: 101, type: 'Call', summary: 'Wants to test drive the BMW X5 this week. Pre-approved for $70k.', duration: 345, timestamp: new Date(Date.now() - 2 * 3600 * 1000), status: 'transcribed', leadScore: 9 },
        { id: 302, customerId: 102, type: 'Email', summary: 'Inquiring about trade-in process for a 2019 Highlander for a Tesla Model Y.', duration: 0, timestamp: new Date(Date.now() - 5 * 3600 * 1000), status: 'transcribed', leadScore: 8 },
    ],
    emailHistory: [
        { recipient: 'John Smith', subject: 'Your BMW X5 Inquiry', status: 'opened', timestamp: new Date(Date.now() - 2 * 3600 * 1000) },
        { recipient: 'Sarah Johnson', subject: 'Tesla Model Y Trade-in', status: 'delivered', timestamp: new Date(Date.now() - 5 * 3600 * 1000) }
    ],
    emailTemplates: {
        initial: { subject: 'Following up on your inquiry about the {vehicle}', body: 'Hi {firstName},\n\nThank you for your interest in the {vehicle}. I\'d be happy to schedule a test drive for you. What day works best?\n\nBest,\nTVC Auto' },
        followup: { subject: 'Checking in on your vehicle search', body: 'Hi {firstName},\n\nJust wanted to follow up on your recent inquiry. Have you had any more thoughts on the {vehicle}?\n\nLet me know if I can help.\n\nBest,\nTVC Auto' }
    },
    vehiclePhotos: [],
    activityStream: [],
};
let isListening = false;
let cameraStream = null;

// --- 2. INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("TVC Auto AI Pro Initializing...");
    buildFullCustomerForm();
    renderAll();
    addChatMessage('assistant', `ü§ñ <strong>Welcome, ${state.user.name}.</strong> AI Terminal is online. Configure your provider and ask me anything about your dealership operations.`);
    addActivity('‚úÖ', 'System Initialized', `Welcome, ${state.user.name}`, 'var(--success)');
});

// --- 3. CORE RENDER FUNCTIONS ---
function renderAll() {
    renderDashboardMetrics();
    renderTopBarMetrics();
    renderCustomerTable();
    renderInventoryTable();
    renderCallTable();
    renderActivityStream();
    renderBadges();
    renderAnalyticsPage();
    renderEmailTable();
    loadEmailTemplate();
    populateVehicleSelect();
    updatePhotoDisplay();
    renderSalesForecastChart(); // Added this call
}

function renderSalesForecastChart() {
    const container = document.getElementById('salesForecastChart');
    if (!container) return;

    // Simulate past 5 months of sales data + 1 month AI forecast
    const salesData = [
        { month: 'Mar', sales: 380000 },
        { month: 'Apr', sales: 410000 },
        { month: 'May', sales: 435000 },
        { month: 'Jun', sales: 450000 },
        { month: 'Jul', sales: state.metrics.revenue.current }
    ];
    
    // Simple AI forecast: average of last two months' growth
    const growth1 = salesData[4].sales - salesData[3].sales;
    const growth2 = salesData[3].sales - salesData[2].sales;
    const avgGrowth = (growth1 + growth2) / 2;
    const forecastSales = salesData[4].sales + avgGrowth;
    salesData.push({ month: 'Aug (FC)', sales: forecastSales, forecast: true });

    const maxSales = Math.max(...salesData.map(d => d.sales)) * 1.1; // Add 10% padding
    const chartHeight = 200;
    const chartWidth = container.clientWidth;
    const barWidth = (chartWidth / salesData.length) * 0.6;
    const barMargin = (chartWidth / salesData.length) * 0.4;

    let svgContent = `<svg width="100%" height="${chartHeight + 30}" style="font-family: 'JetBrains Mono', monospace;">`;

    salesData.forEach((d, i) => {
        const barHeight = (d.sales / maxSales) * chartHeight;
        const x = i * (barWidth + barMargin);
        const y = chartHeight - barHeight;
        
        const isForecast = d.forecast;
        const barFill = isForecast ? "url(#forecastGradient)" : "var(--accent-primary)";
        
        svgContent += `
            <defs>
                <linearGradient id="forecastGradient" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="var(--accent-bright)" />
                    <stop offset="100%" stop-color="var(--accent-primary)" />
                </linearGradient>
            </defs>
            <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${barFill}" rx="4" ${isForecast ? 'stroke-dasharray="4" stroke="var(--accent-bright)" stroke-width="2"' : ''}>
                <title>${d.month}: $${d.sales.toLocaleString()}</title>
            </rect>
            <text x="${x + barWidth / 2}" y="${chartHeight + 20}" fill="var(--text-muted)" font-size="12" text-anchor="middle">${d.month}</text>
        `;
    });

    svgContent += `</svg>`;
    container.innerHTML = svgContent;
}

function renderDashboardMetrics() {
    const { revenue, saleTime, industrySaleTime } = state.metrics;
    const revenueChange = (revenue.current - revenue.previous) / revenue.previous;
    const saleTimeChange = saleTime.current - saleTime.previous;
    const hotLeads = state.customers.filter(c => c.status === 'hot');
    const callsToday = state.communications.filter(c => c.type === 'Call' && isToday(c.timestamp));

    document.getElementById('dashboardRevenue').textContent = `$${(revenue.current / 1000).toFixed(0)}K`;
    document.getElementById('dashboardRevenueTrend').textContent = `${revenueChange >= 0 ? '+' : ''}${(revenueChange * 100).toFixed(0)}%`;
    document.getElementById('dashboardRevenueTrend').className = `metric-trend ${revenueChange >= 0 ? 'trend-up' : 'trend-down'}`;
    document.getElementById('dashboardRevenueSubtitle').textContent = `vs $${(revenue.previous / 1000).toFixed(0)}K last month`;

    const newLeadsToday = hotLeads.filter(c => isToday(c.lastContact)).length;
    document.getElementById('dashboardLeads').textContent = hotLeads.length;
    document.getElementById('dashboardLeadsTrend').textContent = `+${newLeadsToday}`;
    document.getElementById('dashboardLeadsTrend').className = 'metric-trend trend-up';
    document.getElementById('dashboardLeadsSubtitle').textContent = `${newLeadsToday} new hot leads today`;

    document.getElementById('dashboardCalls').textContent = callsToday.length;
    document.getElementById('dashboardCallsTrend').textContent = `+${callsToday.length}`;
    document.getElementById('dashboardCallsTrend').className = 'metric-trend trend-up';
    document.getElementById('dashboardCallsSubtitle').textContent = `${state.communications.filter(c => c.type === 'Call' && c.status === 'transcribed').length} transcribed`;
    
    document.getElementById('dashboardSaleTime').textContent = `${saleTime.current}d`;
    document.getElementById('dashboardSaleTimeTrend').textContent = `${saleTimeChange > 0 ? '+' : ''}${saleTimeChange}d`;
    document.getElementById('dashboardSaleTimeTrend').className = `metric-trend ${saleTimeChange <= 0 ? 'trend-up' : 'trend-down'}`;
    document.getElementById('dashboardSaleTimeSubtitle').textContent = `Industry average: ${industrySaleTime}d`;
}

function renderTopBarMetrics() {
    const { revenue } = state.metrics;
    const revenueChange = (revenue.current - revenue.previous) / revenue.previous;
    const hotLeads = state.customers.filter(c => c.status === 'hot');
    
    document.getElementById('topBarRevenue').textContent = `$${(revenue.current / 1000).toFixed(0)}K`;
    document.getElementById('topBarRevenueChange').textContent = `${revenueChange >= 0 ? '+' : ''}${(revenueChange * 100).toFixed(0)}%`;
    document.getElementById('topBarLeads').textContent = hotLeads.length;
    document.getElementById('topBarLeadsChange').textContent = `+${hotLeads.filter(c => isToday(c.lastContact)).length}`;
}

function renderCustomerTable() {
    const tbody = document.getElementById('customerTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    state.customers.forEach(c => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><b>${c.firstName} ${c.lastName}</b></td>
            <td>${c.email}<br>${c.phone}</td>
            <td><span class="status-badge status-${c.status}">${c.status}</span></td>
            <td><span class="lead-score ${getScoreClass(c.leadScore)}">${c.leadScore}/10</span></td>
            <td>$${c.value.toLocaleString()}</td>
            <td>${formatTimeAgo(c.lastContact)}</td>
        `;
    });
}

function renderInventoryTable() {
    const tbody = document.getElementById('inventoryTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    state.inventory.forEach(item => {
        const row = tbody.insertRow();
        const stockClass = item.daysInStock > 30 ? 'error' : 'success';
        row.innerHTML = `
            <td><b>${item.vehicle}</b></td>
            <td>${item.vin}</td>
            <td><span class="status-badge status-${item.status}">${item.status}</span></td>
            <td>$${item.price.toLocaleString()}</td>
            <td style="color: var(--${stockClass}); font-weight: 600;">${item.daysInStock} days</td>
            <td>${item.photoCount} Photos</td>
        `;
    });
}

function renderCallTable() {
    const tbody = document.getElementById('callTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    state.communications.filter(c => c.type === 'Call').forEach(c => {
        const customer = state.customers.find(cust => cust.id === c.customerId);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><b>${customer ? `${customer.firstName} ${customer.lastName}` : 'Unknown'}</b></td>
            <td>${c.summary}</td>
            <td><span class="lead-score ${getScoreClass(c.leadScore)}">${c.leadScore}/10</span></td>
            <td>${formatDuration(c.duration)}</td>
            <td>${formatTimeAgo(c.timestamp)}</td>
            <td><span class="status-badge status-transcribed">${c.status}</span></td>
        `;
    });
}

function renderEmailTable() {
    const tbody = document.getElementById('emailTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    state.emailHistory.forEach(e => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${e.recipient}</td>
            <td>${e.subject}</td>
            <td><span class="status-badge status-${e.status}">${e.status}</span></td>
            <td>${formatTimeAgo(e.timestamp)}</td>
        `;
    });
}

function renderAnalyticsPage() {
    const totalLeads = state.customers.length;
    const soldCount = state.inventory.filter(i => i.status === 'sold').length;
    document.getElementById('analyticsConversionRate').textContent = `${((soldCount / totalLeads) * 100).toFixed(1)}%`;
    const avgScore = state.customers.reduce((acc, c) => acc + c.leadScore, 0) / totalLeads;
    document.getElementById('analyticsAvgScore').textContent = `${avgScore.toFixed(1)}/10`;

    const tableBody = document.getElementById('analyticsTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = `
        <tr><td>Total Revenue</td><td>$${state.metrics.revenue.current.toLocaleString()}</td><td>$${state.metrics.revenue.previous.toLocaleString()}</td><td style="color: var(--success);">+${((state.metrics.revenue.current - state.metrics.revenue.previous) / state.metrics.revenue.previous * 100).toFixed(1)}%</td></tr>
        <tr><td>Units Sold</td><td>${soldCount}</td><td>${soldCount - 2}</td><td style="color: var(--success);">+2</td></tr>
        <tr><td>Avg. Sale Price</td><td>$${(state.metrics.revenue.current / soldCount).toFixed(0).toLocaleString()}</td><td>$36,250</td><td style="color: var(--error);">-2.7%</td></tr>
    `;
}

function renderActivityStream() {
    const feed = document.getElementById('activityFeedContent');
    feed.innerHTML = '';
    if (state.activityStream.length === 0) {
        feed.innerHTML = `<div class="activity-item" style="justify-content: center; color: var(--text-muted);">No recent activity</div>`;
        return;
    }
    state.activityStream.slice(0, 4).forEach(act => {
        const item = document.createElement('div');
        item.className = 'activity-item';
        item.innerHTML = `
            <div class="activity-indicator" style="background-color: ${act.color};"></div>
            <div><div class="activity-title">${act.title}</div><div class="activity-subtitle">${act.subtitle}</div></div>
            <div class="activity-time">${formatTimeAgo(act.timestamp)}</div>
        `;
        feed.appendChild(item);
    });
}

function renderBadges() {
    document.getElementById('customerBadge').textContent = state.customers.length;
    document.getElementById('callBadge').textContent = state.communications.filter(c => c.type === 'Call').length;
    document.getElementById('photoBadge').textContent = state.vehiclePhotos.length;
}

// --- 4. CORE AI & FUNCTIONALITY ---
function toggleVoice() {
    const voiceBtn = document.getElementById('voiceBtn');
    if (!('webkitSpeechRecognition' in window)) {
        showNotification('error', 'Voice recognition not supported in this browser.');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
        isListening = true;
        voiceBtn.innerHTML = 'üî¥ Listening...';
        voiceBtn.style.background = 'var(--error)';
        showNotification('info', 'Voice AI is listening...');
    };

    recognition.onresult = (event) => {
        const command = event.results[0][0].transcript.toLowerCase();
        addChatMessage('user', `Voice Command: "${command}"`);
        showNotification('success', `Command received: "${command}"`);
        
        let executed = false;
        const navMap = {
            'dashboard': 'dashboard', 'analytics': 'analytics', 'performance': 'analytics',
            'customers': 'customers', 'clients': 'customers', 'inventory': 'inventory',
            'vehicles': 'inventory', 'photos': 'photos', 'images': 'photos',
            'calls': 'calls', 'call center': 'calls', 'emails': 'emails', 'email hub': 'emails',
            'vin': 'vin', 'scanner': 'vin', 'chat': 'chat', 'terminal': 'chat', 'ai': 'chat'
        };

        for (const [key, pageId] of Object.entries(navMap)) {
            if (command.includes(key)) {
                const navItem = document.querySelector(`.nav-item[onclick*="'${pageId}'"]`);
                showPage(pageId, navItem);
                addChatMessage('system', `Navigating to ${pageId.charAt(0).toUpperCase() + pageId.slice(1)} page...`);
                executed = true;
                break;
            }
        }
        
        if (!executed) {
            if (command.includes('simulate call')) { simulateNewCall(); executed = true; }
            else if (command.includes('refresh')) { refreshData(); executed = true; }
            else if (command.includes('add customer')) { showPage('customers', document.querySelector(`.nav-item[onclick*="'customers'"]`)); openCustomerForm(); executed = true; }
            else if (command.includes('start camera')) { showPage('photos', document.querySelector(`.nav-item[onclick*="'photos'"]`)); startCamera(); executed = true; }
        }

        if (executed) {
            addChatMessage('assistant', `‚úÖ Command executed: ${command}`);
        } else {
            addChatMessage('assistant', `‚ùì Unrecognized command. Please try again.`);
        }
    };

    recognition.onend = () => {
        isListening = false;
        voiceBtn.innerHTML = 'üéôÔ∏è Voice AI';
        voiceBtn.style.background = '';
    };

    recognition.onerror = (event) => {
        showNotification('error', `Voice recognition error: ${event.error}`);
    };

    if (!isListening) recognition.start();
    else recognition.stop();
}

function simulateNewCall() {
    showNotification('info', 'Simulating incoming AI-processed call...');
    const sampleCalls = [
        { customer: { id: Date.now(), firstName: 'Emily', lastName: 'White', email: 'em.w@example.com', phone: '555-0104' }, summary: 'Wants to know final price for the Toyota Camry including fees. Budget is firm at $34k.', leadScore: 8, duration: 210, value: 34000, vehicleInterest: '2024 Toyota Camry' },
        { customer: { id: Date.now() + 1, firstName: 'David', lastName: 'Green', email: 'd.green@example.com', phone: '555-0105' }, summary: 'Wants to trade in a 2020 Honda CR-V for the Ford F-150. Asks about financing.', leadScore: 7, duration: 450, value: 45000, vehicleInterest: '2024 Ford F-150' },
    ];
    const newCallData = sampleCalls[Math.floor(Math.random() * sampleCalls.length)];

    setTimeout(() => {
        let customer = state.customers.find(c => c.email === newCallData.customer.email);
        if (!customer) {
            customer = { ...newCallData.customer, status: 'new', lastContact: new Date(), value: newCallData.value, vehicleInterest: newCallData.vehicleInterest, leadScore: newCallData.leadScore };
            state.customers.push(customer);
        } else {
            customer.lastContact = new Date();
            customer.status = newCallData.leadScore >= 8 ? 'hot' : 'qualified';
            customer.leadScore = newCallData.leadScore;
        }

        const newComm = { id: Date.now(), customerId: customer.id, type: 'Call', summary: newCallData.summary, duration: newCallData.duration, timestamp: new Date(), status: 'transcribed', leadScore: newCallData.leadScore };
        state.communications.push(newComm);

        renderAll();
        addActivity('üìû', `AI Call Analysis: ${customer.firstName}`, `Lead Score: ${newCallData.leadScore}/10`, 'var(--info)');
        showNotification('success', `New call from ${customer.firstName} processed!`);
        showPage('calls', document.querySelector('.nav-item[onclick*=\'calls\']'));
    }, 1500);
}

function handleAICommand(command) {
    command = command.toLowerCase();
    let response = "I'm not equipped to handle that request. Try asking about 'hot leads', 'stale inventory', or to 'summarize performance'.";

    if (command.includes('summarize') || command.includes('performance')) {
        const hotLeads = state.customers.filter(c => c.status === 'hot').length;
        const callsToday = state.communications.filter(c => c.type === 'Call' && isToday(c.timestamp)).length;
        response = `**Performance Summary:**\n- **Revenue:** Currently at $${(state.metrics.revenue.current / 1000)}K.\n- **Hot Leads:** You have ${hotLeads} high-priority leads.\n- **Calls Today:** I've processed ${callsToday} calls today.\n- **Stale Inventory:** ${state.inventory.filter(i => i.daysInStock > 30).length} vehicles have been in stock for over 30 days.`;
    } else if (command.includes('lead') || command.includes('customer')) {
        const hotLeads = state.customers.filter(c => c.status === 'hot').sort((a,b) => b.lastContact - a.lastContact);
        if (hotLeads.length > 0) {
            response = `**Top Hot Leads:**\n` + hotLeads.slice(0, 3).map(c => `- **${c.firstName} ${c.lastName}**: Interested in the ${c.vehicleInterest}, last contacted ${formatTimeAgo(c.lastContact)}. Score: ${c.leadScore}/10.`).join('\n');
        } else { response = "There are currently no 'hot' leads in the pipeline."; }
    } else if (command.includes('inventory') || command.includes('vehicle')) {
        const staleInventory = state.inventory.filter(i => i.status === 'available').sort((a, b) => b.daysInStock - a.daysInStock);
        if (staleInventory.length > 0) {
            response = `**Stale Inventory Analysis:**\n` + staleInventory.slice(0, 3).map(i => `- **${i.vehicle}**: In stock for ${i.daysInStock} days. Price: $${i.price.toLocaleString()}`).join('\n');
        } else { response = "No available inventory to analyze."; }
    } else if (command.includes('draft') && command.includes('email')) {
        const lastComm = state.communications[state.communications.length - 1];
        if (lastComm) {
            const customer = state.customers.find(c => c.id === lastComm.customerId);
            const template = state.emailTemplates.initial;
            response = `**Draft Email to ${customer.firstName}:**\n\n**Subject:** ${template.subject.replace('{vehicle}', customer.vehicleInterest)}\n\n${template.body.replace('{firstName}', customer.firstName).replace('{vehicle}', customer.vehicleInterest)}`;
        }
    }
    return response;
}

// --- 5. UI EVENT HANDLERS & HELPERS ---
function showPage(pageId, navElement) {
    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId)?.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    navElement?.classList.add('active');
    const titles = { dashboard: 'Executive Dashboard', customers: 'Customer Pipeline', inventory: 'Vehicle Inventory', calls: 'Call Center', emails: 'Email Hub', analytics: 'Performance Analytics', vin: 'VIN Scanner', chat: 'AI Terminal', photos: 'Photo Manager' };
    document.getElementById('contentTitle').textContent = titles[pageId] || 'Dashboard';
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;
    addChatMessage('user', message);
    input.value = '';
    setTimeout(() => { addChatMessage('assistant', handleAICommand(message)); }, 800);
}

function addChatMessage(type, message) {
    const container = document.getElementById('chatMessages');
    const msgDiv = document.createElement('div');
    msgDiv.className = `chat-message ${type}`;
    message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^- /gm, '‚Ä¢ ');
    msgDiv.innerHTML = message.replace(/\n/g, '<br>');
    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
}

function addActivity(icon, title, subtitle, color = 'var(--accent-bright)') {
    state.activityStream.unshift({ icon, title, subtitle, timestamp: new Date(), color });
    renderActivityStream();
}

function refreshData() {
    showNotification('info', 'Syncing with data source...');
    setTimeout(() => { renderAll(); addActivity('üîÑ', 'System Synchronized', 'All data modules updated.', 'var(--success)'); showNotification('success', 'Data refreshed successfully'); }, 1000);
}

function selectAIProvider(provider, card) {
    document.querySelectorAll('.ai-provider-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    state.config.aiProvider = provider;
    updateAIStatus();
}

function updateAIStatus() {
    const apiKey = document.getElementById('aiApiKey').value;
    const statusDot = document.getElementById('aiStatusDot');
    const statusText = document.getElementById('aiStatusText');
    state.config.aiApiKey = apiKey;
    if (state.config.aiProvider && state.config.aiApiKey && state.config.aiApiKey.length > 10) {
        statusDot.classList.add('connected');
        statusText.textContent = `AI Status: Connected to ${state.config.aiProvider.toUpperCase()}`;
    } else if (state.config.aiProvider) {
        statusDot.classList.remove('connected');
        statusText.textContent = `AI Status: ${state.config.aiProvider.toUpperCase()} selected - API Key required`;
    } else { statusDot.classList.remove('connected'); statusText.textContent = 'AI Status: Select a provider'; }
}

function testAIConnection() {
    if (!state.config.aiProvider || !state.config.aiApiKey || state.config.aiApiKey.length < 10) { showNotification('error', 'Please select a provider and enter a valid API key.'); return; }
    showNotification('info', `Pinging ${state.config.aiProvider.toUpperCase()} servers...`);
    setTimeout(() => { addChatMessage('system', `‚úÖ AI connection to ${state.config.aiProvider.toUpperCase()} successful.`); showNotification('success', 'Connection successful!'); }, 1500);
}

function saveAIConfig() {
     if (!state.config.aiProvider || !state.config.aiApiKey || state.config.aiApiKey.length < 10) { showNotification('error', 'Cannot save incomplete configuration.'); return; }
     addActivity('üíæ', 'Configuration Saved', `AI Provider set to ${state.config.aiProvider.toUpperCase()}`, 'var(--success)');
     showNotification('success', 'AI Configuration has been saved.');
}

// --- FULLY FUNCTIONAL PAGE COMPONENTS ---

function buildFullCustomerForm() {
    const container = document.getElementById('addCustomerForm');
    container.innerHTML = `<div class="widget-header" style="margin: 0 0 24px 0;"><div class="widget-title">Add New Customer</div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"><div class="form-group"><label class="form-label">First Name</label><input type="text" id="newCustomerFirstName" class="form-input"></div><div class="form-group"><label class="form-label">Last Name</label><input type="text" id="newCustomerLastName" class="form-input"></div><div class="form-group"><label class="form-label">Email</label><input type="email" id="newCustomerEmail" class="form-input"></div><div class="form-group"><label class="form-label">Phone</label><input type="tel" id="newCustomerPhone" class="form-input"></div></div><div class="form-group"><label class="form-label">Vehicle Interest</label><input type="text" id="newCustomerVehicleInterest" class="form-input"></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"><div class="form-group"><label class="form-label">Status</label><select id="newCustomerStatus" class="form-select"><option value="new">New</option><option value="follow">Follow Up</option><option value="qualified">Qualified</option><option value="hot">Hot</option></select></div><div class="form-group"><label class="form-label">Potential Value ($)</label><input type="number" id="newCustomerValue" class="form-input"></div></div><div style="display: flex; gap: 12px; margin-top: 20px;"><button class="btn btn-primary" onclick="addCustomer()" style="flex: 1;">Add Customer</button><button class="btn btn-secondary" onclick="closeCustomerForm()" style="flex: 1;">Cancel</button></div>`;
}
function openCustomerForm() { document.getElementById('addCustomerForm').style.display = 'block'; }
function closeCustomerForm() { document.getElementById('addCustomerForm').style.display = 'none'; }
function addCustomer() {
    const newCustomer = {
        id: Date.now(), firstName: document.getElementById('newCustomerFirstName').value || 'N/A', lastName: document.getElementById('newCustomerLastName').value || 'N/A', email: document.getElementById('newCustomerEmail').value || 'N/A', phone: document.getElementById('newCustomerPhone').value || 'N/A', status: document.getElementById('newCustomerStatus').value, value: parseInt(document.getElementById('newCustomerValue').value) || 0, vehicleInterest: document.getElementById('newCustomerVehicleInterest').value || 'N/A', lastContact: new Date(), leadScore: 5
    };
    state.customers.push(newCustomer);
    addActivity('üë•', `Customer Added: ${newCustomer.firstName}`, `Manually added to pipeline.`, 'var(--success)');
    renderAll();
    closeCustomerForm();
    showNotification('success', 'New customer added successfully!');
}

// Photo Manager
function populateVehicleSelect() { const select = document.getElementById('vehicleSelect'); select.innerHTML = '<option value="">Choose vehicle...</option>'; state.inventory.filter(v => v.status === 'available').forEach(v => { const option = document.createElement('option'); option.value = v.id; option.textContent = v.vehicle; select.appendChild(option); }); }
async function startCamera() { if (cameraStream) stopCamera(); try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); const video = document.getElementById('cameraFeed'); video.srcObject = cameraStream; video.style.display = 'block'; document.getElementById('cameraPlaceholder').style.display = 'none'; document.getElementById('captureBtn').disabled = false; showNotification('success', 'Camera activated.'); } catch (err) { showNotification('error', 'Could not access camera.'); console.error("Camera Error:", err); } }
function stopCamera() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; document.getElementById('cameraFeed').style.display = 'none'; document.getElementById('cameraPlaceholder').style.display = 'flex'; document.getElementById('captureBtn').disabled = true; showNotification('info', 'Camera deactivated.'); } }
function capturePhoto() { const vehicleId = document.getElementById('vehicleSelect').value; if (!vehicleId) { showNotification('error', 'Please select a vehicle first.'); return; } const canvas = document.getElementById('photoCanvas'); const video = document.getElementById('cameraFeed'); canvas.width = video.videoWidth; canvas.height = video.videoHeight; canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg'); const photo = { id: Date.now(), vehicleId: parseInt(vehicleId), dataUrl }; state.vehiclePhotos.push(photo); const vehicle = state.inventory.find(v => v.id === parseInt(vehicleId)); if (vehicle) vehicle.photoCount++; renderAll(); showNotification('success', `Photo captured for ${vehicle.vehicle}`); }
function updatePhotoDisplay() { const gallery = document.getElementById('photoGallery'); gallery.innerHTML = ''; if (state.vehiclePhotos.length === 0) { gallery.innerHTML = `<div style="color: var(--text-muted); text-align: center; grid-column: 1 / -1;">No photos captured.</div>`; return; } state.vehiclePhotos.forEach(photo => { const item = document.createElement('div'); item.className = 'photo-item'; item.innerHTML = `<img src="${photo.dataUrl}" alt="Vehicle Photo">`; gallery.appendChild(item); }); }

// VIN Scanner
function scanVIN() { const vin = document.getElementById('vinInput').value.toUpperCase(); const resultDiv = document.getElementById('vinResult'); if (vin.length !== 17) { showNotification('error', 'Please enter a valid 17-character VIN.'); return; } resultDiv.style.display = 'block'; resultDiv.innerHTML = `<div style="text-align: center; color: var(--info);">Decoding VIN...</div>`; setTimeout(() => { const sampleData = { '1HGBH41JXMN109186': { make: 'Honda', model: 'Accord', year: '2022', engine: '1.5L I4 Turbo' }, '3HGBH41JXMN109188': { make: 'Ford', model: 'F-150', year: '2024', engine: '3.5L V6 EcoBoost' } }; const data = sampleData[vin] || { make: 'Unknown', model: 'Unknown', year: 'N/A', engine: 'N/A' }; resultDiv.innerHTML = `<div class="vin-result-grid"><div><div class="vin-field-label">Make</div><div class="vin-field-value">${data.make}</div></div><div><div class="vin-field-label">Model</div><div class="vin-field-value">${data.model}</div></div><div><div class="vin-field-label">Year</div><div class="vin-field-value">${data.year}</div></div><div><div class="vin-field-label">Engine</div><div class="vin-field-value">${data.engine}</div></div></div>`; addActivity('üîç', 'VIN Decoded', `${data.year} ${data.make} ${data.model}`, 'var(--info)'); }, 1200); }

// Email Templates
function loadEmailTemplate() { const type = document.getElementById('templateType').value; const template = state.emailTemplates[type]; document.getElementById('emailSubject').value = template.subject; document.getElementById('emailBody').value = template.body; }
function saveEmailTemplate() { const type = document.getElementById('templateType').value; state.emailTemplates[type].subject = document.getElementById('emailSubject').value; state.emailTemplates[type].body = document.getElementById('emailBody').value; showNotification('success', 'Email template saved!'); addActivity('üíæ', 'Template Saved', `${type.charAt(0).toUpperCase() + type.slice(1)} template updated.`, 'var(--success)'); }

// --- UTILITY HELPERS ---
function formatTimeAgo(date) { const seconds = Math.floor((new Date() - new Date(date)) / 1000); if (seconds < 60) return "Just now"; const intervals = { 'year': 31536000, 'month': 2592000, 'day': 86400, 'hour': 3600, 'minute': 60 }; for (let unit in intervals) { let interval = seconds / intervals[unit]; if (interval > 1) { const val = Math.floor(interval); return `${val} ${unit}${val > 1 ? 's' : ''} ago`; } } }
function isToday(someDate) { const today = new Date(); const d = new Date(someDate); return d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear(); }
function getScoreClass(score) { if (score >= 8) return 'score-high'; if (score >= 6) return 'score-medium'; return 'score-low'; }
function formatDuration(seconds) { if (!seconds) return 'N/A'; const min = Math.floor(seconds / 60); const sec = seconds % 60; return `${min}m ${sec}s`; }
function showMetricDetails(metric) { showNotification('info', `Loading deep dive for ${metric}...`); showPage('analytics', document.querySelector('.nav-item[onclick*="analytics"]')); }

// --- [END] JAVASCRIPT ENGINE ---
</script>
</body>
</html>
