<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>TVC Auto AI Pro - Advanced Dealership Intelligence Terminal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* ====== THEME ====== */
    :root {
      --bg-primary:#0a0a0a; --bg-secondary:#141418; --bg-tertiary:#1e1e24; --bg-quaternary:#28282f; --bg-hover:#32323a;
      --accent-primary:#8b6914; --accent-secondary:#6b5210; --accent-tertiary:#a57c1e; --accent-glow:rgba(139,105,20,.3); --accent-bright:#b8901f;
      --text-primary:#f5f5f7; --text-secondary:#a1a1aa; --text-muted:#71717a;
      --border-color:#27272a; --border-accent:#3f3f46; --glass-bg:rgba(20,20,24,.8); --glass-border:rgba(255,255,255,.1);
      --success:#10b981; --warning:#f59e0b; --error:#ef4444; --info:#3b82f6;
      --shadow-sm:0 1px 2px rgba(0,0,0,.5); --shadow-md:0 4px 6px rgba(0,0,0,.3); --shadow-lg:0 10px 15px rgba(0,0,0,.4); --shadow-xl:0 20px 25px rgba(0,0,0,.5);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
      background:linear-gradient(135deg,#0a0a0a 0%,#141418 100%);
      color:var(--text-primary); line-height:1.5; overflow-x:hidden; font-size:13px; min-height:100vh;
    }
    body::before{
      content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        radial-gradient(circle at 20% 50%, var(--accent-glow) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(16,185,129,.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(59,130,246,.05) 0%, transparent 50%);
    }
    .terminal-container{
      display:grid; grid-template-columns:260px 1fr; grid-template-rows:65px 1fr; height:100vh; gap:1px; background:var(--border-color); position:relative; z-index:1;
    }
    .top-bar{
      grid-column:1 / -1; background:var(--glass-bg); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
      border-bottom:1px solid var(--glass-border); display:flex; align-items:center; justify-content:space-between; padding:0 24px; box-shadow:var(--shadow-md);
    }
    .logo-section{display:flex; align-items:center; gap:14px}
    .logo-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary)); box-shadow:0 0 20px var(--accent-glow), var(--shadow-md)}
    .logo-text{font-size:17px;font-weight:700;background:linear-gradient(135deg,var(--text-primary),var(--accent-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .market-data{display:flex;align-items:center;gap:28px;font-size:12px}
    .market-item{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border-color);transition:.3s}
    .market-item:hover{transform:translateY(-2px);border-color:var(--accent-primary);box-shadow:0 4px 12px var(--accent-glow)}
    .market-value{font-weight:600}
    .market-change{font-weight:500;padding:2px 6px;border-radius:4px;font-size:11px}
    .positive{color:var(--success);background:rgba(16,185,129,.1)}
    .negative{color:var(--error);background:rgba(239,68,68,.1)}
    .top-actions{display:flex;align-items:center;gap:12px}
    .status-indicator{display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;color:var(--success);padding:6px 12px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:20px}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--success);box-shadow:0 0 10px var(--success)}
    .btn{padding:9px 18px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:.3s;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary));color:#fff;box-shadow:0 4px 15px var(--accent-glow)}
    .btn-primary:hover{transform:translateY(-2px)}
    .btn-secondary{background:var(--bg-quaternary);color:var(--text-secondary);border:1px solid var(--border-accent)}
    .btn-secondary:hover{background:var(--bg-hover);color:var(--text-primary);transform:translateY(-2px)}
    .btn-sm{padding:5px 10px;font-size:11px}
    .btn-glass{background:var(--glass-bg);backdrop-filter:blur(10px);border:1px solid var(--glass-border);color:var(--text-primary)}
    .sidebar{background:var(--bg-secondary);border-right:1px solid var(--border-color);padding:20px 12px;overflow:auto}
    .nav-section{margin-bottom:24px}
    .nav-title{font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;padding:0 12px;display:flex;align-items:center;gap:8px}
    .nav-title::after{content:'';flex:1;height:1px;background:var(--border-color)}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;cursor:pointer;transition:.3s;margin-bottom:4px;font-size:12px;font-weight:500;color:var(--text-secondary)}
    .nav-item:hover{background:var(--bg-tertiary);color:var(--text-primary);transform:translateX(4px)}
    .nav-item.active{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:#fff;box-shadow:0 4px 15px var(--accent-glow)}
    .nav-badge{margin-left:auto;background:var(--error);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:12px;min-width:18px;text-align:center}
    .main-content{background:var(--bg-primary);overflow:hidden;display:flex;flex-direction:column}
    .content-header{background:var(--glass-bg);backdrop-filter:blur(10px);border-bottom:1px solid var(--border-color);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .content-title{font-size:20px;font-weight:700;display:flex;align-items:center;gap:12px}
    .content-body{flex:1;padding:20px;overflow:auto;background:linear-gradient(180deg,transparent,rgba(139,105,20,.02))}
    .page-content{display:none;animation:fade .4s ease}
    .page-content.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .dashboard-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:24px}
    .metric-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px;transition:.3s;position:relative}
    .metric-card:hover{border-color:var(--accent-primary);background:var(--bg-tertiary);transform:translateY(-4px);box-shadow:0 10px 30px rgba(139,105,20,.2)}
    .metric-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .metric-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase}
    .metric-trend{font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px}
    .trend-up{background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.3)}
    .metric-value{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--text-primary),var(--accent-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .data-table-container{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;overflow:hidden;margin-bottom:20px;box-shadow:var(--shadow-md)}
    .table-header{background:var(--bg-tertiary);padding:16px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .table-title{font-size:15px;font-weight:700}
    .data-table{width:100%;border-collapse:collapse}
    .data-table th{background:var(--bg-quaternary);padding:12px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border-color)}
    .data-table td{padding:14px 16px;border-bottom:1px solid var(--border-color);font-size:12px}
    .status-badge{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase;display:inline-block}
    .status-hot{background:rgba(239,68,68,.15);color:var(--error);border:1px solid rgba(239,68,68,.4)}
    .status-qualified{background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.4)}
    .status-follow,.status-new{background:rgba(245,158,11,.15);color:var(--warning);border:1px solid rgba(245,158,11,.4)}
    /* lead score chips */
    .lead-score{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;display:inline-block}
    .score-high{background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.4)}
    .score-medium{background:rgba(245,158,11,.15);color:var(--warning);border:1px solid rgba(245,158,11,.4)}
    .score-low{background:rgba(239,68,68,.15);color:var(--error);border:1px solid rgba(239,68,68,.4)}
    .form-container{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:24px;max-width:650px;margin:0 auto;box-shadow:var(--shadow-lg)}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:12px;font-weight:600;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
    .form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:13px}
    .chat-container{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;height:550px;display:flex;flex-direction:column;max-width:850px;margin:0 auto;box-shadow:var(--shadow-xl);overflow:hidden}
    .chat-messages{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:16px;background:linear-gradient(180deg,var(--bg-secondary),var(--bg-tertiary))}
    .chat-message{max-width:70%;padding:14px 18px;border-radius:12px;font-size:13px}
    .chat-message.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary));color:#fff}
    .chat-message.assistant{align-self:flex-start;background:var(--bg-quaternary);border:1px solid var(--border-accent)}
    @media (max-width:1200px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:768px){.terminal-container{grid-template-columns:1fr}.sidebar{display:none}.dashboard-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="terminal-container">
    <!-- ============ TOP BAR ============ -->
    <div class="top-bar">
      <div class="logo-section">
        <div class="logo-icon">‚ö°</div>
        <div class="logo-text">TVC Auto AI Pro</div>
      </div>
      <div class="market-data">
        <div class="market-item"><span>Revenue</span><span class="market-value" id="topBarRevenue">$487K</span><span class="market-change positive" id="topBarRevenueChange">+12%</span></div>
        <div class="market-item"><span>Leads</span><span class="market-value" id="topBarLeads">0</span><span class="market-change positive" id="topBarLeadsChange">+0</span></div>
        <div class="market-item"><span>Calls</span><span class="market-value" id="topBarCalls">12</span><span class="market-change positive" id="topBarCallsChange">+3</span></div>
        <div class="market-item"><span>Service</span><span class="market-value" id="topBarService">8</span><span class="market-change positive" id="topBarServiceChange">+2</span></div>
      </div>
      <div class="top-actions">
        <div class="status-indicator"><div class="status-dot"></div><span>LIVE DATA</span></div>
        <button class="btn btn-glass" id="voiceBtn" onclick="toggleVoice()">üé§ Voice</button>
        <button class="btn btn-primary" onclick="showPage('chat', document.querySelector('.nav-item[onclick*=\'chat\']'))">ü§ñ AI Terminal</button>
      </div>
    </div>

    <!-- ============ SIDEBAR ============ -->
    <div class="sidebar">
      <div class="nav-section">
        <div class="nav-title">Overview</div>
        <div class="nav-item active" onclick="showPage('dashboard', this)"><div class="nav-icon">üìä</div>Dashboard</div>
        <div class="nav-item" onclick="showPage('analytics', this)"><div class="nav-icon">üìà</div>Analytics</div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Operations</div>
        <div class="nav-item" onclick="showPage('customers', this)"><div class="nav-icon">üë•</div>Customers<div class="nav-badge" id="customerBadge">0</div></div>
        <div class="nav-item" onclick="showPage('inventory', this)"><div class="nav-icon">üöó</div>Inventory<div class="nav-badge" id="inventoryBadge" style="background:var(--success);">0</div></div>
        <div class="nav-item" onclick="showPage('service', this)"><div class="nav-icon">üîß</div>Service Center<div class="nav-badge" id="serviceBadge" style="background:var(--warning);">0</div></div>
        <div class="nav-item" onclick="showPage('photos', this)"><div class="nav-icon">üì∏</div>Photo Manager<div class="nav-badge" id="photoBadge" style="background:var(--accent-primary);">0</div></div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Communication</div>
        <div class="nav-item" onclick="showPage('calls', this)"><div class="nav-icon">üìû</div>Call Center<div class="nav-badge" id="callBadge" style="background:var(--accent-primary);">0</div></div>
        <div class="nav-item" onclick="showPage('emails', this)"><div class="nav-icon">üìß</div>Email Center<div class="nav-badge" id="emailBadge" style="background:var(--success);">0</div></div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Intelligence</div>
        <div class="nav-item" onclick="showPage('vin', this)"><div class="nav-icon">üîç</div>VIN Scanner</div>
        <div class="nav-item" onclick="showPage('chat', this)"><div class="nav-icon">ü§ñ</div>AI Terminal</div>
      </div>
    </div>

    <!-- ============ MAIN CONTENT ============ -->
    <div class="main-content">
      <div class="content-header">
        <div class="content-title" id="contentTitle">Executive Dashboard</div>
        <div class="content-actions">
          <button class="btn btn-glass" onclick="exportData()">üìä Export</button>
          <button class="btn btn-glass" onclick="refreshData()">üîÑ Refresh</button>
        </div>
      </div>

      <div class="content-body">
        <!-- DASHBOARD -->
        <div id="dashboard" class="page-content active">
          <div class="dashboard-grid">
            <div class="metric-card" onclick="showMetricDetails('revenue')">
              <div class="metric-header"><div class="metric-label">Total Revenue</div><div class="metric-trend trend-up" id="dashboardRevenueTrend">+12%</div></div>
              <div class="metric-value" id="dashboardRevenue">$487K</div>
              <div class="metric-subtitle" id="dashboardRevenueSubtitle">vs $435K last month</div>
            </div>
            <div class="metric-card" onclick="showMetricDetails('leads')">
              <div class="metric-header"><div class="metric-label">Active Leads</div><div class="metric-trend trend-up" id="dashboardLeadsTrend">+33%</div></div>
              <div class="metric-value" id="dashboardLeads">0</div>
              <div class="metric-subtitle" id="dashboardLeadsSubtitle">pipeline</div>
            </div>
            <div class="metric-card" onclick="showMetricDetails('service')">
              <div class="metric-header"><div class="metric-label">Service Orders</div><div class="metric-trend trend-up" id="dashboardServiceTrend">+25%</div></div>
              <div class="metric-value" id="dashboardService">0</div>
              <div class="metric-subtitle" id="dashboardServiceSubtitle">active ‚Ä¢ pending</div>
            </div>
            <div class="metric-card" onclick="showMetricDetails('saleTime')">
              <div class="metric-header"><div class="metric-label">Avg Sale Time</div><div class="metric-trend trend-up">-7d</div></div>
              <div class="metric-value" id="dashboardSaleTime">14</div>
              <div class="metric-subtitle" id="dashboardSaleTimeSubtitle">days (industry: 21d)</div>
            </div>
          </div>

          <div class="data-table-container">
            <div class="table-header"><div class="table-title">Live Activity</div></div>
            <div id="activityFeedContent" style="max-height:320px; overflow:auto; padding:10px 0 0 0;">
              <div style="padding:14px 18px; color:var(--text-muted);">System ready.</div>
            </div>
          </div>
        </div>

        <!-- SERVICE -->
        <div id="service" class="page-content">
          <div class="data-table-container">
            <div class="table-header">
              <div class="table-title">Service Work Orders</div>
              <button class="btn btn-primary" onclick="createServiceOrder()">+ New Service Order</button>
            </div>
            <table class="data-table" id="serviceTable">
              <thead>
                <tr><th>Order #</th><th>Vehicle</th><th>Customer</th><th>Service Type</th><th>Technician</th><th>Status</th><th>Est. Cost</th><th>Actions</th></tr>
              </thead>
              <tbody id="serviceTableBody"></tbody>
            </table>
          </div>

          <div id="serviceOrderForm" class="form-container" style="display:none; margin-top:20px;">
            <div class="table-header" style="margin:0 0 20px 0;"><div class="table-title">Create Service Order</div></div>
            <div class="form-group"><label class="form-label">Vehicle</label><select id="serviceVehicle" class="form-select"><option value="">Select vehicle...</option></select></div>
            <div class="form-group"><label class="form-label">Service Type</label><select id="serviceType" class="form-select"><option value="reconditioning">Reconditioning</option><option value="oil-change">Oil Change</option><option value="inspection">Inspection</option><option value="brake-service">Brake Service</option><option value="tire-rotation">Tire Rotation</option><option value="major-repair">Major Repair</option><option value="warranty">Warranty Service</option></select></div>
            <div class="form-group"><label class="form-label">Priority</label><select id="servicePriority" class="form-select"><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div>
            <div class="form-group"><label class="form-label">Notes</label><textarea id="serviceNotes" class="form-textarea" rows="4" placeholder="Service notes..."></textarea></div>
            <button class="btn btn-primary" onclick="submitServiceOrder()" style="width:100%;">Create Order</button>
            <button class="btn btn-secondary" onclick="closeServiceForm()" style="width:100%; margin-top:10px;">Cancel</button>
          </div>
        </div>

        <!-- AI TERMINAL -->
        <div id="chat" class="page-content">
          <div class="form-container" style="margin-bottom:20px;">
            <div class="table-header" style="margin:0 0 12px 0;"><div class="table-title">AI Configuration</div></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
              <div class="form-group"><label class="form-label">AI API Key</label><input type="password" id="aiApiKey" class="form-input" placeholder="Enter your OpenAI key (sk-‚Ä¶)" onchange="updateAIStatus()"></div>
              <div class="form-group"><label class="form-label">OpenPhone API Key</label><input type="password" id="openphoneApiKey" class="form-input" placeholder="Enter OpenPhone API key..." onchange="updateOpenPhoneStatus()"></div>
            </div>
            <div style="display:flex; gap:10px;"><button class="btn btn-primary" onclick="testAIConnection()">üîó Test AI</button><button class="btn btn-primary" onclick="testOpenPhoneConnection()">üìû Test OpenPhone</button><button class="btn btn-glass" onclick="saveAIConfig()">üíæ Save Configuration</button></div>
            <div style="margin-top:10px; display:flex; align-items:center; gap:10px;"><div id="aiStatusDot" style="width:10px;height:10px;border-radius:50%;background:var(--error);"></div><div id="aiStatusText">AI Status: API Key Required</div></div>
          </div>

          <div class="chat-container">
            <div class="table-header"><div class="table-title">AI Terminal Interface</div><div style="font-size:11px;color:var(--text-muted);">Try: ‚Äúshow customers‚Äù, ‚Äúsearch customers for dennis‚Äù, ‚Äúopen inventory‚Äù</div></div>
            <div class="chat-messages" id="chatMessages">
              <div class="chat-message assistant">ü§ñ <strong>TVC AI</strong> is online.</div>
            </div>
            <div style="padding:20px; border-top:1px solid var(--border-color); display:flex; gap:12px; background:var(--bg-tertiary);">
              <input type="text" id="chatInput" class="form-input" placeholder="Ask for insights..." onkeypress="if(event.key==='Enter') sendMessage()">
              <button class="btn btn-primary" onclick="sendMessage()">Execute</button>
            </div>
          </div>
        </div>

        <!-- CUSTOMERS -->
        <div id="customers" class="page-content">
          <div class="data-table-container">
            <div class="table-header">
              <div class="table-title">Customer Pipeline Management</div>
              <div style="display:flex; gap:8px; align-items:center;">
                <input type="text" id="customerSearch" class="form-input" placeholder="Search name, email, or phone..." style="width:280px;" oninput="filterCustomers()" />
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('customerSearch').value=''; filterCustomers();">Clear</button>
                <button class="btn btn-primary" onclick="openCustomerForm()">+ Add Customer</button>
              </div>
            </div>
            <table class="data-table" id="customerTable">
              <thead>
                <tr>
                  <th>Customer</th><th>Contact</th><th>Status</th><th>Lead Score</th><th>Potential Value</th><th>Interest</th><th>Last Contact</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="customerTableBody">
                <tr><td colspan="8" style="color:var(--text-muted); padding:16px;">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <div id="addCustomerForm" class="form-container" style="display:none; margin-top:20px;">
            <div class="table-header" style="margin:0 0 20px 0;"><div class="table-title">Add New Customer</div></div>
            <div class="form-group"><label class="form-label">Name</label><input type="text" id="newCustomerName" class="form-input" placeholder="John Smith" required></div>
            <div class="form-group"><label class="form-label">Address</label><input type="text" id="newCustomerAddress" class="form-input" placeholder="123 Main St, City, ST"></div>
            <div class="form-group"><label class="form-label">Email</label><input type="email" id="newCustomerEmail" class="form-input" placeholder="john@example.com"></div>
            <div class="form-group"><label class="form-label">Phone</label><input type="tel" id="newCustomerPhone" class="form-input" placeholder="555-123-4567"></div>
            <div class="form-group"><label class="form-label">Vehicle of Interest</label><input type="text" id="newCustomerVehicleInterest" class="form-input" placeholder="2024 BMW X5"></div>
            <div class="form-group"><label class="form-label">Current Vehicle</label><input type="text" id="newCustomerCurrentVehicle" class="form-input" placeholder="2018 Honda Accord"></div>
            <div class="form-group"><label class="form-label">Budget</label><input type="text" id="newCustomerBudget" class="form-input" placeholder="$50,000‚Äì$70,000"></div>
            <div class="form-group"><label class="form-label">Status</label>
              <select id="newCustomerStatus" class="form-select">
                <option value="new">New Inquiry</option><option value="hot">Hot Lead</option><option value="qualified">Qualified</option><option value="follow">Follow Up</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="addCustomer()" style="width:100%;">Add Customer</button>
            <button class="btn btn-secondary" onclick="closeCustomerForm()" style="width:100%; margin-top:10px;">Cancel</button>
          </div>
        </div>

        <!-- INVENTORY -->
        <div id="inventory" class="page-content">
          <div class="data-table-container">
            <div class="table-header">
              <div class="table-title">Vehicle Inventory Management</div>
              <div style="display:flex; gap:8px;">
                <input type="text" id="inventoryFilter" class="form-input" placeholder="Filter..." style="width:200px;" oninput="filterInventory()">
                <button class="btn btn-primary" onclick="openVehicleForm()">+ Add Vehicle</button>
              </div>
            </div>
            <table class="data-table" id="inventoryTable">
              <thead><tr><th>Vehicle</th><th>VIN</th><th>Status</th><th>Price</th><th>Days in Stock</th><th>Service Status</th><th>Actions</th></tr></thead>
              <tbody id="inventoryTableBody"></tbody>
            </table>
          </div>

          <div id="addVehicleForm" class="form-container" style="display:none; margin-top:20px;">
            <div class="table-header" style="margin:0 0 20px 0;"><div class="table-title">Add New Vehicle</div></div>
            <div class="form-group"><label class="form-label">VIN</label>
              <div style="display:flex; gap:8px;"><input type="text" id="newVehicleVIN" class="form-input" placeholder="Enter 17-character VIN" maxlength="17"><button class="btn btn-primary" onclick="decodeVIN()">Decode</button></div>
            </div>
            <div class="form-group"><label class="form-label">Make</label><input type="text" id="newVehicleMake" class="form-input" placeholder="Toyota"></div>
            <div class="form-group"><label class="form-label">Model</label><input type="text" id="newVehicleModel" class="form-input" placeholder="Camry"></div>
            <div class="form-group"><label class="form-label">Year</label><input type="number" id="newVehicleYear" class="form-input" placeholder="2024"></div>
            <div class="form-group"><label class="form-label">Price</label><input type="number" id="newVehiclePrice" class="form-input" placeholder="32000"></div>
            <div class="form-group"><label class="form-label">Status</label>
              <select id="newVehicleStatus" class="form-select"><option value="available">Available</option><option value="reserved">Reserved</option><option value="sold">Sold</option><option value="incoming">Incoming</option></select>
            </div>
            <button class="btn btn-primary" onclick="addVehicle()" style="width:100%;">Add Vehicle</button>
            <button class="btn btn-secondary" onclick="closeVehicleForm()" style="width:100%; margin-top:10px;">Cancel</button>
          </div>
        </div>

        <!-- PHOTOS -->
        <div id="photos" class="page-content">
          <div class="form-container">
            <div class="table-header" style="margin:0 0 16px 0;"><div class="table-title">Vehicle Photo Management</div></div>
            <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="startCamera()">üì∑ Start Camera</button>
              <button class="btn btn-secondary" onclick="stopCamera()">‚èπÔ∏è Stop Camera</button>
              <button class="btn btn-primary" onclick="capturePhoto()" id="captureBtn" disabled>üì∏ Capture</button>
              <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileUpload(event)">
              <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üìÅ Upload</button>
            </div>
            <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
              <video id="cameraFeed" style="display:none; width:320px; height:240px; background:var(--bg-tertiary); border:2px solid var(--border-accent); border-radius:12px;" autoplay playsinline></video>
              <canvas id="photoCanvas" style="display:none;"></canvas>
              <div>
                <div class="form-group"><label class="form-label">Select Vehicle</label><select id="vehicleSelect" class="form-select"><option value="">Choose vehicle...</option></select></div>
                <div class="form-group"><label class="form-label">Photo Type</label><select id="photoType" class="form-select"><option value="exterior">Exterior</option><option value="interior">Interior</option><option value="engine">Engine</option><option value="damage">Damage/Issues</option></select></div>
              </div>
            </div>
          </div>
          <div class="data-table-container">
            <div class="table-header"><div class="table-title">Photo Gallery</div></div>
            <div id="photoGallery" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:16px; padding:16px;">
              <div style="grid-column:1 / -1; text-align:center; color:var(--text-muted); padding:40px;">No photos yet. Use the camera or upload button to add photos.</div>
            </div>
          </div>
        </div>

        <!-- CALLS -->
        <div id="calls" class="page-content">
          <div class="data-table-container">
            <div class="table-header"><div class="table-title">Call History & Transcripts</div><button class="btn btn-primary" onclick="simulateNewCall()">üìû Simulate Call</button></div>
            <table class="data-table" id="callTable">
              <thead><tr><th>Date/Time</th><th>Phone Number</th><th>Customer</th><th>Duration</th><th>Lead Score</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="callTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- EMAILS -->
        <div id="emails" class="page-content">
          <div class="data-table-container">
            <div class="table-header"><div class="table-title">Email Campaign History</div><button class="btn btn-primary" onclick="createEmailCampaign()">‚úâÔ∏è New Campaign</button></div>
            <table class="data-table" id="emailTable">
              <thead><tr><th>Date</th><th>Recipient</th><th>Subject</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="emailTableBody"></tbody>
            </table>
          </div>
          <div class="form-container">
            <div class="table-header" style="margin:0 0 16px 0;"><div class="table-title">Email Templates</div></div>
            <div class="form-group"><label class="form-label">Template Type</label><select id="templateType" class="form-select"><option value="follow-up">Follow-up</option><option value="service">Service Reminder</option><option value="promotion">Promotion</option></select></div>
            <div class="form-group"><label class="form-label">Subject</label><input type="text" id="emailSubject" class="form-input" placeholder="Email subject..."></div>
            <div class="form-group"><label class="form-label">Body</label><textarea id="emailBody" class="form-textarea" rows="6" placeholder="Email content..."></textarea></div>
            <button class="btn btn-primary" onclick="SaveEmailTemplate()">üíæ Save Template</button>
          </div>
        </div>

        <!-- VIN -->
        <div id="vin" class="page-content">
          <div class="form-container">
            <div class="table-header" style="margin:0 0 20px 0;"><div class="table-title">VIN Intelligence Scanner</div><div style="font-size:11px;color:var(--text-muted);">Powered by NHTSA API</div></div>
            <div class="form-group"><label class="form-label">Vehicle Identification Number</label><input type="text" id="vinInput" class="form-input" placeholder="Enter 17-character VIN" maxlength="17"></div>
            <button class="btn btn-primary" onclick="scanVIN()" style="width:100%;">üîç Decode VIN</button>
            <div id="vinResult" style="display:none;"><div style="margin-top:20px; background:linear-gradient(135deg, var(--bg-tertiary), var(--bg-quaternary)); border:1px solid var(--accent-primary); border-radius:12px; padding:20px;"><div id="vinData"></div></div></div>
          </div>
        </div>

        <!-- ANALYTICS -->
        <div id="analytics" class="page-content">
          <div class="dashboard-grid">
            <div class="metric-card"><div class="metric-header"><div class="metric-label">Revenue Growth</div><div class="metric-trend trend-up">+18.2%</div></div><div class="metric-value">üìà</div><div class="metric-subtitle">YoY performance</div></div>
            <div class="metric-card"><div class="metric-header"><div class="metric-label">Service Revenue</div><div class="metric-trend trend-up">+22%</div></div><div class="metric-value">$47.5K</div><div class="metric-subtitle">This month</div></div>
            <div class="metric-card"><div class="metric-header"><div class="metric-label">Customer Satisfaction</div><div class="metric-trend trend-up">+2%</div></div><div class="metric-value">96%</div><div class="metric-subtitle">Excellent rating</div></div>
            <div class="metric-card"><div class="metric-header"><div class="metric-label">Market Share</div><div class="metric-trend trend-up">+1.3%</div></div><div class="metric-value">15.2%</div><div class="metric-subtitle">Regional market</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ APP SCRIPT ============ -->
  <script>
    /* ====== STATE ====== */
    let cameraStream=null, isListening=false, currentAIProvider='openai', aiApiKey=null, openphoneApiKey=null, vehiclePhotos=[];
    let dashboardMetrics={revenue:{value:487000,change:.12,prevValue:435000},leads:{value:0,change:1,prevValue:0},service:{value:0,change:2,prevValue:0},saleTime:{value:14,change:-7,prevValue:21},calls:{value:0,change:3,prevValue:0}};
    let customers=[]; window.customers = customers;
    let inventory=[]; window.inventory = inventory;
    let serviceOrders=[]; window.serviceOrders = serviceOrders;

    let callHistory=[]; let emailHistory=[
      {id:1,date:new Date(),recipient:'john@email.com',subject:'Your BMW X5 Inquiry',type:'follow-up',status:'delivered'}
    ];

    /* ====== INIT ====== */
    document.addEventListener('DOMContentLoaded', async () => {
      initVoice();
      await Promise.all([loadCustomersFromDB(), loadInventoryFromDB(), loadServiceFromDB()]);
      renderServiceTable(); renderCustomerTable(); renderInventoryTable();
      renderCallTable(); renderEmailTable(); populateVehicleDropdowns();
      updateDashboardMetrics();
    });

    /* ====== UTILS ====== */
    const formatCurrency=v=>'$'+Number(v||0).toLocaleString();
    function getLeadScoreClass(s){if(s>=8)return'score-high';if(s>=6)return'score-medium';return'score-low';}
    function addActivity(icon,title,time){const feed=document.getElementById('activityFeedContent');if(!feed)return;const item=document.createElement('div');item.style.padding='14px 18px';item.innerHTML=`${icon} ${title} <span style="color:var(--text-muted);float:right">${time||'Just now'}</span>`;feed.prepend(item);while(feed.children.length>10)feed.removeChild(feed.lastChild);}

    /* ====== NAV ====== */
    function showPage(pageId, el){
      document.querySelectorAll('.page-content').forEach(p=>p.classList.remove('active'));
      document.getElementById(pageId)?.classList.add('active');
      document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
      if(el) el.classList.add('active');
      const titles={dashboard:'Executive Dashboard',service:'Service Center Operations',customers:'Customer Pipeline',inventory:'Inventory Management',photos:'Photo Manager',vin:'VIN Intelligence',analytics:'Performance Analytics',chat:'AI Terminal',calls:'Call Center Management',emails:'Email Campaign Center'};
      document.getElementById('contentTitle').textContent=titles[pageId]||'Dashboard';
      if(pageId==='photos') populateVehicleDropdowns();
    }

    /* ====== DASHBOARD ====== */
    function updateDashboardMetrics(){
      document.getElementById('topBarRevenue').textContent=formatCurrency(dashboardMetrics.revenue.value);
      document.getElementById('topBarRevenueChange').textContent=`+${dashboardMetrics.revenue.change*100}%`;
      document.getElementById('topBarLeads').textContent=customers.length;
      document.getElementById('topBarLeadsChange').textContent=`+${dashboardMetrics.leads.change}`;
      document.getElementById('topBarCalls').textContent=callHistory.length;
      document.getElementById('topBarCallsChange').textContent=`+${dashboardMetrics.calls.change}`;
      document.getElementById('topBarService').textContent=serviceOrders.length;
      document.getElementById('topBarServiceChange').textContent=`+${dashboardMetrics.service.change}`;

      document.getElementById('dashboardRevenue').textContent=formatCurrency(dashboardMetrics.revenue.value);
      document.getElementById('dashboardRevenueTrend').textContent=`+${dashboardMetrics.revenue.change*100}%`;
      document.getElementById('dashboardRevenueSubtitle').textContent=`vs ${formatCurrency(dashboardMetrics.revenue.prevValue)} last month`;
      document.getElementById('dashboardLeads').textContent=customers.length;
      const hot=customers.filter(c=>c.status==='hot').length, q=customers.filter(c=>c.status==='qualified').length, f=customers.filter(c=>c.status==='follow').length;
      document.getElementById('dashboardLeadsSubtitle').textContent=`${hot} hot ‚Ä¢ ${q} qualified ‚Ä¢ ${f} follow-up`;
      document.getElementById('dashboardService').textContent=serviceOrders.length;
      const active=serviceOrders.filter(o=>o.status==='in-progress').length, pending=serviceOrders.filter(o=>o.status==='pending').length;
      document.getElementById('dashboardServiceSubtitle').textContent=`${active} active ‚Ä¢ ${pending} pending`;
      document.getElementById('dashboardSaleTime').textContent=dashboardMetrics.saleTime.value;

      // badges
      document.getElementById('customerBadge').textContent=customers.length;
      document.getElementById('inventoryBadge').textContent=inventory.filter(v=>v.status==='available').length;
      document.getElementById('serviceBadge').textContent=serviceOrders.length;
      document.getElementById('callBadge').textContent=callHistory.length;
      document.getElementById('emailBadge').textContent=emailHistory.length;
      document.getElementById('photoBadge').textContent=vehiclePhotos.length;
    }
    function showMetricDetails(metric){
      const messages={revenue:`Revenue Analysis: ${formatCurrency(dashboardMetrics.revenue.value)} total, up ${dashboardMetrics.revenue.change*100}% from last month.`,leads:`Lead Analysis: ${customers.length} active leads with average score ${(customers.reduce((s,c)=>s+(c.leadScore||7),0)/(customers.length||1)).toFixed(1)}/10`,service:`Service: ${serviceOrders.length} orders, revenue ${formatCurrency(serviceOrders.reduce((s,o)=>s+o.cost,0))}`,saleTime:`Sales Efficiency: ${dashboardMetrics.saleTime.value} days`};
      addChatMessage('assistant', messages[metric]||'Analyzing metrics...'); showPage('chat', document.querySelector('.nav-item[onclick*="chat"]'));
    }

    /* ====== CUSTOMERS ====== */
    function renderCustomerTable(){
      const tbody=document.getElementById('customerTableBody'); if(!tbody) return;
      tbody.innerHTML='';
      if(!Array.isArray(customers) || customers.length===0){
        tbody.innerHTML='<tr><td colspan="8" style="color:var(--text-muted); padding:16px;">No customers yet.</td></tr>'; return;
      }
      customers.forEach(c=>{
        const row=tbody.insertRow();
        row.innerHTML=`
          <td>${c.firstName||''} ${c.lastName||''}</td>
          <td>${c.email||''}<br><span style="font-size:11px;">${c.phone||''}</span></td>
          <td><span class="status-badge status-${c.status||'new'}">${c.status||'new'}</span></td>
          <td><span class="lead-score ${getLeadScoreClass(c.leadScore||7)}">${c.leadScore||7}</span></td>
          <td>${formatCurrency(c.value||0)}</td>
          <td>${c.vehicleInterest||''}<br><span style="font-size:11px;">${c.budget||''}</span></td>
          <td>${c.lastContact||'‚Äî'}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="viewCustomer('${String(c.id)}')">View</button>
            <button class="btn btn-sm btn-secondary" onclick="deleteCustomer('${String(c.id)}')">Delete</button>
          </td>`;
      });
    }
    function filterCustomers(){
      const q=(document.getElementById('customerSearch')?.value||'').toLowerCase().trim();
      document.querySelectorAll('#customerTableBody tr').forEach(row=>{
        const text=row.textContent.toLowerCase(); row.style.display=(!q || text.includes(q))?'':'none';
      });
    }
    function openCustomerForm(){document.getElementById('addCustomerForm').style.display='block'}
    function closeCustomerForm(){document.getElementById('addCustomerForm').style.display='none'}
    function viewCustomer(id){const c=customers.find(x=>String(x.id)===String(id)); if(!c){alert('Customer not found');return;}
      alert(`Customer Details:\n\nName: ${c.firstName||''} ${c.lastName||''}\nEmail: ${c.email||''}\nPhone: ${c.phone||''}\nInterest: ${c.vehicleInterest||''}\nBudget: ${c.budget||''}\nLead Score: ${c.leadScore||'-'}`);}
    async function deleteCustomer(id){
      if (window.db) {
        try {
          let { error } = await window.db.from('customers').delete().eq('id', id);
          if (error && /column "id"/i.test(error.message)) {
            ({ error } = await window.db.from('customers').delete().eq('ID', id));
          }
        } catch(_) {}
      }
      customers = customers.filter(x=>String(x.id)!==String(id));
      renderCustomerTable(); updateDashboardMetrics();
    }

    /* ====== INVENTORY ====== */
    function renderInventoryTable(){
      const tbody=document.getElementById('inventoryTableBody'); if(!tbody) return;
      tbody.innerHTML='';
      if(inventory.length===0){ tbody.innerHTML='<tr><td colspan="7" style="color:var(--text-muted);padding:16px;">No vehicles yet.</td></tr>'; return; }
      inventory.forEach(v=>{
        const r=tbody.insertRow();
        r.innerHTML=`<td>${v.vehicle}</td><td style="font-family:monospace;font-size:11px;">${v.vin||'PENDING'}</td><td><span class="status-badge status-${v.status}">${v.status}</span></td><td>${formatCurrency(v.price)}</td><td>${v.daysInStock||0}</td><td><span class="status-badge status-${v.serviceStatus==='ready'?'completed':v.serviceStatus}">${v.serviceStatus}</span></td><td><button class="btn btn-sm btn-primary" onclick="viewVehicle(${JSON.stringify(v.id)})">View</button><button class="btn btn-sm btn-secondary" onclick="deleteVehicle(${JSON.stringify(v.id)})">Delete</button></td>`;
      });
    }
    function filterInventory(){const f=document.getElementById('inventoryFilter').value.toLowerCase(); document.querySelectorAll('#inventoryTableBody tr').forEach(r=>{const t=r.textContent.toLowerCase(); r.style.display=t.includes(f)?'':''})}
    function openVehicleForm(){document.getElementById('addVehicleForm').style.display='block'}
    function closeVehicleForm(){document.getElementById('addVehicleForm').style.display='none'}
    function viewVehicle(id){const v=inventory.find(x=>String(x.id)===String(id)); if(v) alert(`Vehicle Details:\n\n${v.vehicle}\nVIN: ${v.vin||'‚Äî'}\nPrice: ${formatCurrency(v.price)}\nStatus: ${v.status}\nDays in Stock: ${v.daysInStock||0}\nService: ${v.serviceStatus}`)}
    async function deleteVehicle(id){
      if(!confirm('Delete this vehicle?')) return;
      try{ await window.db.from('vehicles').delete().eq('id', id); }catch(_){}
      inventory = inventory.filter(v=>String(v.id)!==String(id)); renderInventoryTable(); updateDashboardMetrics(); populateVehicleDropdowns();
    }

    /* ====== PHOTOS ====== */
    async function startCamera(){try{cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); const v=document.getElementById('cameraFeed'); v.srcObject=cameraStream; v.style.display='block'; document.getElementById('captureBtn').disabled=false; addActivity('üì∑','Camera started');}catch(e){alert('Camera access denied.')}} 
    function stopCamera(){if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; const v=document.getElementById('cameraFeed'); v.style.display='none'; document.getElementById('captureBtn').disabled=true; addActivity('üì∑','Camera stopped');}}
    function capturePhoto(){const video=document.getElementById('cameraFeed'); const canvas=document.getElementById('photoCanvas'); const vehicleId=document.getElementById('vehicleSelect').value; const type=document.getElementById('photoType').value; if(!vehicleId){alert('Select a vehicle first');return;} canvas.width=video.videoWidth||640; canvas.height=video.videoHeight||480; const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0); const data=canvas.toDataURL('image/jpeg'); const vehicle=inventory.find(v=>String(v.id)===String(vehicleId)); const photo={id:Date.now(),vehicleId,vehicleName:vehicle?.vehicle||'Vehicle',type,data,timestamp:new Date()}; vehiclePhotos.push(photo); tryUploadPhoto(photo); displayPhotos(); updateDashboardMetrics(); addActivity('üì∏',`Photo captured: ${photo.vehicleName}`);}
    function handleFileUpload(e){const file=e.target.files[0]; const vehicleId=document.getElementById('vehicleSelect').value; const type=document.getElementById('photoType').value; if(!vehicleId){alert('Select a vehicle first');return;} if(file){const r=new FileReader(); r.onload=function(x){const vehicle=inventory.find(v=>String(v.id)===String(vehicleId)); const photo={id:Date.now(),vehicleId,vehicleName:vehicle?.vehicle||'Vehicle',type,data:x.target.result,timestamp:new Date()}; vehiclePhotos.push(photo); tryUploadPhoto(photo); displayPhotos(); updateDashboardMetrics(); addActivity('üì∏',`Photo uploaded: ${photo.vehicleName}`);}; r.readAsDataURL(file);}}
    function dataURLToBlob(dataURL){const arr=dataURL.split(','), mime=arr[0].match(/:(.*?);/)[1]; const bstr=atob(arr[1]); let n=bstr.length; const u8=new Uint8Array(n); while(n--) u8[n]=bstr.charCodeAt(n); return new Blob([u8],{type:mime});}
    async function tryUploadPhoto(photo){
      if(!window.db?.storage) return; // optional
      try{
        const file = dataURLToBlob(photo.data);
        const path = `${photo.vehicleId}/${photo.id}.jpg`;
        const { error } = await window.db.storage.from('vehicle_photos').upload(path, file, { contentType:'image/jpeg', upsert:false });
        if(!error){
          const { data } = window.db.storage.from('vehicle_photos').getPublicUrl(path);
          if(data?.publicUrl){ photo.data = data.publicUrl; }
        }
      }catch(_){}
    }
    function displayPhotos(){const g=document.getElementById('photoGallery'); if(!g)return; if(vehiclePhotos.length===0){g.innerHTML='<div style="grid-column:1 / -1; text-align:center; color:var(--text-muted); padding:40px;">No photos yet. Use the camera or upload button to add photos.</div>'; return;} g.innerHTML=''; vehiclePhotos.forEach(p=>{const d=document.createElement('div'); d.style.position='relative'; d.style.border='2px solid var(--border-accent)'; d.style.borderRadius='12px'; d.style.overflow='hidden'; d.innerHTML=`<img src="${p.data}" alt="${p.type}" style="width:100%;height:100%;object-fit:cover"><div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.8));padding:8px;color:#fff;font-size:10px;">${p.vehicleName} ‚Äî ${p.type}</div><button onclick="deletePhoto(${p.id})" style="position:absolute;top:4px;right:4px;background:var(--error);color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer">√ó</button>`; g.appendChild(d);});}
    function deletePhoto(id){if(confirm('Delete this photo?')){vehiclePhotos=vehiclePhotos.filter(p=>p.id!==id); displayPhotos(); updateDashboardMetrics();}}

    /* ====== SERVICE ====== */
    function renderServiceTable(){const tbody=document.getElementById('serviceTableBody'); if(!tbody)return; tbody.innerHTML=''; if(serviceOrders.length===0){tbody.innerHTML='<tr><td colspan="8" style="color:var(--text-muted);padding:16px;">No service orders yet.</td></tr>'; return;} serviceOrders.forEach(o=>{const r=tbody.insertRow(); r.innerHTML=`<td>${o.id}</td><td>${o.vehicle}</td><td>${o.customer}</td><td>${o.serviceType}</td><td>${o.technician}</td><td><span class="status-badge status-${o.status}">${o.status}</span></td><td>${formatCurrency(o.cost)}</td><td><button class="btn btn-sm btn-primary" onclick="viewServiceOrder('${o.id}')">View</button><button class="btn btn-sm btn-secondary" onclick="updateServiceStatus('${o.id}')">Advance</button></td>`;});}
    function createServiceOrder(){const f=document.getElementById('serviceOrderForm'); if(f){f.style.display='block'; populateVehicleDropdowns();}}
    function closeServiceForm(){const f=document.getElementById('serviceOrderForm'); if(f) f.style.display='none';}
    function submitServiceOrder(){const vehicle=serviceVehicle.value, type=serviceType.value, priority=servicePriority.value, notes=serviceNotes.value; if(!vehicle||!type){alert('Pick a vehicle and service type');return;} const v=inventory.find(x=>String(x.id)===String(vehicle))?.vehicle||'Unknown'; const order={order_no:`SO-${Date.now()}`, vehicle:v, vehicle_id:vehicle, customer:'Walk-in', service_type:type, technician:'Unassigned', status:priority==='urgent'?'in-progress':'pending', cost:Math.floor(Math.random()*500)+100, notes, priority}; saveServiceOrder(order); }
    async function saveServiceOrder(payload){ try{ const { error } = await window.db.from('service_orders').insert([payload]); if(error) throw error; await loadServiceFromDB(); renderServiceTable(); closeServiceForm(); addActivity('üîß',`Service order ${payload.order_no} created`); updateDashboardMetrics(); }catch(e){ alert('Could not save service order: '+(e.message||e)); }}
    function viewServiceOrder(id){const o=serviceOrders.find(x=>String(x.id)===String(id)); if(o) alert(`Service Order ${o.id}\n\nVehicle: ${o.vehicle}\nCustomer: ${o.customer}\nService: ${o.serviceType}\nStatus: ${o.status}\nCost: ${formatCurrency(o.cost)}`)}
    function updateServiceStatus(id){const o=serviceOrders.find(x=>String(x.id)===String(id)); if(!o) return; const s=['pending','in-progress','completed']; o.status=s[(s.indexOf(o.status)+1)%s.length]; renderServiceTable(); addActivity('üîß',`Service ${id} status: ${o.status}`,'Just now');}

    /* ====== CALLS / EMAILS ====== */
    function renderCallTable(){const tbody=document.getElementById('callTableBody'); if(!tbody)return; tbody.innerHTML=''; if(callHistory.length===0){tbody.innerHTML='<tr><td colspan="7" style="color:var(--text-muted);padding:16px;">No calls yet.</td></tr>'; return;} callHistory.forEach(c=>{const r=tbody.insertRow(); r.innerHTML=`<td>${c.dateTime.toLocaleDateString()}<br><span style="font-size:11px;">${c.dateTime.toLocaleTimeString()}</span></td><td>${c.phoneNumber}</td><td>${c.customer}</td><td>${c.duration}</td><td><span class="lead-score ${getLeadScoreClass(c.leadScore)}">${c.leadScore}</span></td><td><span class="status-badge status-${c.status}">${c.status}</span></td><td><button class="btn btn-sm btn-primary" onclick="viewCallTranscript(${c.id})">Transcript</button><button class="btn btn-sm btn-secondary" onclick="deleteCall(${c.id})">Delete</button></td>`;});}
    function simulateNewCall(){const c={id:Date.now(),dateTime:new Date(),phoneNumber:'555-'+Math.floor(Math.random()*9000+1000),customer:'New Customer',duration:Math.floor(Math.random()*15)+':'+String(Math.floor(Math.random()*60)).padStart(2,'0'),leadScore:Math.floor(Math.random()*4)+6,status:'transcribed'}; callHistory.unshift(c); renderCallTable(); updateDashboardMetrics(); addActivity('üìû','New call received','Just now'); alert('New call simulated successfully!');}
    function viewCallTranscript(id){const c=callHistory.find(x=>x.id===id); if(c) alert(`Call Transcript\n\nCustomer: ${c.customer}\nPhone: ${c.phoneNumber}\nDuration: ${c.duration}\nLead Score: ${c.leadScore}/10\n\n[Transcript here]`)}
    function deleteCall(id){if(confirm('Delete this call record?')){callHistory=callHistory.filter(c=>c.id!==id); renderCallTable(); updateDashboardMetrics();}}
    function renderEmailTable(){const tbody=document.getElementById('emailTableBody'); if(!tbody)return; tbody.innerHTML=''; if(emailHistory.length===0){tbody.innerHTML='<tr><td colspan="6" style="color:var(--text-muted);padding:16px;">No emails yet.</td></tr>'; return;} emailHistory.forEach(e=>{const r=tbody.insertRow(); r.innerHTML=`<td>${e.date.toLocaleDateString()}<br><span style="font-size:11px;">${e.date.toLocaleTimeString()}</span></td><td>${e.recipient}</td><td>${e.subject}</td><td><span class="status-badge status-${e.type}">${e.type}</span></td><td><span class="status-badge status-${e.status}">${e.status}</span></td><td><button class="btn btn-sm btn-primary" onclick="viewEmail(${e.id})">View</button><button class="btn btn-sm btn-secondary" onclick="deleteEmail(${e.id})">Delete</button></td>`;});}
    function createEmailCampaign(){const subject=prompt('Email subject:'); if(subject){const e={id:Date.now(),date:new Date(),recipient:'all@customers.com',subject,type:'campaign',status:'sent'}; emailHistory.unshift(e); renderEmailTable(); updateDashboardMetrics(); addActivity('üìß','Email campaign sent','Just now'); alert('Email campaign created!');}}
    function SaveEmailTemplate(){const s=emailSubject.value,b=emailBody.value; if(s&&b){alert('Email template saved successfully!'); addActivity('üíæ','Email template saved','Just now');}}
    function viewEmail(id){const e=emailHistory.find(x=>x.id===id); if(e) alert(`Email Details\n\nTo: ${e.recipient}\nSubject: ${e.subject}\nType: ${e.type}\nStatus: ${e.status}`)}
    function deleteEmail(id){if(confirm('Delete this email?')){emailHistory=emailHistory.filter(e=>e.id!==id); renderEmailTable(); updateDashboardMetrics();}}

    /* ====== VIN ====== */
    async function scanVIN(){const vin=vinInput.value; if(vin.length!==17){alert('Please enter a valid 17-character VIN');return;} const wrap=document.getElementById('vinResult'), box=document.getElementById('vinData'); box.innerHTML='<div style="text-align:center;">üîç Decoding VIN...</div>'; wrap.style.display='block'; try{const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const g=v=>d.Results.find(x=>x.Variable===v)?.Value||'N/A'; box.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px;"><div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Make</div><div style="font-size:14px;font-weight:600;">${g('Make')}</div></div><div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Model</div><div style="font-size:14px;font-weight:600;">${g('Model')}</div></div><div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Year</div><div style="font-size:14px;font-weight:600;">${g('Model Year')}</div></div><div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Body Type</div><div style="font-size:14px;font-weight:600;">${g('Body Class')}</div></div><div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Engine</div><div style="font-size:14px;font-weight:600;">${g('Engine Model')}</div></div><div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Manufacturer</div><div style="font-size:14px;font-weight:600;">${g('Manufacturer Name')}</div></div></div>`; addActivity('üîç','VIN decoded successfully'); }catch(e){box.innerHTML='<div style="color:var(--error); text-align:center;">Error decoding VIN</div>';}}
    /* ====== CHAT / VOICE ====== */
    function addChatMessage(type,html){const box=document.getElementById('chatMessages'); const d=document.createElement('div'); d.className=`chat-message ${type}`; d.innerHTML=html; box.appendChild(d); box.scrollTop=box.scrollHeight;}
    async function sendMessage(){const i=document.getElementById('chatInput'); const m=i.value.trim(); if(!m) return; addChatMessage('user',m); i.value=''; const handled=await handleVoiceCommand(m,true); if(!handled){ if(!aiApiKey){ addChatMessage('assistant','‚ÑπÔ∏è No AI key set. Local commands still work.'); return; } try{ const out=await callOpenAI(m); addChatMessage('assistant',out); }catch(e){ addChatMessage('assistant','‚ùå '+(e.message||e)); }}}
    function testAIConnection(){if(!document.getElementById('aiApiKey').value.trim()){ alert('Paste your OpenAI key first'); return; } aiApiKey=document.getElementById('aiApiKey').value.trim(); callOpenAI('Reply with OK.').then(o=>addChatMessage('assistant','‚úÖ AI connected: '+o)).catch(e=>alert('AI test failed: '+(e.message||e))); updateAIStatus();}
    function updateAIStatus(){const k=document.getElementById('aiApiKey').value; const dot=document.getElementById('aiStatusDot'); const txt=document.getElementById('aiStatusText'); if(k && k.length>10){aiApiKey=k; dot.style.background='var(--success)'; txt.textContent='AI Status: Connected';}else{aiApiKey=null; dot.style.background='var(--error)'; txt.textContent='AI Status: API Key Required';}}
    function updateOpenPhoneStatus(){const k=openphoneApiKey=document.getElementById('openphoneApiKey').value; alert(k && k.length>10 ? 'OpenPhone ready' : 'Enter OpenPhone key');}
    function testOpenPhoneConnection(){if(!openphoneApiKey){alert('Please enter OpenPhone API key first');return;} addChatMessage('assistant','‚úÖ OpenPhone API connected successfully');}
    function saveAIConfig(){updateAIStatus(); updateOpenPhoneStatus(); alert('Configuration saved'); addActivity('üîß','AI configuration saved');}
    async function callOpenAI(prompt){
      const payload={model:'gpt-4o-mini',temperature:0.2,messages:[{role:'system',content:'You are TVC Auto AI. Be concise.'},{role:'user',content:`DATA\nCustomers: ${JSON.stringify(customers.slice(0,30))}\nInventory: ${JSON.stringify(inventory.slice(0,30))}\nService: ${JSON.stringify(serviceOrders.slice(0,30))}\n\nQUESTION: ${prompt}`}]};
      const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+aiApiKey},body:JSON.stringify(payload)});
      if(!r.ok) throw new Error('OpenAI error '+r.status+': '+(await r.text()));
      const j=await r.json(); return j.choices?.[0]?.message?.content?.trim()||'(no response)';
    }

    /* ====== VOICE ====== */
    let recognition=null;
    function initVoice(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return;
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.onresult = (event) => {
        let finalText = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) finalText += transcript;
        }
        if (finalText.trim()) {
          addChatMessage('user','üéôÔ∏è ' + finalText.trim());
          handleVoiceCommand(finalText.trim());
        }
      };
      recognition.onerror = (e) => {
        if (e.error === 'not-allowed') alert('Mic permission blocked. Please allow microphone.');
      };
      recognition.onend = () => {
        if (isListening) { try { recognition.start(); } catch(_) {} }
        else updateVoiceUI();
      };
    }
    function updateVoiceUI(){
      const btn=document.getElementById('voiceBtn');
      if(!btn) return;
      btn.textContent = isListening ? 'üéôÔ∏è Listening‚Ä¶ (tap to stop)' : 'üé§ Voice';
      btn.style.border = isListening ? '1px solid var(--success)' : '1px solid var(--glass-border)';
    }
    function startVoice(){ if(!recognition){ alert('Use Chrome/Edge for voice'); return; } try{ recognition.start(); isListening=true; updateVoiceUI(); addActivity('üéôÔ∏è','Voice listening started'); }catch(e){} }
    function stopVoice(){ if(recognition){ try{ recognition.stop(); }catch(_){ } } isListening=false; updateVoiceUI(); addActivity('üéôÔ∏è','Voice stopped'); }
    function toggleVoice(){ isListening ? stopVoice() : startVoice(); }
    async function handleVoiceCommand(raw, fromText=false){
      const text = raw.toLowerCase().trim();
      const navEl = id => document.querySelector(`.nav-item[onclick*="${id}"]`);

      // Navigation
      if (/(show|open|go to)\s+(customers|customer)/.test(text)) { showPage('customers', navEl('customers')); addChatMessage('assistant', `üìã Opened Customers. Total: ${customers.length}.`); return true; }
      if (/(show|open|go to)\s+(inventory|vehicles?)/.test(text)) { showPage('inventory', navEl('inventory')); addChatMessage('assistant', `üöó Opened Inventory. Total: ${inventory.length}.`); return true; }
      if (/(show|open|go to)\s+service/.test(text)) { showPage('service', navEl('service')); addChatMessage('assistant','üîß Opened Service.'); return true; }
      if (/(show|open|go to)\s+photos?/.test(text)) { showPage('photos', navEl('photos')); addChatMessage('assistant','üì∏ Opened Photo Manager.'); return true; }
      if (/(show|open|go to)\s+dashboard/.test(text)) { showPage('dashboard', navEl('dashboard')); addChatMessage('assistant','üè† Opened Dashboard.'); return true; }
      if (/(show|open|go to)\s+(chat|terminal|ai)/.test(text)) { showPage('chat', navEl('chat')); addChatMessage('assistant','ü§ñ Opened AI Terminal.'); return true; }

      // Search customers
      let m = text.match(/^(search|find)\s+(customers?|customer)\s+(for\s+)?(.+)/);
      if (m && m[4]) { const q=m[4].trim(); const box=document.getElementById('customerSearch'); showPage('customers', navEl('customers')); if(box){ box.value=q; filterCustomers(); } const n=[...document.querySelectorAll('#customerTableBody tr')].filter(r=>r.style.display!=='none').length; addChatMessage('assistant', `üîé Customer search for "<b>${q}</b>": ${n} result(s).`); return true; }

      // Search inventory
      m = text.match(/^(search|find)\s+inventory\s+(for\s+)?(.+)/);
      if (m && m[3]) { const q=m[3].trim(); const box=document.getElementById('inventoryFilter'); showPage('inventory', navEl('inventory')); if(box){ box.value=q; filterInventory(); } const n=[...document.querySelectorAll('#inventoryTableBody tr')].filter(r=>r.style.display!=='none').length; addChatMessage('assistant', `üîé Inventory search for "<b>${q}</b>": ${n} result(s).`); return true; }

      // View customer by name
      m = text.match(/^(view|open)\s+customer\s+(.+)/);
      if (m && m[2]) { const q=m[2].trim(); showPage('customers', navEl('customers')); const found=customers.find(c => (`${c.firstName} ${c.lastName}`.toLowerCase()).includes(q.toLowerCase())); if(found){ addChatMessage('assistant', `üë§ Opening ${found.firstName} ${found.lastName}.`); viewCustomer(found.id); } else { addChatMessage('assistant', `‚ùì No customer like "${q}".`);} return true; }

      // Add customer
      if (/^(add|new)\s+customer/.test(text)) { showPage('customers', navEl('customers')); openCustomerForm(); addChatMessage('assistant','üìù Add Customer form opened.'); return true; }

      // Fallback (only when typed)
      if (fromText) return false;
      addChatMessage('assistant','üó£Ô∏è Try: ‚Äúshow customers‚Äù, ‚Äúsearch customers for Dennis‚Äù, ‚Äúopen inventory‚Äù, ‚Äúsearch inventory for Camry‚Äù, or ‚Äúadd customer‚Äù.');
      return true;
    }

    /* ====== EXPORT / REFRESH ====== */
    function exportData(){alert(`Exporting data‚Ä¶\n\nCustomers: ${customers.length}\nInventory: ${inventory.length}\nService Orders: ${serviceOrders.length}\nRevenue: ${formatCurrency(dashboardMetrics.revenue.value)}`); addActivity('üìä','Data exported');}
    async function refreshData(){ await Promise.all([loadCustomersFromDB(), loadInventoryFromDB(), loadServiceFromDB()]); renderServiceTable(); renderCustomerTable(); renderInventoryTable(); renderCallTable(); renderEmailTable(); populateVehicleDropdowns(); updateDashboardMetrics(); addActivity('üîÑ','Data refreshed'); alert('All data refreshed successfully!');}
  </script>

  <!-- ============ SUPABASE ============ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 1) Connect to Supabase (keep your project values)
    const SUPABASE_URL = "https://zpgdsgutiheilshgrnwl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2RzZ3V0aWhlaWxzaGdybndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjA3NDMsImV4cCI6MjA3MDU5Njc0M30.LC-ro-E2k_Xb7UK337QP8V2HddpftjV5g1ZsI6D0c8k";
    window.db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ---------- Map helpers ---------- */
    function mapRowToCustomer(row){
      const full=(row["Name"] ?? row.name ?? '').toString().trim();
      const parts=full.split(/\s+/); const first=parts.shift()||''; const last=parts.join(' ');
      const budget=String(row["Budget"] ?? row.budget ?? '');
      return {
        id: row.id ?? row.ID ?? row.uuid ?? row["ID"],
        firstName:first, lastName:last,
        email: row["Email"] ?? row.email ?? '',
        phone: row["Phone"] ?? row.phone ?? '',
        vehicleInterest: row["Vehicle of interest"] ?? row.vehicle_interest ?? '',
        budget: budget, address: row["Address"] ?? row.address ?? '',
        currentVehicle: row["Current Vehicle/Trade in"] ?? row.current_vehicle ?? '',
        status:'new', leadScore:8,
        value: parseInt(budget.replace(/[^0-9]/g,'')) || 0,
        lastContact:'‚Äî'
      };
    }
    function mapRowToVehicle(row){
      return {
        id: row.id,
        vin: row.vin||'',
        make: row.make||'', model: row.model||'', year: row.year||'',
        vehicle: `${row.year||''} ${row.make||''} ${row.model||''}`.trim(),
        status: row.status||'available',
        price: Number(row.price)||0,
        daysInStock: row.days_in_stock ?? 0,
        serviceStatus: row.service_status || 'pending'
      };
    }
    function mapRowToService(row){
      return {
        id: row.order_no || row.id,
        vehicle: row.vehicle || 'Unknown',
        customer: row.customer || 'Walk-in',
        serviceType: row.service_type || 'inspection',
        technician: row.technician || 'Unassigned',
        status: row.status || 'pending',
        cost: Number(row.cost)||0,
        date: row.created_at?new Date(row.created_at):new Date()
      };
    }

    /* ---------- LOAD ---------- */
    async function loadCustomersFromDB(){
      try{
        let { data, error } = await window.db.from('customers').select('*').order('created_at', { ascending:false });
        if(error){ ({data,error}=await window.db.from('customers').select('*')); }
        if(error) throw error;
        customers.length=0; (data||[]).forEach(r=>customers.push(mapRowToCustomer(r)));
      }catch(e){ console.warn('customers load failed:', e.message||e); }
    }
    async function loadInventoryFromDB(){
      try{
        const { data, error } = await window.db.from('vehicles').select('*').order('created_at',{ascending:false});
        if(error) throw error;
        inventory.length=0; (data||[]).forEach(r=>inventory.push(mapRowToVehicle(r)));
      }catch(e){ console.warn('vehicles load failed:', e.message||e); }
    }
    async function loadServiceFromDB(){
      try{
        const { data, error } = await window.db.from('service_orders').select('*').order('created_at',{ascending:false});
        if(error) throw error;
        serviceOrders.length=0; (data||[]).forEach(r=>serviceOrders.push(mapRowToService(r)));
      }catch(e){ console.warn('service load failed:', e.message||e); }
    }

    /* ---------- CREATE ---------- */
    async function addCustomer(){
      const name  = (document.getElementById('newCustomerName')?.value || '').trim();
      const address  = (document.getElementById('newCustomerAddress')?.value || '').trim();
      const email = (document.getElementById('newCustomerEmail')?.value || '').trim();
      const phone = (document.getElementById('newCustomerPhone')?.value || '').trim();
      const vehicleInterest = (document.getElementById('newCustomerVehicleInterest')?.value || '').trim();
      const currentVehicle  = (document.getElementById('newCustomerCurrentVehicle')?.value || '').trim();
      const budget = (document.getElementById('newCustomerBudget')?.value || '').trim();

      if (!name) { alert('Please enter a name'); return; }

      try {
        const { error } = await window.db.from("customers").insert([{
          ["Name"]: name, ["Address"]: address, ["Email"]: email, ["Phone"]: phone,
          ["Vehicle of interest"]: vehicleInterest, ["Current Vehicle/Trade in"]: currentVehicle, ["Budget"]: budget
        }]);
        if (error) throw error;
        await loadCustomersFromDB(); renderCustomerTable(); updateDashboardMetrics();
        ['newCustomerName','newCustomerAddress','newCustomerEmail','newCustomerPhone','newCustomerVehicleInterest','newCustomerCurrentVehicle','newCustomerBudget'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        document.getElementById('newCustomerStatus').value='new'; closeCustomerForm(); addActivity('üë§',`New customer: ${name}`);
      } catch(e) {
        alert('Could not save to Supabase: ' + (e.message || e));
      }
    }

    async function addVehicle(){
      const vin=newVehicleVIN.value.trim(), make=newVehicleMake.value.trim(), model=newVehicleModel.value.trim(), year=parseInt(newVehicleYear.value||0), price=parseInt(newVehiclePrice.value||0), status=newVehicleStatus.value;
      if(!(make&&model&&year&&price)){ alert('Fill make, model, year, price'); return; }
      try{
        const { error } = await window.db.from('vehicles').insert([{ vin, make, model, year, price, status, service_status:'pending', days_in_stock:0 }]);
        if(error) throw error;
        await loadInventoryFromDB(); renderInventoryTable(); updateDashboardMetrics(); populateVehicleDropdowns(); closeVehicleForm();
        addActivity('üöó',`New vehicle: ${year} ${make} ${model}`);
        ['newVehicleVIN','newVehicleMake','newVehicleModel','newVehicleYear','newVehiclePrice'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
      }catch(e){ alert('Could not save vehicle: '+(e.message||e)); }
    }

    /* ---------- SERVICE CREATE ---------- */
    async function submitServiceOrder(){
      const vehicle=serviceVehicle.value, type=serviceType.value, priority=servicePriority.value, notes=serviceNotes.value;
      if(!vehicle||!type){ alert('Pick a vehicle and service type'); return; }
      const v=inventory.find(x=>String(x.id)===String(vehicle));
      const payload={ order_no:`SO-${Date.now()}`, vehicle:v?.vehicle||'Unknown', vehicle_id:v?.id||null, customer:'Walk-in', service_type:type, technician:'Unassigned', status:priority==='urgent'?'in-progress':'pending', cost:Math.floor(Math.random()*500)+100, notes, priority };
      try{
        const { error } = await window.db.from('service_orders').insert([payload]);
        if(error) throw error;
        await loadServiceFromDB(); renderServiceTable(); updateDashboardMetrics(); closeServiceForm(); addActivity('üîß',`Service order ${payload.order_no} created`);
      }catch(e){ alert('Could not save service order: '+(e.message||e)); }
    }

    /* ---------- INVENTORY HELPERS ---------- */
    async function decodeVIN(){const vin=newVehicleVIN.value; if(vin.length!==17){alert('Please enter a valid 17-character VIN');return;} try{const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const g=v=>d.Results.find(x=>x.Variable===v)?.Value||''; newVehicleMake.value=g('Make'); newVehicleModel.value=g('Model'); newVehicleYear.value=g('Model Year'); alert('VIN decoded successfully!'); }catch(e){alert('Error decoding VIN. Please enter details manually.');}}
    function populateVehicleDropdowns(){const sel=document.getElementById('vehicleSelect'), serv=document.getElementById('serviceVehicle'); if(sel){sel.innerHTML='<option value="">Choose vehicle...</option>'; inventory.forEach(v=>{const o=document.createElement('option'); o.value=v.id; o.textContent=v.vehicle; sel.appendChild(o);});} if(serv){serv.innerHTML='<option value="">Select vehicle...</option>'; inventory.forEach(v=>{const o=document.createElement('option'); o.value=v.id; o.textContent=v.vehicle; serv.appendChild(o);});}}
  </script>
</body>
</html>
    .form{padding:14px}
    .group{margin-bottom:12px}
    .label{display:block;font-size:11px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;font-weight:700}
    .input,.select,.textarea{width:100%;padding:10px 12px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;color:#fff}

    /* ===== MOBILE ===== */
    @media (max-width: 900px){
      .terminal{grid-template-columns:1fr}
      .sidebar{position:fixed;z-index:40;top:60px;bottom:0;left:0;right:0;max-width:320px;transform:translateX(-100%);transition:.25s}
      .sidebar.open{transform:translateX(0)}
      .menu-btn{display:inline-flex}
    }
  </style>
</head>

<body>
  <div class="terminal">
    <!-- ===== TOP BAR ===== -->
    <div class="topbar">
      <div class="brand">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
        <div class="logo">‚ö°</div>
        <div class="brand-title">TVC Auto AI Pro</div>
      </div>
      <div class="top-actions">
        <div class="pill"><span class="dot"></span> LIVE DATA</div>
        <button class="btn" id="voiceBtn" onclick="toggleVoice()">üé§ Voice</button>
        <button class="btn btn-primary" onclick="showPage('chat', findNav('chat'))">ü§ñ AI Terminal</button>
      </div>
    </div>

    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar" id="sidebar">
      <div class="nav-section">
        <div class="nav-title">Overview</div>
        <div class="nav-item active" onclick="showPage('dashboard', this)"><span>üìä</span>Dashboard</div>
        <div class="nav-item" onclick="showPage('analytics', this)"><span>üìà</span>Analytics</div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Operations</div>
        <div class="nav-item" onclick="showPage('customers', this)"><span>üë•</span>Customers <span class="badge" id="customerBadge">0</span></div>
        <div class="nav-item" onclick="showPage('inventory', this)"><span>üöó</span>Inventory <span class="badge" id="inventoryBadge" style="background:var(--success)">0</span></div>
        <div class="nav-item" onclick="showPage('service', this)"><span>üîß</span>Service Center <span class="badge" id="serviceBadge" style="background:var(--warning)">0</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Comms</div>
        <div class="nav-item" onclick="showPage('calls', this)"><span>üìû</span>Call Center <span class="badge" id="callBadge" style="background:var(--accent-primary)">0</span></div>
        <div class="nav-item" onclick="showPage('emails', this)"><span>üìß</span>Email Center <span class="badge" id="emailBadge" style="background:var(--success)">0</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-title">Intelligence</div>
        <div class="nav-item" onclick="showPage('vin', this)"><span>üîç</span>VIN Scanner</div>
        <div class="nav-item" onclick="showPage('chat', this)"><span>ü§ñ</span>AI Terminal</div>
      </div>
    </div>

    <!-- ===== CONTENT ===== -->
    <div class="content">
      <div class="content-header">
        <div class="content-title" id="title">Executive Dashboard</div>
        <div>
          <button class="btn" onclick="exportData()">üìä Export</button>
          <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
        </div>
      </div>

      <div class="content-body">

        <!-- DASHBOARD -->
        <div id="dashboard" class="page active">
          <div class="card">
            <div class="card-head"><div>Live Activity</div></div>
            <div id="activity" style="max-height:340px;overflow:auto;padding:8px 6px">
              <div style="padding:12px;color:var(--text-muted)">System ready.</div>
            </div>
          </div>
        </div>

        <!-- CUSTOMERS -->
        <div id="customers" class="page">
          <div class="card">
            <div class="card-head">
              <div>Customer Pipeline</div>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="customerSearch" class="input" placeholder="Search name, email, or phone‚Ä¶" style="width:260px" oninput="filterCustomers()"/>
                <button class="btn btn-sm" onclick="customerSearch.value='';filterCustomers()">Clear</button>
                <button class="btn btn-primary" onclick="openCustomerForm()">+ Add Customer</button>
              </div>
            </div>
            <table class="table">
              <thead><tr>
                <th>Customer</th><th>Contact</th><th>Status</th><th>Lead</th><th>Potential</th><th>Interest</th><th>Last Contact</th><th>Actions</th>
              </tr></thead>
              <tbody id="customerRows"><tr><td colspan="8" style="padding:16px;color:var(--text-muted)">Loading‚Ä¶</td></tr></tbody>
            </table>
          </div>

          <div id="customerForm" class="card" style="display:none">
            <div class="card-head"><div>Add New Customer</div></div>
            <div class="form">
              <div class="group"><label class="label">Name</label><input id="c_name" class="input" placeholder="John Smith"></div>
              <div class="group"><label class="label">Address</label><input id="c_address" class="input" placeholder="123 Main St"></div>
              <div class="group"><label class="label">Email</label><input id="c_email" class="input" placeholder="john@example.com"></div>
              <div class="group"><label class="label">Phone</label><input id="c_phone" class="input" placeholder="555-123-4567"></div>
              <div class="group"><label class="label">Vehicle of Interest</label><input id="c_interest" class="input" placeholder="2024 BMW X5"></div>
              <div class="group"><label class="label">Current Vehicle</label><input id="c_current" class="input" placeholder="2018 Honda Accord"></div>
              <div class="group"><label class="label">Budget</label><input id="c_budget" class="input" placeholder="$50,000‚Äì$70,000"></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
                <button class="btn" onclick="closeCustomerForm()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- INVENTORY -->
        <div id="inventory" class="page">
          <div class="card">
            <div class="card-head">
              <div>Vehicle Inventory</div>
              <div style="display:flex;gap:8px">
                <input id="invFilter" class="input" placeholder="Filter‚Ä¶" style="width:220px" oninput="filterInventory()">
                <button class="btn btn-primary" onclick="openVehicleForm()">+ Add Vehicle</button>
              </div>
            </div>
            <table class="table">
              <thead><tr><th>Vehicle</th><th>VIN</th><th>Status</th><th>Price</th><th>Days</th><th>Service</th><th>Actions</th></tr></thead>
              <tbody id="invRows"></tbody>
            </table>
          </div>

          <div id="vehicleForm" class="card" style="display:none">
            <div class="card-head"><div>Add New Vehicle</div></div>
            <div class="form">
              <div class="group"><label class="label">VIN</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="v_vin" class="input" placeholder="17-char VIN" maxlength="17" style="flex:1">
                  <button class="btn btn-primary" onclick="decodeVIN()">Decode</button>
                </div>
              </div>
              <div class="group"><label class="label">Make</label><input id="v_make" class="input" placeholder="Toyota"></div>
              <div class="group"><label class="label">Model</label><input id="v_model" class="input" placeholder="Camry"></div>
              <div class="group"><label class="label">Year</label><input id="v_year" type="number" class="input" placeholder="2024"></div>
              <div class="group"><label class="label">Price</label><input id="v_price" type="number" class="input" placeholder="32000"></div>
              <div class="group"><label class="label">Status</label>
                <select id="v_status" class="select"><option value="available">Available</option><option value="reserved">Reserved</option><option value="sold">Sold</option><option value="incoming">Incoming</option></select>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="addVehicle()">Add Vehicle</button>
                <button class="btn" onclick="closeVehicleForm()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- SERVICE -->
        <div id="service" class="page">
          <div class="card">
            <div class="card-head">
              <div>Service Orders</div>
              <button class="btn btn-primary" onclick="openServiceForm()">+ New Service Order</button>
            </div>
            <table class="table">
              <thead><tr><th>Order #</th><th>Vehicle</th><th>Customer</th><th>Service</th><th>Tech</th><th>Status</th><th>Est. Cost</th><th>Actions</th></tr></thead>
              <tbody id="svcRows"></tbody>
            </table>
          </div>

          <div id="serviceForm" class="card" style="display:none">
            <div class="card-head"><div>Create Service Order</div></div>
            <div class="form">
              <div class="group"><label class="label">Vehicle</label>
                <select id="svc_vehicle" class="select"><option value="">Select‚Ä¶</option></select>
              </div>
              <div class="group"><label class="label">Service Type</label>
                <select id="svc_type" class="select">
                  <option value="reconditioning">Reconditioning</option><option value="oil-change">Oil Change</option><option value="inspection">Inspection</option>
                  <option value="brake-service">Brake Service</option><option value="tire-rotation">Tire Rotation</option><option value="major-repair">Major Repair</option>
                </select>
              </div>
              <div class="group"><label class="label">Priority</label>
                <select id="svc_priority" class="select"><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select>
              </div>
              <div class="group"><label class="label">Notes</label><textarea id="svc_notes" class="textarea" rows="4" placeholder="Service notes‚Ä¶"></textarea></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="submitServiceOrder()">Create</button>
                <button class="btn" onclick="closeServiceForm()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- CALLS (demo) -->
        <div id="calls" class="page">
          <div class="card">
            <div class="card-head">
              <div>Call History</div>
              <button class="btn btn-primary" onclick="simulateNewCall()">üìû Simulate Call</button>
            </div>
            <table class="table"><thead><tr><th>Date</th><th>Phone</th><th>Customer</th><th>Duration</th><th>Lead</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="callRows"></tbody></table>
          </div>
        </div>

        <!-- EMAILS (demo) -->
        <div id="emails" class="page">
          <div class="card">
            <div class="card-head"><div>Email Campaigns</div><button class="btn btn-primary" onclick="createEmailCampaign()">‚úâÔ∏è New</button></div>
            <table class="table"><thead><tr><th>Date</th><th>Recipient</th><th>Subject</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="emailRows"></tbody></table>
          </div>
        </div>

        <!-- VIN -->
        <div id="vin" class="page">
          <div class="card">
            <div class="card-head"><div>VIN Intelligence Scanner</div></div>
            <div class="form">
              <div class="group"><label class="label">VIN</label><input id="vinInput" class="input" placeholder="Enter 17-character VIN" maxlength="17"></div>
              <button class="btn btn-primary" onclick="scanVIN()" style="width:100%">üîç Decode</button>
              <div id="vinResult" style="display:none;margin-top:14px"><div id="vinData" class="form"></div></div>
            </div>
          </div>
        </div>

        <!-- AI TERMINAL -->
        <div id="chat" class="page">
          <div class="card" style="margin-bottom:10px">
            <div class="card-head"><div>AI Configuration</div></div>
            <div class="form" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div><label class="label">AI API Key</label><input id="aiApiKey" type="password" class="input" placeholder="sk-‚Ä¶ (OpenAI key)" onchange="updateAIStatus()"></div>
              <div><label class="label">OpenPhone API Key</label><input id="openphoneApiKey" type="password" class="input" placeholder="(optional)" onchange="updateOpenPhoneStatus()"></div>
            </div>
            <div class="form" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button class="btn btn-primary" onclick="testAIConnection()">üîó Test AI</button>
              <button class="btn" onclick="saveAIConfig()">üíæ Save</button>
              <div class="pill"><span id="aiDot" class="dot" style="background:var(--error)"></span><span id="aiText">AI Status: API Key Required</span></div>
            </div>
          </div>

          <div class="card">
            <div class="card-head"><div>AI Terminal Interface</div><div style="font-size:11px;color:var(--text-muted)">Try: ‚Äúshow customers‚Äù, ‚Äúsearch customers for dennis‚Äù, ‚Äúopen inventory‚Äù.</div></div>
            <div id="chatBox" style="height:420px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,rgba(255,255,255,.03),transparent)">
              <div class="assistant" style="align-self:flex-start;background:var(--bg-quaternary);border:1px solid var(--border);padding:12px;border-radius:12px">ü§ñ <b>TVC AI</b> is online.</div>
            </div>
            <div class="form" style="display:flex;gap:8px;background:var(--bg-tertiary);border-top:1px solid var(--border)">
              <input id="chatInput" class="input" placeholder="Ask for insights‚Ä¶" onkeypress="if(event.key==='Enter') sendMessage()">
              <button class="btn btn-primary" onclick="sendMessage()">Execute</button>
            </div>
          </div>
        </div>

        <!-- ANALYTICS (demo) -->
        <div id="analytics" class="page">
          <div class="card"><div class="card-head"><div>Analytics</div></div>
            <div class="form">Coming soon.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ========== APP SCRIPT ========== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ---------- STATE ---------- */
    const SUPABASE_URL = "https://zpgdsgutiheilshgrnwl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2RzZ3V0aWhlaWxzaGdybndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjA3NDMsImV4cCI6MjA3MDU5Njc0M30.LC-ro-E2k_Xb7UK337QP8V2HddpftjV5g1ZsI6D0c8k";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.db = db;

    let isListening=false, recognition=null, aiApiKey=null, openphoneApiKey=null;
    let customers=[], inventory=[], serviceOrders=[];
    let callHistory=[{id:1,dateTime:new Date(),phoneNumber:'555-0123',customer:'John Smith',duration:'12:45',leadScore:9,status:'transcribed'}];
    let emailHistory=[{id:1,date:new Date(),recipient:'john@email.com',subject:'Your BMW X5 Inquiry',type:'follow-up',status:'delivered'}];
    const $ = (id)=>document.getElementById(id);

    /* ---------- NAV ---------- */
    function findNav(id){ return document.querySelector(`.nav-item[onclick*="${id}"]`); }
    function showPage(id, el){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      if(el) el.classList.add('active');
      $('title').textContent = ({
        dashboard:'Executive Dashboard', customers:'Customer Pipeline', inventory:'Inventory', service:'Service Center',
        calls:'Call Center', emails:'Email Center', vin:'VIN Intelligence', chat:'AI Terminal', analytics:'Analytics'
      })[id] || 'Dashboard';
      if(window.innerWidth<=900) toggleSidebar(false);
      if(id==='service') populateVehicleDropdowns();
    }
    function toggleSidebar(force){ const s=$('sidebar'); s.classList[force===false?'remove':'toggle']('open'); }

    /* ---------- UTIL ---------- */
    function addActivity(icon,text,time='Just now'){ const box=$('activity'); const div=document.createElement('div'); div.style.padding='10px 12px'; div.innerHTML=`${icon} ${text} <span style="float:right;color:#999">${time}</span>`; box.prepend(div); while(box.children.length>18) box.removeChild(box.lastChild); }
    function currency(n){ return '$'+Number(n||0).toLocaleString(); }
    function leadClass(n){ if(n>=8) return 'score-high'; if(n>=6) return 'score-medium'; return 'score-low'; }

    /* ---------- CUSTOMERS UI ---------- */
    function renderCustomers(){
      const tbody=$('customerRows'); tbody.innerHTML='';
      if(customers.length===0){ tbody.innerHTML='<tr><td colspan="8" style="padding:16px;color:#999">No customers yet.</td></tr>'; return; }
      customers.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${c.firstName||''} ${c.lastName||''}</td>
          <td>${c.email||''}<br><span style="font-size:11px">${c.phone||''}</span></td>
          <td><span class="status status-${c.status||'new'}">${c.status||'new'}</span></td>
          <td><span class="lead ${leadClass(c.leadScore||7)}">${c.leadScore||7}</span></td>
          <td>${currency(c.value||0)}</td>
          <td>${c.vehicleInterest||''}<br><span style="font-size:11px">${c.budget||''}</span></td>
          <td>${c.lastContact||'‚Äî'}</td>
          <td><button class="btn btn-sm" onclick="viewCustomer('${c.id}')">View</button> <button class="btn btn-sm" onclick="removeCustomer('${c.id}')">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
      $('customerBadge').textContent=String(customers.length);
    }
    function filterCustomers(){
      const q=($('customerSearch').value||'').toLowerCase().trim();
      document.querySelectorAll('#customerRows tr').forEach(r=>{
        r.style.display = q ? (r.textContent.toLowerCase().includes(q)?'':'none') : '';
      });
    }
    function openCustomerForm(){ $('customerForm').style.display='block'; }
    function closeCustomerForm(){ $('customerForm').style.display='none'; }
    function viewCustomer(id){
      const c=customers.find(x=>String(x.id)===String(id)); if(!c){ alert('Customer not found'); return; }
      alert(`Customer\n\n${c.firstName||''} ${c.lastName||''}\nEmail: ${c.email||''}\nPhone: ${c.phone||''}\nInterest: ${c.vehicleInterest||''}\nBudget: ${c.budget||''}`);
    }

    /* ---------- INVENTORY UI ---------- */
    function renderInventory(){
      const tbody=$('invRows'); tbody.innerHTML='';
      inventory.forEach(v=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${v.vehicle}</td><td style="font-family:monospace;font-size:11px">${v.vin||'PENDING'}</td>
          <td><span class="status status-${v.status}">${v.status}</span></td>
          <td>${currency(v.price)}</td><td>${v.daysInStock||0}</td>
          <td><span class="status status-${v.serviceStatus==='ready'?'qualified':v.serviceStatus}">${v.serviceStatus}</span></td>
          <td><button class="btn btn-sm" onclick="viewVehicle(${JSON.stringify(v.id)})">View</button> <button class="btn btn-sm" onclick="deleteVehicle(${JSON.stringify(v.id)})">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      $('inventoryBadge').textContent=String(inventory.filter(v=>v.status==='available').length);
    }
    function filterInventory(){
      const q=($('invFilter').value||'').toLowerCase();
      document.querySelectorAll('#invRows tr').forEach(r=>{ r.style.display = r.textContent.toLowerCase().includes(q)?'':''; });
    }
    function openVehicleForm(){ $('vehicleForm').style.display='block'; }
    function closeVehicleForm(){ $('vehicleForm').style.display='none'; }
    function viewVehicle(id){ const v=inventory.find(x=>String(x.id)===String(id)); if(v) alert(`${v.vehicle}\nVIN: ${v.vin}\nPrice: ${currency(v.price)}\nStatus: ${v.status}\nService: ${v.serviceStatus}`); }

    /* ---------- SERVICE UI ---------- */
    function renderService(){
      const tbody=$('svcRows'); tbody.innerHTML='';
      serviceOrders.forEach(o=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${o.id}</td><td>${o.vehicle}</td><td>${o.customer}</td><td>${o.serviceType}</td>
          <td>${o.technician}</td><td><span class="status status-${o.status}">${o.status}</span></td>
          <td>${currency(o.cost)}</td>
          <td><button class="btn btn-sm" onclick="viewService('${o.id}')">View</button></td>`;
        tbody.appendChild(tr);
      });
      $('serviceBadge').textContent=String(serviceOrders.length);
    }
    function openServiceForm(){ $('serviceForm').style.display='block'; populateVehicleDropdowns(); }
    function closeServiceForm(){ $('serviceForm').style.display='none'; }
    function populateVehicleDropdowns(){
      const sel=$('svc_vehicle'); if(!sel) return;
      sel.innerHTML = '<option value="">Select‚Ä¶</option>' + inventory.map(v=>`<option value="${v.id}">${v.vehicle}</option>`).join('');
    }
    function viewService(id){ const o=serviceOrders.find(x=>String(x.id)===String(id)); if(o) alert(`Service ${o.id}\n\n${o.vehicle}\n${o.serviceType}\nStatus: ${o.status}\nCost: ${currency(o.cost)}`); }

    /* ---------- CALLS/EMAILS (demo render) ---------- */
    function renderCalls(){
      const tbody=$('callRows'); tbody.innerHTML='';
      callHistory.forEach(c=>{
        const tr=document.createElement('tr'); tr.innerHTML=`
          <td>${c.dateTime.toLocaleDateString()} ${c.dateTime.toLocaleTimeString()}</td>
          <td>${c.phoneNumber}</td><td>${c.customer}</td><td>${c.duration}</td>
          <td><span class="lead ${leadClass(c.leadScore)}">${c.leadScore}</span></td>
          <td><span class="status status-${c.status}">${c.status}</span></td>
          <td><button class="btn btn-sm" onclick="alert('Transcript‚Ä¶')">Transcript</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function simulateNewCall(){ callHistory.unshift({id:Date.now(),dateTime:new Date(),phoneNumber:'555-'+Math.floor(Math.random()*9000+1000),customer:'New Customer',duration:'5:'+String(Math.floor(Math.random()*60)).padStart(2,'0'),leadScore:8,status:'transcribed'}); renderCalls(); addActivity('üìû','New call received'); }
    function renderEmails(){ const tbody=$('emailRows'); tbody.innerHTML=''; emailHistory.forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.date.toLocaleString()}</td><td>${e.recipient}</td><td>${e.subject}</td><td><span class="status status-${e.type}">${e.type}</span></td><td><span class="status status-${e.status}">${e.status}</span></td><td><button class="btn btn-sm" onclick="alert('Email view‚Ä¶')">View</button></td>`; tbody.appendChild(tr); }); }
    function createEmailCampaign(){ const subject=prompt('Subject?'); if(subject){ emailHistory.unshift({id:Date.now(),date:new Date(),recipient:'all@customers.com',subject,type:'campaign',status:'sent'}); renderEmails(); addActivity('üìß','Email campaign sent'); } }

    /* ---------- VIN ---------- */
    async function decodeVIN(){
      const vin=$('v_vin').value.trim(); if(vin.length!==17){ alert('Enter a 17‚Äëchar VIN'); return; }
      try{ const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const get=v=>d.Results.find(x=>x.Variable===v)?.Value||''; $('v_make').value=get('Make'); $('v_model').value=get('Model'); $('v_year').value=get('Model Year'); alert('VIN decoded!'); }catch{ alert('VIN decode error'); }
    }
    async function scanVIN(){
      const vin=$('vinInput').value.trim(); if(vin.length!==17){ alert('Enter 17‚Äëchar VIN'); return; }
      const wrap=$('vinResult'), box=$('vinData'); wrap.style.display='block'; box.innerHTML='Decoding‚Ä¶';
      try{ const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const g=v=>d.Results.find(x=>x.Variable===v)?.Value||'‚Äî'; box.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px"><div><div class="label">Make</div>${g('Make')}</div><div><div class="label">Model</div>${g('Model')}</div><div><div class="label">Year</div>${g('Model Year')}</div><div><div class="label">Body</div>${g('Body Class')}</div><div><div class="label">Engine</div>${g('Engine Model')}</div></div>`; addActivity('üîç','VIN decoded'); }catch{ box.innerHTML='<span style="color:#f66">VIN decode failed</span>'; }
    }

    /* ---------- EXPORT/REFRESH ---------- */
    function exportData(){ alert(`Export\n\nCustomers: ${customers.length}\nVehicles: ${inventory.length}\nService Orders: ${serviceOrders.length}`); }
    async function refreshData(){
      await Promise.all([ loadCustomersFromDB(), loadInventoryFromDB(), loadServiceFromDB() ]);
      renderCustomers(); renderInventory(); renderService(); renderCalls(); renderEmails();
      addActivity('üîÑ','Data refreshed'); alert('Refreshed!');
    }

    /* ---------- SUPABASE: MAP HELPERS ---------- */
    function mapRowToCustomer(row){
      const name=(row["Name"]??row.name??"").toString().trim();
      const [first,...rest]=name.split(/\s+/); const last=rest.join(' ');
      const b=String(row["Budget"]??row.budget??''); const val=parseInt(b.replace(/[^0-9]/g,''))||0;
      return {
        id: row.id ?? row.ID ?? row.uuid ?? row["ID"] ?? Date.now(),
        firstName:first||'', lastName:last||'',
        email:row["Email"]??row.email??'', phone:row["Phone"]??row.phone??'',
        vehicleInterest:row["Vehicle of interest"]??row.vehicle_interest??'',
        budget:row["Budget"]??row.budget??'', address:row["Address"]??row.address??'',
        currentVehicle:row["Current Vehicle/Trade in"]??row.current_vehicle??'',
        status:'new', leadScore:8, value:val, lastContact:'‚Äî'
      };
    }
    function mapRowToVehicle(row){
      return {
        id: row.id, vin: row.vin||'PENDING', make:row.make||'', model:row.model||'', year:row.year,
        vehicle: `${row.year||''} ${row.make||''} ${row.model||''}`.trim(),
        status: row.status||'available', price:Number(row.price)||0, daysInStock:row.days_in_stock??0,
        serviceStatus: row.service_status||'pending'
      };
    }
    function mapRowToService(row){
      return {
        id: row.order_no || row.id, vehicle: row.vehicle||'Unknown', customer: row.customer||'Walk-in',
        serviceType: row.service_type||'inspection', technician: row.technician||'Unassigned',
        status: row.status||'pending', cost:Number(row.cost)||0, date: row.created_at?new Date(row.created_at):new Date()
      };
    }

    /* ---------- SUPABASE: LOAD ---------- */
    async function loadCustomersFromDB(){
      try{
        let { data, error } = await db.from('customers').select('*').order('created_at',{ascending:false});
        if(error){ ({data,error} = await db.from('customers').select('*')); }
        if(error) throw error;
        customers.length=0; (data||[]).forEach(r=>customers.push(mapRowToCustomer(r)));
      }catch(e){ console.warn('customers load:', e.message||e); }
    }
    async function loadInventoryFromDB(){
      try{
        const { data, error } = await db.from('vehicles').select('*').order('created_at',{ascending:false});
        if(error) throw error;
        inventory.length=0; (data||[]).forEach(r=>inventory.push(mapRowToVehicle(r)));
      }catch(e){ console.warn('vehicles load:', e.message||e); }
    }
    async function loadServiceFromDB(){
      try{
        const { data, error } = await db.from('service_orders').select('*').order('created_at',{ascending:false});
        if(error) throw error;
        serviceOrders.length=0; (data||[]).forEach(r=>serviceOrders.push(mapRowToService(r)));
      }catch(e){ console.warn('service load:', e.message||e); }
    }

    /* ---------- SUPABASE: CREATE/DELETE ---------- */
    async function addCustomer(){
      const name=$('c_name').value.trim(); if(!name){ alert('Enter a name'); return; }
      const row={
        ["Name"]:name, ["Address"]:$('c_address').value.trim(), ["Email"]:$('c_email').value.trim(),
        ["Phone"]:$('c_phone').value.trim(), ["Vehicle of interest"]:$('c_interest').value.trim(),
        ["Current Vehicle/Trade in"]:$('c_current').value.trim(), ["Budget"]:$('c_budget').value.trim()
      };
      try{
        const { error } = await db.from('customers').insert([row]);
        if(error) throw error;
        await loadCustomersFromDB(); renderCustomers();
        ['c_name','c_address','c_email','c_phone','c_interest','c_current','c_budget'].forEach(id=>$(id).value='');
        closeCustomerForm(); addActivity('üë§',`New customer: ${name}`);
      }catch(e){
        alert('Could not save customer: '+(e.message||e));
      }
    }
    async function removeCustomer(id){
      if(!confirm('Delete this customer?')) return;
      try{
        let { error } = await db.from('customers').delete().eq('id', id);
        if(error && /column "id"/i.test(error.message)) ({ error } = await db.from('customers').delete().eq('ID', id));
      }catch(_){}
      customers = customers.filter(c=>String(c.id)!==String(id)); renderCustomers();
    }

    async function addVehicle(){
      const vin=$('v_vin').value.trim(), make=$('v_make').value.trim(), model=$('v_model').value.trim(),
            year=Number($('v_year').value), price=Number($('v_price').value), status=$('v_status').value;
      if(!(make&&model&&year&&price)){ alert('Fill make, model, year, price'); return; }
      try{
        const { error } = await db.from('vehicles').insert([{ vin, make, model, year, price, status, service_status:'pending', days_in_stock:0 }]);
        if(error) throw error;
        await loadInventoryFromDB(); renderInventory(); populateVehicleDropdowns(); closeVehicleForm();
        addActivity('üöó',`New vehicle: ${year} ${make} ${model}`);
        ['v_vin','v_make','v_model','v_year','v_price'].forEach(id=>$(id).value='');
      }catch(e){ alert('Could not save vehicle: '+(e.message||e)); }
    }
    async function deleteVehicle(id){
      if(!confirm('Delete this vehicle?')) return;
      try{ await db.from('vehicles').delete().eq('id', id); }catch(_){}
      inventory = inventory.filter(v=>String(v.id)!==String(id)); renderInventory(); populateVehicleDropdowns();
    }

    async function submitServiceOrder(){
      const vehicleId=$('svc_vehicle').value, type=$('svc_type').value, priority=$('svc_priority').value, notes=$('svc_notes').value.trim();
      if(!vehicleId){ alert('Pick a vehicle'); return; }
      const v=inventory.find(x=>String(x.id)===String(vehicleId));
      const status = priority==='urgent' ? 'in-progress' : 'pending';
      const payload = { order_no:`SO-${Date.now()}`, vehicle:v?.vehicle||'Unknown', vehicle_id:v?.id||null, customer:'Walk-in', service_type:type, technician:'Unassigned', status, cost:Math.floor(Math.random()*500)+100, notes, priority };
      try{
        const { error } = await db.from('service_orders').insert([payload]);
        if(error) throw error;
        await loadServiceFromDB(); renderService(); closeServiceForm();
        addActivity('üîß',`Service order ${payload.order_no} created`);
      }catch(e){ alert('Could not save service order: '+(e.message||e)); }
    }

    /* ---------- AI ---------- */
    function addChatMessage(role, html){
      const box=$('chatBox'); const div=document.createElement('div');
      div.className=(role==='user'?'user':'assistant');
      div.style.alignSelf = role==='user'?'flex-end':'flex-start';
      div.style.background = role==='user'?'linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary))':'var(--bg-quaternary)';
      div.style.color = role==='user'?'#fff':'#fff'; div.style.border='1px solid var(--border)';
      div.style.padding='12px'; div.style.borderRadius='12px'; div.innerHTML=html;
      box.appendChild(div); box.scrollTop=box.scrollHeight;
    }
    function updateAIStatus(){
      const k=$('aiApiKey').value.trim(); aiApiKey = k||null;
      $('aiDot').style.background = aiApiKey?'var(--success)':'var(--error)';
      $('aiText').textContent = aiApiKey?'AI Status: Connected':'AI Status: API Key Required';
    }
    function updateOpenPhoneStatus(){ openphoneApiKey=$('openphoneApiKey').value.trim(); }
    function saveAIConfig(){ updateAIStatus(); updateOpenPhoneStatus(); alert('Saved'); }

    async function callOpenAI(prompt){
      if(!aiApiKey) throw new Error('No AI API key set');
      const payload={
        model:'gpt-4o-mini',
        temperature:0.2,
        messages:[
          {role:'system',content:'You are TVC Auto AI. Be concise.'},
          {role:'user',content:`DATA\nCustomers: ${JSON.stringify(customers.slice(0,30))}\nInventory: ${JSON.stringify(inventory.slice(0,30))}\nService: ${JSON.stringify(serviceOrders.slice(0,30))}\n\nQUESTION: ${prompt}`}
        ]
      };
      const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+aiApiKey},body:JSON.stringify(payload)});
      if(!r.ok){ throw new Error('OpenAI error '+r.status+': '+(await r.text())); }
      const j=await r.json(); return j.choices?.[0]?.message?.content?.trim()||'(no response)';
    }

    async function processAI(text){
      const t=(text||'').toLowerCase().trim(); const go=(id)=>showPage(id,findNav(id));
      const ensure=async()=>{ if(customers.length===0) await loadCustomersFromDB(); };

      if (/(show|open|go to)\s+(customers?|inventory|service|dashboard|chat|terminal|ai)/.test(t)){
        const map={customer:'customers',customers:'customers',inventory:'inventory',service:'service',dashboard:'dashboard',chat:'chat',terminal:'chat',ai:'chat'};
        const key=t.match(/(customers?|inventory|service|dashboard|chat|terminal|ai)/)[1];
        go(map[key]); if(map[key]==='customers'){ await ensure(); addChatMessage('assistant',`Opened Customers. Total <b>${customers.length}</b>.`);} else addChatMessage('assistant',`Opened <b>${map[key]}</b>.`); return true;
      }
      let m=t.match(/^(search|find)\s+(customers?|customer)\s+(for\s+)?(.+)/);
      if(m&&m[4]){ const q=m[4].trim(); await ensure(); go('customers'); $('customerSearch').value=q; filterCustomers(); const n=[...document.querySelectorAll('#customerRows tr')].filter(r=>r.style.display!=='none').length; addChatMessage('assistant',`Customer search "<b>${q}</b>": <b>${n}</b>.`); return true; }
      m=t.match(/^(view|open|show)\s+customer\s+(.+)/);
      if(m&&m[2]){ const q=m[2].trim(); await ensure(); go('customers'); const c=customers.find(x=>(`${x.firstName} ${x.lastName}`).toLowerCase().includes(q.toLowerCase())); if(c){ viewCustomer(c.id); addChatMessage('assistant',`Opening <b>${c.firstName} ${c.lastName}</b>.`);} else addChatMessage('assistant',`No customer for "<b>${q}</b>".`); return true; }
      m=t.match(/^(search|find)\s+inventory\s+(for\s+)?(.+)/);
      if(m&&m[3]){ const q=m[3].trim(); go('inventory'); $('invFilter').value=q; filterInventory(); const n=[...document.querySelectorAll('#invRows tr')].filter(r=>r.style.display!=='none').length; addChatMessage('assistant',`Inventory search "<b>${q}</b>": <b>${n}</b>.`); return true; }

      return false;
    }

    async function sendMessage(){
      const i=$('chatInput'); const msg=i.value.trim(); if(!msg) return; addChatMessage('user',msg); i.value='';
      const handled=await processAI(msg);
      if(!handled){
        if(!aiApiKey){ addChatMessage('assistant','‚ÑπÔ∏è No AI key set. Local commands still work.'); return; }
        try{ const out=await callOpenAI(msg); addChatMessage('assistant',out); }catch(e){ addChatMessage('assistant','‚ùå '+(e.message||e)); }
      }
    }
    async function testAIConnection(){
      try{ if(!$('aiApiKey').value.trim()){ alert('Paste your OpenAI key first'); return; } aiApiKey=$('aiApiKey').value.trim(); const ok=await callOpenAI('Reply with OK.'); addChatMessage('assistant','‚úÖ AI connected: '+ok); updateAIStatus(); }
      catch(e){ alert('AI test failed: '+(e.message||e)); }
    }

    /* ---------- VOICE ---------- */
    function initVoice(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ console.warn('No Web Speech API'); return; }
      recognition=new SR(); recognition.lang='en-US'; recognition.interimResults=true; recognition.continuous=true;
      recognition.onresult=(e)=>{ let final=''; for(let i=e.resultIndex;i<e.results.length;i++){ const tr=e.results[i][0].transcript; if(e.results[i].isFinal) final+=tr; } if(final.trim()){ addChatMessage('user','üéôÔ∏è '+final.trim()); processAI(final.trim()); } };
      recognition.onerror=(e)=>{ console.warn('voice error',e.error); if(e.error==='not-allowed') alert('Allow microphone'); };
      recognition.onend=()=>{ if(isListening) try{ recognition.start(); }catch{}; updateVoiceBtn(); };
    }
    function updateVoiceBtn(){ const b=$('voiceBtn'); b.textContent=isListening?'üéôÔ∏è Listening‚Ä¶ (tap to stop)':'üé§ Voice'; }
    function startVoice(){ if(!recognition){ alert('Use Chrome/Edge for voice'); return; } try{ recognition.start(); isListening=true; updateVoiceBtn(); addActivity('üéôÔ∏è','Voice on'); }catch{} }
    function stopVoice(){ if(recognition) try{ recognition.stop(); }catch{} isListening=false; updateVoiceBtn(); addActivity('üéôÔ∏è','Voice off'); }
    function toggleVoice(){ isListening?stopVoice():startVoice(); }

    /* ---------- STARTUP ---------- */
    document.addEventListener('DOMContentLoaded', async ()=>{
      initVoice();
      await Promise.all([ loadCustomersFromDB(), loadInventoryFromDB(), loadServiceFromDB() ]);
      renderCustomers(); renderInventory(); renderService(); renderCalls(); renderEmails();
      addActivity('‚úÖ','Loaded data');
    });
  </script>
</body>
</html>
