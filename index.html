<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TVC Auto AI Pro - Advanced Dealership Intelligence Terminal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
<style>
  /* ===== THEME ===== */
  :root{
    --bg-primary:#0a0a0a; --bg-secondary:#141418; --bg-tertiary:#1e1e24; --bg-quaternary:#28282f;
    --bg-hover:#32323a; --glass-bg:rgba(20,20,24,.8); --glass-border:rgba(255,255,255,.08);
    --text-primary:#f5f5f7; --text-secondary:#a1a1aa; --text-muted:#8a8a92;
    --accent-primary:#8b6914; --accent-secondary:#6b5210; --accent-tertiary:#a57c1e; --accent-glow:rgba(139,105,20,.28);
    --accent-bright:#b8901f; --border:#26262b;
    --success:#10b981; --warning:#f59e0b; --error:#ef4444; --info:#3b82f6;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(135deg,#0a0a0a 0%,#141418 100%); color:var(--text-primary);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-size:13px;
  }
  body::before{
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image:
      radial-gradient(600px 300px at 20% 50%, var(--accent-glow) 0%, transparent 60%),
      radial-gradient(500px 240px at 80% 80%, rgba(16,185,129,.12) 0%, transparent 60%);
  }

  /* ===== LAYOUT ===== */
  .terminal{display:grid; grid-template-columns:260px 1fr; grid-template-rows:64px 1fr; height:100vh; gap:1px; background:var(--border);}
  .topbar{grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; padding:0 14px 0 10px; background:var(--glass-bg); border-bottom:1px solid var(--glass-border); position:sticky; top:0; z-index:3}
  .logo{display:flex;align-items:center;gap:10px}
  .logo-badge{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary));display:flex;align-items:center;justify-content:center;box-shadow:0 0 18px var(--accent-glow)}
  .logo-text{font-weight:800;font-size:16px;background:linear-gradient(135deg,var(--text-primary),var(--accent-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .hamburger{display:none;border:1px solid var(--glass-border);background:var(--bg-tertiary);color:var(--text-primary);padding:8px 10px;border-radius:8px}
  .kpis{display:flex;gap:18px}
  .k{display:flex;gap:8px;align-items:center;background:var(--bg-secondary);border:1px solid var(--border);padding:6px 10px;border-radius:10px;font-size:12px}
  .k .v{font-weight:700}
  .k .chg{font-size:11px;border-radius:6px;padding:2px 6px}
  .chg.pos{color:var(--success);background:rgba(16,185,129,.15)}
  .actions{display:flex;gap:8px;align-items:center}
  .status{display:flex;gap:8px;align-items:center;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);padding:6px 10px;border-radius:20px;font-size:11px;color:var(--success)}
  .dot{width:6px;height:6px;border-radius:50%;background:var(--success);box-shadow:0 0 8px var(--success)}
  .btn{border:1px solid var(--glass-border);background:var(--bg-tertiary);color:var(--text-primary);padding:9px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary)); border:none}
  .btn.sm{padding:6px 10px;font-size:12px}

  .sidebar{background:var(--bg-secondary);border-right:1px solid var(--border);overflow:auto}
  .navgrp{padding:14px 10px}
  .navttl{color:var(--text-muted);text-transform:uppercase;font-size:10px;font-weight:800;letter-spacing:.6px;margin:6px 6px 10px}
  .nav{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--text-secondary)}
  .nav:hover{background:var(--bg-tertiary);color:var(--text-primary);transform:translateX(2px)}
  .nav.active{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:#fff}
  .badge{margin-left:auto;background:var(--error);padding:2px 7px;border-radius:12px;font-size:10px;font-weight:800}

  .main{display:flex;flex-direction:column;min-width:0}
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:var(--glass-bg)}
  .title{font-weight:800;font-size:18px}
  .content{flex:1;min-width:0;overflow:auto;padding:18px;background:linear-gradient(180deg,transparent,rgba(139,105,20,.025)); position:relative; z-index:1}
  .page{display:none;animation:fade .25s ease}
  .page.active{display:block}
  @keyframes fade{from{opacity:.5;transform:translateY(6px)} to{opacity:1;transform:none}}

  /* ===== CARDS & TABLES ===== */
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
  .card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:16px}
  .card:hover{border-color:var(--accent-primary);background:var(--bg-tertiary);box-shadow:0 12px 24px rgba(139,105,20,.18)}
  .card .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .chip{font-size:11px;font-weight:800;padding:3px 8px;border-radius:6px;background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.25)}
  .big{font-size:26px;font-weight:900;background:linear-gradient(135deg,var(--text-primary),var(--accent-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

  .wrap{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .tblhdr{display:flex;align-items:center;justify-content:space-between;background:var(--bg-tertiary);padding:12px 14px;border-bottom:1px solid var(--border)}
  .tblttl{font-weight:800}
  .table{width:100%;border-collapse:collapse;min-width:800px}
  .table th{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;background:var(--bg-quaternary);padding:10px;text-align:left;border-bottom:1px solid var(--border)}
  .table td{padding:12px;border-bottom:1px solid var(--border)}
  .wrap.scroll{overflow:auto}
  .status-badge{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:800;text-transform:uppercase}
  .status-new,.status-follow{background:rgba(245,158,11,.15);color:var(--warning);border:1px solid rgba(245,158,11,.3)}
  .status-hot{background:rgba(239,68,68,.15);color:var(--error);border:1px solid rgba(239,68,68,.3)}
  .status-qualified{background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.3)}
  .lead-score{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:800;display:inline-block}
  .score-high{background:rgba(16,185,129,.15);color:var(--success);border:1px solid rgba(16,185,129,.3)}
  .score-medium{background:rgba(245,158,11,.15);color:var(--warning);border:1px solid rgba(245,158,11,.3)}
  .score-low{background:rgba(239,68,68,.15);color:var(--error);border:1px solid rgba(239,68,68,.3)}

  .form{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:16px;max-width:650px;margin:16px auto}
  .fg{margin-bottom:14px}
  .lbl{display:block;font-size:11px;font-weight:800;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
  .in,.sel,.ta{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btnbar{display:flex;gap:10px;align-items:center}

  /* ===== CHAT / VOICE ===== */
  .chat{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;max-width:900px;margin:0 auto}
  .msgs{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,var(--bg-secondary),var(--bg-tertiary))}
  .msg{max-width:78%;padding:12px 14px;border-radius:12px}
  .msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary));color:#fff}
  .msg.ai{align-self:flex-start;background:var(--bg-quaternary);border:1px solid var(--glass-border)}
  .chatbar{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);background:var(--bg-tertiary)}
  .chatbar .in{flex:1}

  /* ===== MOBILE ===== */
  @media (max-width:1100px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:820px){
    .terminal{grid-template-columns:1fr}
    .sidebar{position:fixed;z-index:4;top:64px;bottom:0;left:0;right:0;max-width:280px;transform:translateX(-100%);transition:.25s}
    .sidebar.open{transform:translateX(0)}
    .hamburger{display:inline-block}
    .kpis{display:none}
    .grid{grid-template-columns:1fr}
    .wrap.scroll{overflow:auto}
    .table{min-width:700px}
  }
</style>
</head>
<body>
<div class="terminal">
  <!-- ===== TOP BAR ===== -->
  <div class="topbar">
    <div class="logo">
      <button class="hamburger" onclick="toggleSidebar()">☰ Menu</button>
      <div class="logo-badge">⚡</div>
      <div class="logo-text">TVC Auto AI Pro</div>
    </div>
    <div class="kpis">
      <div class="k"><span>Revenue</span><span class="v" id="kRevenue">$487K</span><span class="chg pos" id="kRevenueChg">+12%</span></div>
      <div class="k"><span>Leads</span><span class="v" id="kLeads">0</span><span class="chg pos" id="kLeadsChg">+0</span></div>
      <div class="k"><span>Calls</span><span class="v" id="kCalls">12</span><span class="chg pos" id="kCallsChg">+3</span></div>
      <div class="k"><span>Service</span><span class="v" id="kService">8</span><span class="chg pos" id="kServiceChg">+2</span></div>
    </div>
    <div class="actions">
      <div class="status"><div class="dot"></div><span>LIVE DATA</span></div>
      <button class="btn" id="voiceBtn" onclick="toggleVoice()">🎤 Voice</button>
      <button class="btn primary" onclick="showPage('chat', navSel('chat'))">🤖 AI Terminal</button>
    </div>
  </div>

  <!-- ===== SIDEBAR ===== -->
  <div class="sidebar" id="sidebar">
    <div class="navgrp">
      <div class="navttl">Overview</div>
      <div class="nav active" onclick="showPage('dashboard', this)"><span>📊</span>Dashboard</div>
      <div class="nav" onclick="showPage('analytics', this)"><span>📈</span>Analytics</div>
    </div>
    <div class="navgrp">
      <div class="navttl">Operations</div>
      <div class="nav" onclick="showPage('customers', this)"><span>👥</span>Customers <span class="badge" id="bCustomers">0</span></div>
      <div class="nav" onclick="showPage('inventory', this)"><span>🚗</span>Inventory <span class="badge" id="bInventory" style="background:var(--success)">0</span></div>
      <div class="nav" onclick="showPage('service', this)"><span>🔧</span>Service Center <span class="badge" id="bService" style="background:var(--warning)">8</span></div>
      <div class="nav" onclick="showPage('photos', this)"><span>📸</span>Photo Manager <span class="badge" id="bPhotos" style="background:var(--accent-primary)">0</span></div>
    </div>
    <div class="navgrp">
      <div class="navttl">Communication</div>
      <div class="nav" onclick="showPage('calls', this)"><span>📞</span>Call Center <span class="badge" id="bCalls" style="background:var(--accent-primary)">12</span></div>
      <div class="nav" onclick="showPage('emails', this)"><span>📧</span>Email Center <span class="badge" id="bEmails" style="background:var(--success)">5</span></div>
    </div>
    <div class="navgrp">
      <div class="navttl">Intelligence</div>
      <div class="nav" onclick="showPage('vin', this)"><span>🔍</span>VIN Scanner</div>
      <div class="nav" onclick="showPage('chat', this)"><span>🤖</span>AI Terminal</div>
    </div>
  </div>

  <!-- ===== MAIN ===== -->
  <div class="main">
    <div class="header">
      <div class="title" id="pageTitle">Executive Dashboard</div>
      <div class="btnbar">
        <button class="btn" onclick="exportData()">📊 Export</button>
        <button class="btn" onclick="refreshAll()">🔄 Refresh</button>
      </div>
    </div>

    <div class="content">
      <!-- DASHBOARD -->
      <div class="page active" id="dashboard">
        <div class="grid">
          <div class="card" onclick="openMetric('revenue')">
            <div class="hdr"><div>Revenue</div><div class="chip" id="dRevChg">+12%</div></div>
            <div class="big" id="dRev">$487K</div>
            <div id="dRevSub">vs $435K last month</div>
          </div>
          <div class="card" onclick="openMetric('leads')">
            <div class="hdr"><div>Active Leads</div><div class="chip" id="dLeadsChg">+33%</div></div>
            <div class="big" id="dLeads">0</div>
            <div id="dLeadsSub">pipeline</div>
          </div>
          <div class="card" onclick="openMetric('service')">
            <div class="hdr"><div>Service Orders</div><div class="chip" id="dSvcChg">+25%</div></div>
            <div class="big" id="dSvc">8</div>
            <div id="dSvcSub">5 active • 3 pending</div>
          </div>
          <div class="card" onclick="openMetric('saleTime')">
            <div class="hdr"><div>Avg Sale Time</div><div class="chip">-7d</div></div>
            <div class="big" id="dSaleTime">14</div>
            <div>days (industry: 21d)</div>
          </div>
        </div>

        <div class="wrap">
          <div class="tblhdr"><div class="tblttl">Live Activity</div></div>
          <div id="activity" style="max-height:320px;overflow:auto">
            <div style="padding:12px;color:var(--text-muted)">System ready.</div>
          </div>
        </div>
      </div>

      <!-- SERVICE -->
      <div class="page" id="service">
        <div class="wrap scroll">
          <div class="tblhdr">
            <div class="tblttl">Service Work Orders</div>
            <button class="btn primary" onclick="createServiceOrder()">+ New Service Order</button>
          </div>
          <table class="table"><thead>
            <tr><th>Order #</th><th>Vehicle</th><th>Customer</th><th>Service Type</th><th>Technician</th><th>Status</th><th>Est. Cost</th><th>Actions</th></tr>
          </thead><tbody id="serviceBody"></tbody></table>
        </div>

        <div class="form" id="serviceForm" style="display:none">
          <div class="tblhdr" style="margin:-16px -16px 12px -16px"><div class="tblttl">Create Service Order</div></div>
          <div class="fg"><label class="lbl">Vehicle</label><select id="svcVehicle" class="sel"><option value="">Select vehicle…</option></select></div>
          <div class="row">
            <div class="fg" style="flex:1"><label class="lbl">Service Type</label>
              <select id="svcType" class="sel"><option value="reconditioning">Reconditioning</option><option value="oil-change">Oil Change</option><option value="inspection">Inspection</option><option value="brake-service">Brake Service</option><option value="tire-rotation">Tire Rotation</option><option value="major-repair">Major Repair</option><option value="warranty">Warranty Service</option></select>
            </div>
            <div class="fg" style="width:160px"><label class="lbl">Priority</label>
              <select id="svcPriority" class="sel"><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select>
            </div>
          </div>
          <div class="fg"><label class="lbl">Notes</label><textarea id="svcNotes" class="ta" rows="4"></textarea></div>
          <button class="btn primary" onclick="submitServiceOrder()" style="width:100%">Create Order</button>
          <button class="btn" onclick="closeServiceForm()" style="width:100%;margin-top:8px">Cancel</button>
        </div>
      </div>

      <!-- AI TERMINAL -->
      <div class="page" id="chat">
        <div class="form" style="margin-bottom:16px">
          <div class="tblhdr" style="margin:-16px -16px 12px -16px"><div class="tblttl">AI Configuration</div></div>
          <div class="row">
            <div class="fg" style="flex:1"><label class="lbl">OpenAI API Key</label><input type="password" id="aiKey" class="in" placeholder="sk-..." onchange="updateAIStatus()"></div>
            <div class="fg" style="flex:1"><label class="lbl">OpenPhone API Key (optional)</label><input type="password" id="opKey" class="in" placeholder="..." onchange="updateOpenPhoneStatus()"></div>
          </div>
          <div class="btnbar">
            <button class="btn primary" onclick="testAI()">🔗 Test AI</button>
            <button class="btn primary" onclick="testOpenPhone()">📞 Test OpenPhone</button>
            <button class="btn" onclick="saveAI()">💾 Save Config</button>
            <div style="display:flex;align-items:center;gap:10px"><div id="aiDot" style="width:10px;height:10px;border-radius:50%;background:var(--error)"></div><div id="aiText">AI Status: API Key Required</div></div>
          </div>
        </div>

        <div class="chat">
          <div class="tblhdr"><div class="tblttl">AI Terminal Interface</div><div style="font-size:11px;color:var(--text-muted)">Say/type: “show customers”, “search customers for Dennis”, “open inventory”, “add customer”</div></div>
          <div class="msgs" id="msgs">
            <div class="msg ai">🤖 <b>TVC AI Terminal Online</b><br><br>Ask about service, customers, or inventory.</div>
          </div>
          <div class="chatbar">
            <input class="in" id="chatIn" placeholder="Ask for insights..." onkeypress="if(event.key==='Enter') sendMessage()"/>
            <button class="btn primary" onclick="sendMessage()">Execute</button>
          </div>
        </div>
      </div>

      <!-- CUSTOMERS -->
      <div class="page" id="customers">
        <div class="wrap scroll">
          <div class="tblhdr">
            <div class="tblttl">Customer Pipeline Management</div>
            <div class="row" style="align-items:center">
              <input class="in" id="custSearch" placeholder="Search name, email, or phone…" style="width:260px" oninput="filterCustomers()" />
              <button class="btn sm" onclick="document.getElementById('custSearch').value='';filterCustomers()">Clear</button>
              <button class="btn primary" onclick="openCustomerForm()">+ Add Customer</button>
            </div>
          </div>
          <table class="table"><thead>
            <tr><th>Customer</th><th>Contact</th><th>Status</th><th>Lead Score</th><th>Potential Value</th><th>Interest</th><th>Last Contact</th><th>Actions</th></tr>
          </thead><tbody id="custBody"><tr><td colspan="8" style="padding:12px;color:var(--text-muted)">Loading…</td></tr></tbody></table>
        </div>

        <div class="form" id="custForm" style="display:none">
          <div class="tblhdr" style="margin:-16px -16px 12px -16px"><div class="tblttl">Add New Customer</div></div>
          <div class="fg"><label class="lbl">Name</label><input class="in" id="cName" placeholder="John Smith" required></div>
          <div class="fg"><label class="lbl">Address</label><input class="in" id="cAddress" placeholder="123 Main St, City, ST"></div>
          <div class="row">
            <div class="fg" style="flex:1"><label class="lbl">Email</label><input class="in" id="cEmail" placeholder="john@example.com"></div>
            <div class="fg" style="flex:1"><label class="lbl">Phone</label><input class="in" id="cPhone" placeholder="555-123-4567"></div>
          </div>
          <div class="row">
            <div class="fg" style="flex:1"><label class="lbl">Vehicle of Interest</label><input class="in" id="cVoI" placeholder="2024 BMW X5"></div>
            <div class="fg" style="flex:1"><label class="lbl">Current Vehicle</label><input class="in" id="cCurrent" placeholder="2018 Honda Accord"></div>
          </div>
          <div class="row">
            <div class="fg" style="flex:1"><label class="lbl">Budget</label><input class="in" id="cBudget" placeholder="$50,000–$70,000"></div>
            <div class="fg" style="width:200px"><label class="lbl">Status</label>
              <select class="sel" id="cStatus"><option value="new">New Inquiry</option><option value="hot">Hot Lead</option><option value="qualified">Qualified</option><option value="follow">Follow Up</option></select>
            </div>
          </div>
          <button class="btn primary" onclick="addCustomer()" style="width:100%">Add Customer</button>
          <button class="btn" onclick="closeCustomerForm()" style="width:100%;margin-top:8px">Cancel</button>
        </div>
      </div>

      <!-- INVENTORY -->
      <div class="page" id="inventory">
        <div class="wrap scroll">
          <div class="tblhdr">
            <div class="tblttl">Vehicle Inventory Management</div>
            <div class="row">
              <input class="in" id="invFilter" placeholder="Filter…" style="width:200px" oninput="filterInventory()">
              <button class="btn primary" onclick="openVehicleForm()">+ Add Vehicle</button>
            </div>
          </div>
          <table class="table"><thead>
            <tr><th>Vehicle</th><th>VIN</th><th>Status</th><th>Price</th><th>Days in Stock</th><th>Service Status</th><th>Actions</th></tr>
          </thead><tbody id="invBody"></tbody></table>
        </div>

        <div class="form" id="vehForm" style="display:none">
          <div class="tblhdr" style="margin:-16px -16px 12px -16px"><div class="tblttl">Add New Vehicle</div></div>
          <div class="fg"><label class="lbl">VIN</label>
            <div class="row"><input class="in" id="vVIN" placeholder="Enter 17-character VIN" maxlength="17" style="flex:1"><button class="btn primary" onclick="decodeVIN()">Decode</button></div>
          </div>
          <div class="row">
            <div class="fg" style="flex:1"><label class="lbl">Make</label><input class="in" id="vMake"></div>
            <div class="fg" style="flex:1"><label class="lbl">Model</label><input class="in" id="vModel"></div>
          </div>
          <div class="row">
            <div class="fg" style="width:160px"><label class="lbl">Year</label><input class="in" id="vYear" type="number"></div>
            <div class="fg" style="flex:1"><label class="lbl">Price</label><input class="in" id="vPrice" type="number"></div>
            <div class="fg" style="width:200px"><label class="lbl">Status</label>
              <select class="sel" id="vStatus"><option value="available">Available</option><option value="reserved">Reserved</option><option value="sold">Sold</option><option value="incoming">Incoming</option></select>
            </div>
          </div>
          <button class="btn primary" onclick="addVehicle()" style="width:100%">Add Vehicle</button>
          <button class="btn" onclick="closeVehicleForm()" style="width:100%;margin-top:8px">Cancel</button>
        </div>
      </div>

      <!-- PHOTOS -->
      <div class="page" id="photos">
        <div class="form">
          <div class="tblhdr" style="margin:-16px -16px 12px -16px"><div class="tblttl">Vehicle Photo Management</div></div>
          <div class="row" style="margin-bottom:12px">
            <button class="btn primary" onclick="startCamera()">📷 Start Camera</button>
            <button class="btn" onclick="stopCamera()">⏹️ Stop Camera</button>
            <button class="btn primary" id="capBtn" onclick="capturePhoto()" disabled>📸 Capture</button>
            <input id="fileIn" type="file" accept="image/*" style="display:none" onchange="uploadPhoto(event)">
            <button class="btn" onclick="document.getElementById('fileIn').click()">📁 Upload</button>
          </div>
          <div class="row" style="align-items:flex-start">
            <video id="cam" style="display:none;width:320px;height:240px;background:var(--bg-tertiary);border:2px solid var(--glass-border);border-radius:12px" autoplay playsinline></video>
            <canvas id="canvas" style="display:none"></canvas>
            <div style="min-width:220px">
              <div class="fg"><label class="lbl">Select Vehicle</label><select id="photoVeh" class="sel"><option value="">Choose vehicle…</option></select></div>
              <div class="fg"><label class="lbl">Photo Type</label><select id="photoType" class="sel"><option value="exterior">Exterior</option><option value="interior">Interior</option><option value="engine">Engine</option><option value="damage">Damage/Issues</option></select></div>
            </div>
          </div>
        </div>
        <div class="wrap">
          <div class="tblhdr"><div class="tblttl">Photo Gallery</div></div>
          <div id="gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;padding:14px">
            <div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:26px">No photos yet. Use the camera or upload button.</div>
          </div>
        </div>
      </div>

      <!-- CALLS -->
      <div class="page" id="calls">
        <div class="wrap scroll">
          <div class="tblhdr"><div class="tblttl">Call History & Transcripts</div><button class="btn primary" onclick="simulateCall()">📞 Simulate Call</button></div>
          <table class="table"><thead>
            <tr><th>Date/Time</th><th>Phone Number</th><th>Customer</th><th>Duration</th><th>Lead Score</th><th>Status</th><th>Actions</th></tr>
          </thead><tbody id="callBody"></tbody></table>
        </div>
      </div>

      <!-- EMAILS -->
      <div class="page" id="emails">
        <div class="wrap scroll">
          <div class="tblhdr"><div class="tblttl">Email Campaign History</div><button class="btn primary" onclick="newCampaign()">✉️ New Campaign</button></div>
          <table class="table"><thead>
            <tr><th>Date</th><th>Recipient</th><th>Subject</th><th>Type</th><th>Status</th><th>Actions</th></tr>
          </thead><tbody id="emailBody"></tbody></table>
        </div>
        <div class="form">
          <div class="tblhdr" style="margin:-16px -16px 12px -16px"><div class="tblttl">Email Templates</div></div>
          <div class="fg"><label class="lbl">Template Type</label><select id="tType" class="sel"><option value="follow-up">Follow-up</option><option value="service">Service Reminder</option><option value="promotion">Promotion</option></select></div>
          <div class="fg"><label class="lbl">Subject</label><input class="in" id="tSubject"></div>
          <div class="fg"><label class="lbl">Body</label><textarea class="ta" id="tBody" rows="6"></textarea></div>
          <button class="btn primary" onclick="saveTemplate()">💾 Save Template</button>
        </div>
      </div>

      <!-- VIN -->
      <div class="page" id="vin">
        <div class="form">
          <div class="tblhdr" style="margin:-16px -16px 12px -16px"><div class="tblttl">VIN Intelligence Scanner</div><div style="font-size:11px;color:var(--text-muted)">Powered by NHTSA API</div></div>
          <div class="fg"><label class="lbl">Vehicle Identification Number</label><input class="in" id="vinIn" placeholder="Enter 17-character VIN" maxlength="17"></div>
          <button class="btn primary" onclick="scanVIN()" style="width:100%">🔍 Decode VIN</button>
          <div id="vinBox" style="display:none"><div style="margin-top:14px;background:linear-gradient(135deg,var(--bg-tertiary),var(--bg-quaternary));border:1px solid var(--accent-primary);border-radius:12px;padding:16px"><div id="vinData"></div></div></div>
        </div>
      </div>

      <!-- ANALYTICS -->
      <div class="page" id="analytics">
        <div class="grid">
          <div class="card"><div class="hdr"><div>Revenue Growth</div><div class="chip">+18.2%</div></div><div class="big">📈</div><div>YoY performance</div></div>
          <div class="card"><div class="hdr"><div>Service Revenue</div><div class="chip">+22%</div></div><div class="big">$47.5K</div><div>This month</div></div>
          <div class="card"><div class="hdr"><div>Customer Satisfaction</div><div class="chip">+2%</div></div><div class="big">96%</div><div>Excellent rating</div></div>
          <div class="card"><div class="hdr"><div>Market Share</div><div class="chip">+1.3%</div></div><div class="big">15.2%</div><div>Regional market</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== APP SCRIPT ===== -->
<script>
/* ---------------- STATE ---------------- */
let cameraStream=null, isListening=false, aiKey=null, opKey=null, recognition=null;
let customers=[]; window.customers=customers; // stable reference
let dashboard={revenue:{value:487000,change:.12,prev:435000}, leads:{value:0,change:1}, service:{value:8,change:2}, saleTime:{value:14}, calls:{value:12,change:3}};
let serviceOrders=[
  {id:'SO-001',vehicle:'2024 Honda Accord',customer:'John Smith',serviceType:'Oil Change',technician:'Mike Tech',status:'in-progress',cost:85,date:new Date()},
  {id:'SO-002',vehicle:'2024 BMW X5',customer:'Sarah Johnson',serviceType:'Reconditioning',technician:'Steve Expert',status:'pending',cost:1250,date:new Date()},
  {id:'SO-003',vehicle:'2024 Toyota Camry',customer:'Mike Wilson',serviceType:'30K Service',technician:'Tom Pro',status:'scheduled',cost:450,date:new Date()},
];
let inventory=[
  {id:101,vehicle:'2024 Toyota Camry',vin:'1HGBH41JXMN109186',status:'available',price:32000,days:15,service:'ready',make:'Toyota',model:'Camry',year:2024},
  {id:102,vehicle:'2024 Honda Accord',vin:'2HGBH41JXMN109187',status:'sold',price:35000,days:8,service:'completed',make:'Honda',model:'Accord',year:2024},
  {id:103,vehicle:'2024 Ford F-150',vin:'3HGBH41JXMN109188',status:'reserved',price:45000,days:21,service:'pending',make:'Ford',model:'F-150',year:2024},
];
let photos=[]; let calls=[
  {id:1,dt:new Date(Date.now()-2*60*60*1000),phone:'555-0123',customer:'John Smith',dur:'12:45',lead:9,status:'transcribed'},
  {id:2,dt:new Date(Date.now()-4*60*60*1000),phone:'555-0124',customer:'Sarah Johnson',dur:'8:32',lead:8,status:'transcribed'},
];
let emails=[
  {id:1,dt:new Date(),to:'john@email.com',sub:'Your BMW X5 Inquiry',type:'follow-up',status:'delivered'},
  {id:2,dt:new Date(),to:'sarah@email.com',sub:'Tesla Model Y Information',type:'follow-up',status:'opened'},
];

/* ---------------- INIT ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  updateTopBar();
  renderService(); renderCustomers(); renderInventory(); renderCalls(); renderEmails(); fillVehicleSelects();
  logActivity('System ready.');
  initVoice();
  if (window.db) await loadCustomersFromDB(); // auto-load from Supabase
});

/* ---------------- UTILS ---------------- */
const $ = sel => document.querySelector(sel);
const navSel = id => document.querySelector(`.sidebar .nav[onclick*="${id}"]`);
const money = v => '$'+Number(v||0).toLocaleString();
const leadChip = s => s>=8?'score-high':(s>=6?'score-medium':'score-low');
function logActivity(text){const feed=$('#activity'); if(!feed) return; const d=document.createElement('div'); d.style.padding='12px'; d.textContent=text; feed.prepend(d); while(feed.children.length>16) feed.removeChild(feed.lastChild);}
function toggleSidebar(){ $('#sidebar').classList.toggle('open'); }
function showPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
  document.querySelectorAll('.sidebar .nav').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  $('#pageTitle').textContent={
    dashboard:'Executive Dashboard', analytics:'Performance Analytics', customers:'Customer Pipeline', inventory:'Inventory Management', service:'Service Center Operations', photos:'Photo Manager', calls:'Call Center Management', emails:'Email Campaign Center', vin:'VIN Intelligence', chat:'AI Terminal'
  }[id]||'Dashboard';
  if (window.innerWidth<820) $('#sidebar').classList.remove('open');
  if(id==='photos') fillVehicleSelects();
}

/* ---------------- KPIs ---------------- */
function updateTopBar(){
  $('#kRevenue').textContent=money(dashboard.revenue.value);
  $('#kRevenueChg').textContent='+'+(dashboard.revenue.change*100)+'%';
  $('#kLeads').textContent=customers.length;
  $('#kLeadsChg').textContent='+'+dashboard.leads.change;
  $('#kCalls').textContent=calls.length;
  $('#kCallsChg').textContent='+'+dashboard.calls.change;
  $('#kService').textContent=serviceOrders.length;
  $('#kServiceChg').textContent='+'+dashboard.service.change;

  $('#dRev').textContent=money(dashboard.revenue.value);
  $('#dRevChg').textContent='+'+(dashboard.revenue.change*100)+'%';
  $('#dRevSub').textContent='vs '+money(dashboard.revenue.prev)+' last month';
  $('#dLeads').textContent=customers.length;
  const hot=customers.filter(c=>c.status==='hot').length, q=customers.filter(c=>c.status==='qualified').length, f=customers.filter(c=>c.status==='follow').length;
  $('#dLeadsSub').textContent=`${hot} hot • ${q} qualified • ${f} follow-up`;
  $('#dSvc').textContent=serviceOrders.length;
  const active=serviceOrders.filter(o=>o.status==='in-progress').length, pending=serviceOrders.filter(o=>o.status==='pending').length;
  $('#dSvcSub').textContent=`${active} active • ${pending} pending`;
  $('#dSaleTime').textContent=dashboard.saleTime.value;

  $('#bCustomers').textContent=customers.length;
  $('#bInventory').textContent=inventory.filter(v=>v.status==='available').length;
  $('#bService').textContent=serviceOrders.length;
  $('#bCalls').textContent=calls.length;
  $('#bEmails').textContent=emails.length;
  $('#bPhotos').textContent=photos.length;
}
function openMetric(which){
  const msgs={
    revenue:`Revenue: ${money(dashboard.revenue.value)}, up ${(dashboard.revenue.change*100)}% vs last month.`,
    leads:`Leads: ${customers.length} with average score ${(customers.reduce((s,c)=>s+(c.leadScore||7),0)/(customers.length||1)).toFixed(1)}/10.`,
    service:`Service orders: ${serviceOrders.length}, revenue ${money(serviceOrders.reduce((s,o)=>s+o.cost,0))}.`,
    saleTime:`Average sale time: ${dashboard.saleTime.value} days.`
  };
  chatAdd('ai', msgs[which]||'Analyzing…'); showPage('chat', navSel('chat'));
}

/* ---------------- CUSTOMERS ---------------- */
function renderCustomers(){
  const body=$('#custBody'); if(!body) return; body.innerHTML='';
  if(!customers.length){ body.innerHTML='<tr><td colspan="8" style="padding:12px;color:var(--text-muted)">No customers yet.</td></tr>'; return; }
  customers.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${c.firstName||''} ${c.lastName||''}</td>
      <td>${c.email||''}<br><span style="font-size:11px">${c.phone||''}</span></td>
      <td><span class="status-badge status-${c.status||'new'}">${c.status||'new'}</span></td>
      <td><span class="lead-score ${leadChip(c.leadScore||7)}">${c.leadScore||7}</span></td>
      <td>${money(c.value||0)}</td>
      <td>${c.vehicleInterest||''}<br><span style="font-size:11px">${c.budget||''}</span></td>
      <td>${c.lastContact||'—'}</td>
      <td><button class="btn sm primary" onclick="viewCustomer('${String(c.id)}')">View</button> <button class="btn sm" onclick="deleteCustomer('${String(c.id)}')">Delete</button></td>`;
    body.appendChild(tr);
  });
}
function filterCustomers(){
  const q=($('#custSearch')?.value||'').toLowerCase().trim();
  document.querySelectorAll('#custBody tr').forEach(r=>{
    const t=r.textContent.toLowerCase(); r.style.display=(!q || t.includes(q))?'':'none';
  });
}
function openCustomerForm(){ $('#custForm').style.display='block'; }
function closeCustomerForm(){ $('#custForm').style.display='none'; }
function viewCustomer(id){
  const c=customers.find(x=>String(x.id)===String(id)); if(!c){alert('Customer not found');return;}
  alert(`Customer Details:\n\nName: ${c.firstName||''} ${c.lastName||''}\nEmail: ${c.email||''}\nPhone: ${c.phone||''}\nInterest: ${c.vehicleInterest||''}\nBudget: ${c.budget||''}\nLead Score: ${c.leadScore||'-'}`);
}
async function deleteCustomer(id){
  // Try DB delete (id or "ID")
  if(window.db){
    try{ let {error}=await db.from('customers').delete().eq('id',id); if(error && /column "id"/i.test(error.message)){ ({error}=await db.from('customers').delete().eq('ID',id)); } }catch(_){}
  }
  customers = customers.filter(x=>String(x.id)!==String(id)); renderCustomers(); updateTopBar();
}

/* ---------------- INVENTORY ---------------- */
function renderInventory(){
  const body=$('#invBody'); if(!body) return; body.innerHTML='';
  inventory.forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${v.vehicle}</td><td style="font-family:monospace;font-size:11px">${v.vin}</td><td><span class="status-badge status-${v.status}">${v.status}</span></td><td>${money(v.price)}</td><td>${v.days}</td><td><span class="status-badge status-${v.service==='ready'?'qualified':v.service}">${v.service}</span></td><td><button class="btn sm primary" onclick="viewVehicle(${v.id})">View</button> <button class="btn sm" onclick="removeVehicle(${v.id})">Delete</button></td>`;
    body.appendChild(tr);
  });
}
function filterInventory(){
  const f=($('#invFilter')?.value||'').toLowerCase();
  document.querySelectorAll('#invBody tr').forEach(r=>{const t=r.textContent.toLowerCase(); r.style.display=t.includes(f)?'':'';});
}
function openVehicleForm(){ $('#vehForm').style.display='block'; }
function closeVehicleForm(){ $('#vehForm').style.display='none'; }
function addVehicle(){
  const vin=vVIN.value, make=vMake.value, model=vModel.value, year=vYear.value, price=vPrice.value, status=vStatus.value;
  if(make && model && year && price){
    const v={id:Date.now(),vehicle:`${year} ${make} ${model}`,vin:vin||'PENDING',status,price:parseInt(price),days:0,service:'pending',make,model,year:parseInt(year)};
    inventory.push(v); renderInventory(); updateTopBar(); closeVehicleForm(); logActivity(`🚗 New vehicle: ${v.vehicle}`);
    vVIN.value=vMake.value=vModel.value=vYear.value=vPrice.value='';
  }
}
async function decodeVIN(){
  const vin=vVIN.value; if(vin.length!==17){alert('Please enter a valid 17-character VIN');return;}
  try{ const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const g=v=>d.Results.find(x=>x.Variable===v)?.Value||''; vMake.value=g('Make'); vModel.value=g('Model'); vYear.value=g('Model Year'); alert('VIN decoded successfully!'); }catch(e){ alert('Error decoding VIN. Please enter details manually.'); }
}
function viewVehicle(id){const v=inventory.find(x=>x.id===id); if(v) alert(`${v.vehicle}\nVIN: ${v.vin}\nPrice: ${money(v.price)}\nStatus: ${v.status}\nDays: ${v.days}\nService: ${v.service}`)}
function removeVehicle(id){ if(confirm('Delete this vehicle?')){ inventory=inventory.filter(v=>v.id!==id); renderInventory(); updateTopBar(); } }
function fillVehicleSelects(){
  const sel=$('#photoVeh'), svc=$('#svcVehicle'); if(sel){ sel.innerHTML='<option value="">Choose vehicle…</option>'; inventory.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.vehicle; sel.appendChild(o); });}
  if(svc){ svc.innerHTML='<option value="">Select vehicle…</option>'; inventory.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.vehicle; svc.appendChild(o); });}
}

/* ---------------- PHOTOS ---------------- */
async function startCamera(){ try{ cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); const v=$('#cam'); v.srcObject=cameraStream; v.style.display='block'; $('#capBtn').disabled=false; logActivity('📷 Camera started'); }catch(e){ alert('Camera access denied.'); } }
function stopCamera(){ if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; $('#cam').style.display='none'; $('#capBtn').disabled=true; logActivity('📷 Camera stopped'); } }
function capturePhoto(){
  const video=$('#cam'), canvas=$('#canvas'), vehicleId=$('#photoVeh').value, type=$('#photoType').value; if(!vehicleId){alert('Select a vehicle first');return;}
  canvas.width=video.videoWidth; canvas.height=video.videoHeight; const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0); const data=canvas.toDataURL('image/jpeg');
  const vehicle=inventory.find(v=>String(v.id)===String(vehicleId)); const p={id:Date.now(),vehicleId,vehicleName:vehicle?.vehicle||'Unknown',type,data,ts:new Date()}; photos.push(p); showPhotos(); updateTopBar(); logActivity(`📸 Photo captured: ${p.vehicleName}`);
}
function uploadPhoto(e){
  const file=e.target.files[0]; const vehicleId=$('#photoVeh').value; const type=$('#photoType').value; if(!vehicleId){alert('Select a vehicle first'); return;}
  if(file){ const r=new FileReader(); r.onload=x=>{ const vehicle=inventory.find(v=>String(v.id)===String(vehicleId)); const p={id:Date.now(),vehicleId,vehicleName:vehicle?.vehicle||'Unknown',type,data:x.target.result,ts:new Date()}; photos.push(p); showPhotos(); updateTopBar(); logActivity(`📸 Photo uploaded: ${p.vehicleName}`); }; r.readAsDataURL(file); }
}
function showPhotos(){
  const g=$('#gallery'); if(!g) return;
  if(!photos.length){ g.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:26px">No photos yet. Use the camera or upload button.</div>'; return; }
  g.innerHTML=''; photos.forEach(p=>{ const d=document.createElement('div'); d.style.position='relative'; d.style.border='2px solid var(--glass-border)'; d.style.borderRadius='12px'; d.style.overflow='hidden';
    d.innerHTML=`<img src="${p.data}" alt="${p.type}" style="width:100%;height:100%;object-fit:cover"><div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.8));padding:8px;color:#fff;font-size:10px">${p.vehicleName} — ${p.type}</div><button onclick="delPhoto(${p.id})" style="position:absolute;top:4px;right:4px;background:var(--error);color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer">×</button>`;
    g.appendChild(d);
  });
}
function delPhoto(id){ if(confirm('Delete this photo?')){ photos=photos.filter(p=>p.id!==id); showPhotos(); updateTopBar(); } }

/* ---------------- SERVICE ---------------- */
function renderService(){ const body=$('#serviceBody'); if(!body) return; body.innerHTML=''; serviceOrders.forEach(o=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${o.id}</td><td>${o.vehicle}</td><td>${o.customer}</td><td>${o.serviceType}</td><td>${o.technician}</td><td><span class="status-badge status-${o.status}">${o.status}</span></td><td>${money(o.cost)}</td><td><button class="btn sm primary" onclick="viewOrder('${o.id}')">View</button> <button class="btn sm" onclick="cycleStatus('${o.id}')">Update</button></td>`; body.appendChild(tr); });}
function createServiceOrder(){ $('#serviceForm').style.display='block'; fillVehicleSelects(); }
function closeServiceForm(){ $('#serviceForm').style.display='none'; }
function submitServiceOrder(){
  const vehicle=$('#svcVehicle').value, type=$('#svcType').value, priority=$('#svcPriority').value;
  if(vehicle && type){ const v=inventory.find(x=>String(x.id)===String(vehicle))?.vehicle||'Unknown';
    const o={id:`SO-${String(serviceOrders.length+1).padStart(3,'0')}`,vehicle:v,customer:'Walk-in',serviceType:type,technician:'Unassigned',status:priority==='urgent'?'in-progress':'pending',cost:Math.floor(Math.random()*500)+100,date:new Date()};
    serviceOrders.push(o); renderService(); closeServiceForm(); logActivity(`🔧 Service order created: ${o.id}`); updateTopBar();
  }
}
function viewOrder(id){ const o=serviceOrders.find(x=>x.id===id); if(o) alert(`Service Order ${o.id}\n\nVehicle: ${o.vehicle}\nCustomer: ${o.customer}\nService: ${o.serviceType}\nStatus: ${o.status}\nCost: ${money(o.cost)}`); }
function cycleStatus(id){ const o=serviceOrders.find(x=>x.id===id); if(o){ const s=['pending','in-progress','completed']; o.status=s[(s.indexOf(o.status)+1)%s.length]; renderService(); logActivity(`🔧 ${id} → ${o.status}`); } }

/* ---------------- CALLS & EMAILS ---------------- */
function renderCalls(){ const body=$('#callBody'); if(!body) return; body.innerHTML=''; calls.forEach(c=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.dt.toLocaleDateString()}<br><span style="font-size:11px">${c.dt.toLocaleTimeString()}</span></td><td>${c.phone}</td><td>${c.customer}</td><td>${c.dur}</td><td><span class="lead-score ${leadChip(c.lead)}">${c.lead}</span></td><td><span class="status-badge status-${c.status}">${c.status}</span></td><td><button class="btn sm primary" onclick="viewTranscript(${c.id})">Transcript</button> <button class="btn sm" onclick="delCall(${c.id})">Delete</button></td>`; body.appendChild(tr); });}
function simulateCall(){ const c={id:Date.now(),dt:new Date(),phone:'555-'+Math.floor(Math.random()*9000+1000),customer:'New Customer',dur:Math.floor(Math.random()*15)+':'+String(Math.floor(Math.random()*60)).padStart(2,'0'),lead:Math.floor(Math.random()*4)+6,status:'transcribed'}; calls.unshift(c); renderCalls(); updateTopBar(); logActivity('📞 New call received'); alert('New call simulated!'); }
function viewTranscript(id){ const c=calls.find(x=>x.id===id); if(c) alert(`Call Transcript\n\nCustomer: ${c.customer}\nPhone: ${c.phone}\nDuration: ${c.dur}\nLead Score: ${c.lead}/10\n\n[Transcript here]`); }
function delCall(id){ if(confirm('Delete this call?')){ calls=calls.filter(c=>c.id!==id); renderCalls(); updateTopBar(); } }

function renderEmails(){ const body=$('#emailBody'); if(!body) return; body.innerHTML=''; emails.forEach(e=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.dt.toLocaleDateString()}<br><span style="font-size:11px">${e.dt.toLocaleTimeString()}</span></td><td>${e.to}</td><td>${e.sub}</td><td><span class="status-badge status-${e.type}">${e.type}</span></td><td><span class="status-badge status-${e.status}">${e.status}</span></td><td><button class="btn sm primary" onclick="viewEmail(${e.id})">View</button> <button class="btn sm" onclick="delEmail(${e.id})">Delete</button></td>`; body.appendChild(tr); });}
function newCampaign(){
  const subject=prompt('Email subject:'); if(subject){ const e={id:Date.now(),dt:new Date(),to:'all@customers.com',sub:subject,type:'campaign',status:'sent'}; emails.unshift(e); renderEmails(); updateTopBar(); logActivity('📧 Email campaign sent'); alert('Email campaign created!'); }
}
function saveTemplate(){ if(tSubject.value && tBody.value){ alert('Template saved.'); logActivity('💾 Email template saved'); } }
function viewEmail(id){ const e=emails.find(x=>x.id===id); if(e) alert(`Email Details\n\nTo: ${e.to}\nSubject: ${e.sub}\nType: ${e.type}\nStatus: ${e.status}`); }
function delEmail(id){ if(confirm('Delete this email?')){ emails=emails.filter(e=>e.id!==id); renderEmails(); updateTopBar(); } }

/* ---------------- VIN ---------------- */
async function scanVIN(){
  const vin=vinIn.value; if(vin.length!==17){alert('Please enter a valid 17-character VIN');return;}
  const wrap=$('#vinBox'), box=$('#vinData'); box.innerHTML='<div style="text-align:center">🔍 Decoding VIN…</div>'; wrap.style.display='block';
  try{ const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`); const d=await r.json(); const g=v=>d.Results.find(x=>x.Variable===v)?.Value||'N/A';
    box.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px">
      <div><div class="lbl" style="margin:0;color:var(--text-muted)">Make</div><div>${g('Make')}</div></div>
      <div><div class="lbl" style="margin:0;color:var(--text-muted)">Model</div><div>${g('Model')}</div></div>
      <div><div class="lbl" style="margin:0;color:var(--text-muted)">Year</div><div>${g('Model Year')}</div></div>
      <div><div class="lbl" style="margin:0;color:var(--text-muted)">Body</div><div>${g('Body Class')}</div></div>
      <div><div class="lbl" style="margin:0;color:var(--text-muted)">Engine</div><div>${g('Engine Model')}</div></div>
      <div><div class="lbl" style="margin:0;color:var(--text-muted)">Manufacturer</div><div>${g('Manufacturer Name')}</div></div>
    </div>`; logActivity('🔍 VIN decoded successfully');
  }catch{ box.innerHTML='<div style="color:var(--error);text-align:center">Error decoding VIN</div>'; }
}

/* ---------------- CHAT / VOICE ---------------- */
function chatAdd(type,html){ const box=$('#msgs'); const d=document.createElement('div'); d.className=`msg ${type==='user'?'user':'ai'}`; d.innerHTML=html; box.appendChild(d); box.scrollTop=box.scrollHeight; }
async function sendMessage(){
  const i=$('#chatIn'); const q=i.value.trim(); if(!q) return; chatAdd('user',q); i.value='';
  // If no key, just do local helper intents:
  if(!aiKey){ chatAdd('ai','(Tip) Enter your OpenAI API key above to enable full AI. I can still run quick commands like <code>show customers</code>, <code>search customers for Dennis</code>.'); tryLocalIntent(q); return; }
  try{
    // Ask GPT to return a tiny JSON intent (safe + easy to parse)
    const sys = `You are TVC Auto AI. Always reply ONLY with JSON on one line: {"action":"...","query":"..."} where action is one of "open_page","search_customers","search_inventory","add_customer","help". Do not add markdown.`;
    const r = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+aiKey },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages:[{role:"system",content:sys},{role:"user",content:q}],
        temperature:0.2
      })
    });
    if(!r.ok){ const t=await r.text(); throw new Error(t||('HTTP '+r.status)); }
    const j=await r.json();
    const raw=(j.choices?.[0]?.message?.content||"{}").trim();
    let intent; try{ intent=JSON.parse(raw); }catch{ intent={action:"help"}; }
    applyIntent(intent,q,true);
  }catch(e){
    console.warn('AI error:',e); chatAdd('ai','❌ AI request failed. Check API key and internet.');
  }
}
function tryLocalIntent(q){ applyIntent(parseIntent(q), q, false); }
function parseIntent(t){
  const s=t.toLowerCase().trim();
  if (/(show|open|go to)\s+customers?/.test(s)) return {action:'open_page',page:'customers'};
  if (/(show|open|go to)\s+inventory|vehicles?/.test(s)) return {action:'open_page',page:'inventory'};
  if (/(show|open|go to)\s+service/.test(s)) return {action:'open_page',page:'service'};
  if (/(show|open|go to)\s+(chat|terminal|ai)/.test(s)) return {action:'open_page',page:'chat'};
  if (/(show|open|go to)\s+dashboard/.test(s)) return {action:'open_page',page:'dashboard'};
  let m = s.match(/^(search|find)\s+(customers?|customer)\s+(for\s+)?(.+)/); if(m&&m[4]) return {action:'search_customers',query:m[4]};
  m = s.match(/^(search|find)\s+inventory\s+(for\s+)?(.+)/); if(m&&m[3]) return {action:'search_inventory',query:m[3]};
  if (/^(add|new)\s+customer/.test(s)) return {action:'add_customer'};
  return {action:'help'};
}
function applyIntent(intent,raw,isAI){
  switch(intent.action){
    case 'open_page':
      showPage(intent.page||'dashboard', navSel(intent.page||'dashboard')); chatAdd('ai',`Opened <b>${(intent.page||'dashboard')}</b>.`); break;
    case 'search_customers':
      showPage('customers', navSel('customers')); $('#custSearch').value=intent.query||''; filterCustomers();
      const vis=[...document.querySelectorAll('#custBody tr')].filter(r=>r.style.display!=='none').length;
      chatAdd('ai',`🔎 Customer search for "<b>${intent.query||''}</b>": ${vis} result(s).`); break;
    case 'search_inventory':
      showPage('inventory', navSel('inventory')); $('#invFilter').value=intent.query||''; filterInventory();
      const v=[...document.querySelectorAll('#invBody tr')].filter(r=>r.style.display!=='none').length;
      chatAdd('ai',`🔎 Inventory search for "<b>${intent.query||''}</b>": ${v} result(s).`); break;
    case 'add_customer':
      showPage('customers', navSel('customers')); openCustomerForm(); chatAdd('ai','📝 Add Customer form opened.'); break;
    default:
      chatAdd('ai','Try: “show customers”, “search customers for Dennis”, “open inventory”, “search inventory for Camry”, or “add customer”.');
  }
}

/* Voice (Web Speech API) */
function initVoice(){
  const SR=window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ console.warn('Web Speech API not available'); return; }
  recognition=new SR(); recognition.lang='en-US'; recognition.interimResults=true; recognition.continuous=true;
  recognition.onresult=(ev)=>{ let final=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ const t=ev.results[i][0].transcript; if(ev.results[i].isFinal) final+=t; }
    if(final.trim()){ chatAdd('user','🎙️ '+final.trim()); tryLocalIntent(final.trim()); }
  };
  recognition.onerror=e=>{ console.warn('Voice error:',e.error); if(e.error==='not-allowed'){ alert('Please allow microphone access.'); stopVoice(); } };
  recognition.onend=()=>{ if(isListening){ try{recognition.start();}catch{} } else updateVoiceBtn(); };
}
function startVoice(){ if(!recognition){ alert('Voice demo: enable in Chrome/Edge.'); return; } try{ recognition.start(); isListening=true; updateVoiceBtn(); logActivity('🎙️ Voice listening started'); }catch(e){} }
function stopVoice(){ if(recognition){ try{ recognition.stop(); }catch{} } isListening=false; updateVoiceBtn(); logActivity('🎙️ Voice stopped'); }
function toggleVoice(){ isListening?stopVoice():startVoice(); }
function updateVoiceBtn(){ const b=$('#voiceBtn'); if(!b) return; b.textContent=isListening?'🎙️ Listening… (tap to stop)':'🎤 Voice'; }

/* ---------------- EXPORT / REFRESH ---------------- */
function exportData(){ alert(`Export\n\nCustomers: ${customers.length}\nInventory: ${inventory.length}\nService Orders: ${serviceOrders.length}\nRevenue: ${money(dashboard.revenue.value)}`); logActivity('📊 Data exported'); }
async function refreshAll(){ if(window.db) await loadCustomersFromDB(); updateTopBar(); renderService(); renderCustomers(); renderInventory(); renderCalls(); renderEmails(); fillVehicleSelects(); logActivity('🔄 Data refreshed'); alert('All data refreshed.'); }

/* ---------------- AI CONFIG ---------------- */
function testAI(){ alert('If your key is valid, I will respond to the next prompt.'); chatAdd('ai','✅ AI ready. Type a question.'); }
function updateAIStatus(){ const k=$('#aiKey').value; const dot=$('#aiDot'), txt=$('#aiText'); if(k && k.length>10){ aiKey=k; dot.style.background='var(--success)'; txt.textContent='AI Status: Connected'; } else { aiKey=null; dot.style.background='var(--error)'; txt.textContent='AI Status: API Key Required'; } }
function updateOpenPhoneStatus(){ const k=$('#opKey').value; opKey=k; alert(k && k.length>10?'OpenPhone ready':'Enter OpenPhone key'); }
function testOpenPhone(){ if(!opKey){ alert('Enter OpenPhone API key first'); return;} chatAdd('ai','✅ OpenPhone API connected (demo)'); }
function saveAI(){ updateAIStatus(); updateOpenPhoneStatus(); alert('Configuration saved'); logActivity('🔧 AI configuration saved'); }

/* ---------------- SUPABASE ---------------- */
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // TODO: REPLACE with your own project values from Supabase → Project Settings → API
  const SUPABASE_URL = "https://YOUR-PROJECT-REF.supabase.co";       // <— replace
  const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";                          // <— replace

  const db = (()=>{ try{ return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }catch(e){ console.warn('Supabase init failed:', e?.message||e); return null; }})();
  window.db = db;

  function mapRowToCustomer(row){
    const full=(row["Name"] ?? row.name ?? "").toString().trim(); const [first,...rest]=full.split(/\s+/); const last=rest.join(' ');
    const budgetStr=String(row["Budget"] ?? row.budget ?? ""); const numeric=parseInt(budgetStr.replace(/[^0-9]/g,""))||0;
    return {
      id: row.id ?? row.ID ?? row.uuid ?? row["ID"] ?? Date.now(),
      firstName:first||"", lastName:last||"",
      email: row["Email"] ?? row.email ?? "", phone: row["Phone"] ?? row.phone ?? "",
      vehicleInterest: row["Vehicle of interest"] ?? row.vehicle_interest ?? "", budget: row["Budget"] ?? row.budget ?? "",
      address: row["Address"] ?? row.address ?? "", currentVehicle: row["Current Vehicle/Trade in"] ?? row.current_vehicle ?? "",
      status:"new", leadScore:8, value:numeric, lastContact:"—"
    };
  }

  async function loadCustomersFromDB(){
    if(!db) return;
    try{
      let { data, error } = await db.from("customers").select("*").order("created_at",{ascending:false});
      if(error){ ({data,error} = await db.from("customers").select("*")); }
      if(error) throw error;
      customers.length = 0; (data||[]).forEach(r => customers.push(mapRowToCustomer(r)));
      renderCustomers(); updateTopBar();
      console.info("Supabase → customers:", customers.length);
    }catch(e){
      console.error("loadCustomersFromDB failed:", e); alert("Could not load customers (check RLS or console).");
    }
  }

  async function addCustomer(){
    const name=($('#cName')?.value||'').trim(), address=($('#cAddress')?.value||'').trim(), email=($('#cEmail')?.value||'').trim(), phone=($('#cPhone')?.value||'').trim();
    const voi=($('#cVoI')?.value||'').trim(), current=($('#cCurrent')?.value||'').trim(), budget=($('#cBudget')?.value||'').trim();
    if(!name){ alert("Please enter a name"); return; }
    try{
      const { error } = await db.from("customers").insert([{ ["Name"]:name, ["Address"]:address, ["Email"]:email, ["Phone"]:phone, ["Vehicle of interest"]:voi, ["Current Vehicle/Trade in"]:current, ["Budget"]:budget }]);
      if(error) throw error;
      await loadCustomersFromDB();
      ['cName','cAddress','cEmail','cPhone','cVoI','cCurrent','cBudget'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      $('#cStatus').value='new'; closeCustomerForm(); logActivity(`👤 New customer: ${name}`);
    }catch(e){
      const msg=/row level|rls/i.test(String(e.message))?"RLS policy is blocking INSERT. Add an anon INSERT policy.":(e.message||e);
      console.error('Insert failed:',e); alert('Could not save to Supabase: '+msg);
    }
  }
</script>
</body>
</html>
